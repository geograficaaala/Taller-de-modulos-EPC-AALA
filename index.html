<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Taller de Módulos · EPC AALA</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink: rgba(10, 18, 35, .92);
      --muted: rgba(10, 18, 35, .66);

      --glass: rgba(255,255,255,.70);
      --glass2: rgba(255,255,255,.55);
      --stroke: rgba(10, 18, 35, .10);

      --shadow: 0 18px 45px rgba(10,18,35,.14);
      --shadow-soft: 0 10px 22px rgba(10,18,35,.10);

      --radius: 24px;

      --skyA: rgba(160, 220, 255, .85);
      --skyB: rgba(185, 235, 255, .78);
      --skyC: rgba(210, 245, 255, .70);
      --lavA: rgba(210, 220, 255, .55);
      --lavB: rgba(180, 190, 255, .45);

      --okBg: rgba(32, 185, 129, .14);
      --okBd: rgba(32, 185, 129, .30);

      --todoBg: rgba(250, 200, 80, .18);
      --todoBd: rgba(250, 200, 80, .34);

      --focus: rgba(79,156,255,.35);

      --font-title: 'Outfit', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font-body: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: var(--font-body);
      color: var(--ink);
      background:
        radial-gradient(1200px 900px at 20% 10%, var(--skyA), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, var(--lavA), transparent 55%),
        radial-gradient(900px 700px at 60% 85%, var(--skyC), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,252,255,.92));
      overflow: hidden; /* 1 pantalla */
    }

    .bgBlobs{
      position: fixed;
      inset: -40px;
      pointer-events: none;
      opacity: .55;
      filter: blur(40px);
      background:
        radial-gradient(420px 380px at 15% 20%, rgba(120, 210, 255, .60), transparent 60%),
        radial-gradient(520px 420px at 80% 25%, rgba(190, 180, 255, .55), transparent 60%),
        radial-gradient(520px 420px at 55% 90%, rgba(190, 245, 255, .55), transparent 60%);
    }

    .app{
      height: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 10px;
      padding: max(14px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
               max(14px, env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left));
      max-width: 1100px;
      margin: 0 auto;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
    }

    .brand h1{
      margin: 0;
      font-family: var(--font-title);
      font-weight: 800;
      letter-spacing: -.02em;
      font-size: 18px;
      line-height: 1.15;
    }
    .brand .hint{
      margin-top: 6px;
      font-size: 12.8px;
      color: var(--muted);
    }

    .topRight{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      font-size: 12.5px;
      color: rgba(10,18,35,.80);
      box-shadow: var(--shadow-soft);
      user-select:none;
      white-space: nowrap;
    }

    .bar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }

    .searchWrap{
      flex: 1 1 260px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(10px);
    }
    .searchWrap input{
      width:100%;
      border: 0;
      outline: none;
      background: transparent;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--ink);
    }
    .iconBtn{
      border: 1px solid rgba(10,18,35,.10);
      background: rgba(10,18,35,.06);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      color: rgba(10,18,35,.80);
      user-select:none;
    }
    .iconBtn:hover{ background: rgba(10,18,35,.09); }
    .iconBtn:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }

    .chipRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      color: rgba(10,18,35,.80);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12.5px;
      cursor:pointer;
      box-shadow: var(--shadow-soft);
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.70); }
    .chip.active{
      background: rgba(79,156,255,.18);
      border-color: rgba(79,156,255,.35);
      color: rgba(10,18,35,.92);
    }
    .chip:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }

    .stage{
      position: relative;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.48));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow: hidden;
      min-height: 0;
    }

    .viewHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 16px 10px;
    }

    .viewTitle{
      font-family: var(--font-title);
      font-weight: 800;
      letter-spacing: -.02em;
      font-size: 16px;
      margin: 0;
      line-height: 1.2;
    }

    .subTitleLine{
      color: var(--muted);
      font-size: 12.8px;
      margin-top: 4px;
    }

    .btn{
      border: 1px solid rgba(10,18,35,.10);
      background: rgba(255,255,255,.60);
      color: rgba(10,18,35,.85);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
      font-family: var(--font-title);
      box-shadow: var(--shadow-soft);
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.75); }
    .btn:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }
    .btn.primary{
      background: rgba(79,156,255,.18);
      border-color: rgba(79,156,255,.32);
    }
    .btn.ghost{
      background: rgba(10,18,35,.05);
    }
    .btn[disabled]{
      opacity: .6;
      cursor: not-allowed;
    }

    .trackWrap{
      position: relative;
      height: calc(100% - 64px);
      padding: 0 10px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .track{
      flex: 1 1 auto;
      display:flex;
      gap: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding: 10px 6px;
      align-items: stretch;
    }
    .track::-webkit-scrollbar{ height: 8px; }
    .track::-webkit-scrollbar-thumb{ background: rgba(10,18,35,.16); border-radius: 999px; }

    .cardBig{
      flex: 0 0 min(92%, 520px);
      scroll-snap-align: center;
      border-radius: 22px;
      border: 1px solid rgba(10,18,35,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.52));
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 14px 14px;
      transform: scale(.92);
      opacity: .78;
      filter: saturate(.92);
      transition: transform .22s ease, opacity .22s ease, filter .22s ease;
      position: relative;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-width: 260px;
    }
    .cardBig.active{
      transform: scale(1);
      opacity: 1;
      filter: none;
      box-shadow: 0 18px 45px rgba(10,18,35,.16);
    }

    .cardBig h3{
      margin: 0;
      font-family: var(--font-title);
      font-weight: 800;
      letter-spacing: -.02em;
      font-size: 17px;
      line-height: 1.15;
    }
    .cardBig p{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }

    .tag{
      display:inline-flex;
      gap: 6px;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(10,18,35,.10);
      background: rgba(255,255,255,.55);
      color: rgba(10,18,35,.80);
      user-select:none;
    }
    .tag.ok{ background: var(--okBg); border-color: var(--okBd); }
    .tag.todo{ background: var(--todoBg); border-color: var(--todoBd); }

    .previewList{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding-top: 4px;
    }
    .previewItem{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(10,18,35,.08);
      background: rgba(255,255,255,.55);
    }
    .previewItem .t{
      font-weight: 700;
      font-size: 13px;
      line-height: 1.25;
      color: rgba(10,18,35,.88);
    }
    .previewItem .d{
      margin-top: 4px;
      font-size: 12.6px;
      color: rgba(10,18,35,.66);
      line-height: 1.25;
    }

    .readBadge{
      position:absolute;
      top: 12px;
      right: 12px;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(32, 185, 129, .14);
      border: 1px solid rgba(32, 185, 129, .30);
      color: rgba(10,18,35,.80);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
      display:none;
      user-select:none;
    }
    .cardBig.read .readBadge{ display:block; }

    .navBtn{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 4;
      border: 1px solid rgba(10,18,35,.10);
      background: rgba(255,255,255,.65);
      box-shadow: var(--shadow-soft);
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      color: rgba(10,18,35,.85);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .navBtn:hover{ background: rgba(255,255,255,.80); }
    .navBtn:focus-visible{ outline: 3px solid var(--focus); outline-offset: 2px; }
    .navBtn.prev{ left: 8px; }
    .navBtn.next{ right: 8px; }

    .dots{
      display:flex;
      justify-content:center;
      gap: 8px;
      padding-bottom: 8px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(10,18,35,.22);
      background: rgba(10,18,35,.10);
      cursor:pointer;
    }
    .dot.active{
      background: rgba(79,156,255,.48);
      border-color: rgba(79,156,255,.60);
    }

    footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.50);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      font-size: 12.5px;
      color: rgba(10,18,35,.72);
    }
    .footerLeft{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      padding: 3px 6px;
      border-radius: 8px;
      border: 1px solid rgba(10,18,35,.10);
      background: rgba(255,255,255,.55);
      color: rgba(10,18,35,.78);
    }

    @media (max-width: 520px){
      header{ padding: 12px 12px; }
      .brand h1{ font-size: 17px; }
      .pill{ display:none; }
      .cardBig{ flex-basis: 92%; }
      .navBtn{ display:none; } /* swipe primero, flechas opcional */
    }

    @media (prefers-reduced-motion: reduce){
      .cardBig{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="bgBlobs"></div>

  <div class="app">
    <header>
      <div class="brand">
        <h1>Taller por módulos · EPC 5º Primaria</h1>
        <div class="hint" id="modeHint">Desliza a izquierda/derecha para cambiar de módulo.</div>
      </div>
      <div class="topRight">
        <div class="pill" id="counterPill">—</div>
      </div>
    </header>

    <div class="bar">
      <div class="searchWrap" role="search">
        <input id="searchInput" type="search" placeholder="Buscar módulos o subtemas…" aria-label="Buscar" />
        <button id="clearSearch" class="iconBtn" type="button" aria-label="Borrar búsqueda">✕</button>
      </div>

      <div class="chipRow" aria-label="Filtros">
        <button class="chip active" type="button" data-filter="all">Todos</button>
        <button class="chip" type="button" data-filter="available">Disponibles</button>
        <button class="chip" type="button" data-filter="coming">Próximamente</button>
        <button class="chip" type="button" data-filter="read">Leídos</button>
      </div>
    </div>

    <section class="stage" aria-live="polite">
      <div class="viewHeader">
        <div>
          <div class="viewTitle" id="viewTitle">Módulos</div>
          <div class="subTitleLine" id="subTitleLine">Selecciona un módulo para ver sus subtemas.</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="backBtn" class="btn ghost" type="button" style="display:none;">← Volver</button>
          <button id="continueBtn" class="btn primary" type="button" style="display:none;">Continuar</button>
        </div>
      </div>

      <div class="trackWrap">
        <button class="navBtn prev" id="prevBtn" type="button" aria-label="Anterior">◀</button>
        <button class="navBtn next" id="nextBtn" type="button" aria-label="Siguiente">▶</button>

        <div class="track" id="track" tabindex="0" aria-label="Carrusel"></div>
        <div class="dots" id="dots" aria-label="Indicador"></div>
      </div>
    </section>

    <footer>
      <div class="footerLeft">
        <span><span class="kbd">←</span> <span class="kbd">→</span> o swipe</span>
        <span><span class="kbd">Enter</span> para entrar</span>
      </div>
      <div id="statusLine">Listo.</div>
    </footer>
  </div>

  <script>
    const DATA = [{"title": "Módulo 1 · Medio ambiente", "subs": [{"title": "1.1 Elementos que conforman el ambiente", "desc": "Elementos bióticos y abióticos e interdependencia.", "href": "1-1.html", "data_file": "1-1.html", "status": "Disponible", "disabled": false}, {"title": "1.2 Cadenas alimenticias o tróficas", "desc": "Niveles tróficos y flujo de energía (terrestre y acuático).", "href": "1-2.html", "data_file": "1-2.html", "status": "Disponible", "disabled": false}, {"title": "1.3 El ecosistema y su organización", "desc": "Organización biológica y relaciones ecosistémicas.", "href": "1-3.html", "data_file": "1-3.html", "status": "Próximamente", "disabled": false}, {"title": "1.4 Ecosistemas en Sololá y cuenca del Lago de Atitlán", "desc": "Ecosistemas locales y su relevancia ambiental.", "href": "1-4.html", "data_file": "1-4.html", "status": "Próximamente", "disabled": false}, {"title": "1.5 Recursos naturales", "desc": "Clasificación y uso sostenible.", "href": "1-5.html", "data_file": "1-5.html", "status": "Próximamente", "disabled": false}, {"title": "1.6 Biodiversidad", "desc": "Variedad de vida y por qué importa.", "href": "1-6.html", "data_file": "1-6.html", "status": "Próximamente", "disabled": false}, {"title": "1.7 Deterioro ambiental", "desc": "Causas y consecuencias del deterioro.", "href": "1-7.html", "data_file": "1-7.html", "status": "Próximamente", "disabled": false}, {"title": "1.8 Cambio climático", "desc": "Conceptos básicos e impactos.", "href": "1-8.html", "data_file": "1-8.html", "status": "Próximamente", "disabled": false}, {"title": "1.9 Huella ecológica", "desc": "Consumo y presión sobre recursos.", "href": "1-9.html", "data_file": "1-9.html", "status": "Próximamente", "disabled": false}, {"title": "1.10 Estrategias para contrarrestar problemas ambientales", "desc": "Acciones y buenas prácticas.", "href": "1-10.html", "data_file": "1-10.html", "status": "Próximamente", "disabled": false}]}, {"title": "Módulo 2 · El bosque", "subs": [{"title": "2.1 Diferencia entre bosque, plantación forestal y reforestación", "desc": "Conceptos y ejemplos para no confundirlos.", "href": "2-1.html", "data_file": "2-1.html", "status": "Próximamente", "disabled": false}, {"title": "2.2 Bienes y servicios ambientales del bosque", "desc": "Provisión, regulación, soporte y culturales.", "href": "2-2.html", "data_file": "2-2.html", "status": "Próximamente", "disabled": false}, {"title": "2.3 Funciones del bosque", "desc": "Protección, regulación y producción (entre otras).", "href": "2-3.html", "data_file": "2-3.html", "status": "Próximamente", "disabled": false}, {"title": "2.4 Estructura de un bosque", "desc": "Estratos, especies y dinámica del bosque.", "href": "2-4.html", "data_file": "2-4.html", "status": "Próximamente", "disabled": false}, {"title": "2.5 Tipos de bosques en el departamento de Sololá", "desc": "Latifoliado, coníferas, mixto y estacionalmente seco.", "href": "2-5.html", "data_file": "2-5.html", "status": "Próximamente", "disabled": false}, {"title": "2.6 Manejo forestal", "desc": "Uso sostenible, regeneración y silvicultura.", "href": "2-6.html", "data_file": "2-6.html", "status": "Próximamente", "disabled": false}, {"title": "2.7 Amenazas a los bosques", "desc": "Incendios, tala ilegal, plagas y cambio climático.", "href": "2-7.html", "data_file": "2-7.html", "status": "Próximamente", "disabled": false}]}, {"title": "Módulo 3 · El agua y las cuencas hidrográficas", "subs": [{"title": "3.1 El ciclo del agua", "desc": "Cómo el agua cambia de estado y se mueve en la naturaleza (ciclo hidrológico).", "href": "3-1.html", "data_file": "3-1.html", "status": "Próximamente", "disabled": false}, {"title": "3.2 Fuentes de agua", "desc": "Ríos, lagos, aguas subterráneas y otras fuentes.", "href": "3-2.html", "data_file": "3-2.html", "status": "Próximamente", "disabled": false}, {"title": "3.3 Cuencas hidrográficas y manejo integrado de cuencas", "desc": "Qué es una cuenca y por qué todo está conectado.", "href": "3-3.html", "data_file": "3-3.html", "status": "Próximamente", "disabled": false}, {"title": "3.4 Manejo integrado de cuencas", "desc": "Acciones coordinadas para cuidar agua, suelo y bosque.", "href": "3-4.html", "data_file": "3-4.html", "status": "Próximamente", "disabled": false}, {"title": "3.5 Cuencas hidrográficas en el departamento de Sololá", "desc": "Principales cuencas que intervienen en Sololá y su importancia.", "href": "3-5.html", "data_file": "3-5.html", "status": "Próximamente", "disabled": false}, {"title": "3.6 Vida acuática", "desc": "Biodiversidad en ríos, lagos y humedales.", "href": "3-6.html", "data_file": "3-6.html", "status": "Próximamente", "disabled": false}, {"title": "3.7 Calidad del agua del Lago de Atitlán", "desc": "Indicadores básicos de calidad del agua y su interpretación.", "href": "3-7.html", "data_file": "3-7.html", "status": "Próximamente", "disabled": false}, {"title": "3.8 Fuentes de contaminación del agua y sus efectos", "desc": "Contaminación microbiológica, química y más.", "href": "3-8.html", "data_file": "3-8.html", "status": "Próximamente", "disabled": false}, {"title": "3.9 Efectos de la contaminación en el agua", "desc": "Impactos en ecosistemas, economía y bienestar.", "href": "3-9.html", "data_file": "3-9.html", "status": "Próximamente", "disabled": false}, {"title": "3.10 La calidad del agua y los efectos en la salud", "desc": "Relación entre agua segura y enfermedades.", "href": "3-10.html", "data_file": "3-10.html", "status": "Próximamente", "disabled": false}]}, {"title": "Módulo 4 · El Suelo", "subs": [{"title": "4.1 ¿Qué es suelo? ¿Cómo se forma el suelo?", "desc": "Módulo 4: qué es el suelo, cómo se forma y dos juegos interactivos.", "href": "4-1.html", "data_file": "4-1.html", "status": "Próximamente", "disabled": true}, {"title": "4.2 Capas de suelo", "desc": "Horizontes del suelo y propiedades físicas: textura, porosidad y retención de agua, con juegos interactivos.", "href": "4-2.html", "data_file": "4-2.html", "status": "Próximamente", "disabled": true}, {"title": "4.3 Clasificación de los suelos del departamento de Sololá", "desc": "Tipos de suelos en Sololá y biodiversidad del suelo, con ahorcado y detective de suelos.", "href": "4-3.html", "data_file": "4-3.html", "status": "Próximamente", "disabled": true}, {"title": "4.4 Empobrecimiento del suelo", "desc": "Causas y efectos del empobrecimiento del suelo.", "href": "4-4.html", "data_file": "4-4.html", "status": "Próximamente", "disabled": true}, {"title": "4.5 Conservación del suelo", "desc": "Prácticas de conservación del suelo: curvas a nivel, barreras y cobertura.", "href": "4-5.html", "data_file": "4-5.html", "status": "Próximamente", "disabled": true}, {"title": "4.6 Agroecosistemas", "desc": "Agroecosistemas: componentes, tipos, servicios y manejo sostenible.", "href": "4-6.html", "data_file": "4-6.html", "status": "Próximamente", "disabled": true}, {"title": "4.7 Prácticas sostenibles para la conservación de suelos", "desc": "Curvas a nivel, barreras vivas, terrazas, compost, lombricompost y abonos verdes.", "href": "4-7.html", "data_file": "4-7.html", "status": "Próximamente", "disabled": true}, {"title": "4.8 Actividad agrícola en el departamento de Sololá", "desc": "Actividad agrícola en Sololá: calendario lunar, producción, café y organizaciones.", "href": "4-8.html", "data_file": "4-8.html", "status": "Próximamente", "disabled": true}, {"title": "4.9 Seguridad alimentaria", "desc": "Seguridad alimentaria: 4 pilares, dieta balanceada, nutrientes y estrategias.", "href": "4-9.html", "data_file": "4-9.html", "status": "Próximamente", "disabled": true}]}, {"title": "Módulo 5 · Saneamiento Ambiental", "subs": [{"title": "5.1 Residuos y desechos", "desc": "Relación entre residuos y desechos con ejemplos de la vida diaria.", "href": "5-1.html", "data_file": "5-1.html", "status": "Próximamente", "disabled": true}, {"title": "5.2 Efectos del mal manejo de residuos y desechos sólidos", "desc": "Aprende sobre “Efectos del mal manejo de residuos y desechos sólidos” con teoría, mapa mental y actividades.", "href": "5-2.html", "data_file": "5-2.html", "status": "Próximamente", "disabled": true}, {"title": "5.3 Situación de los desechos sólidos en el departamento de Sololá", "desc": "Aprende sobre “Situación de los desechos sólidos en el departamento de sololá” con teoría, mapa mental y actividades.", "href": "5-3.html", "data_file": "5-3.html", "status": "Próximamente", "disabled": true}, {"title": "5.4 Buenas prácticas ambientales: “las 3 r’s”", "desc": "Aprende sobre “Buenas prácticas ambientales: “las 3 r’s”” con teoría, mapa mental y actividades.", "href": "5-4.html", "data_file": "5-4.html", "status": "Próximamente", "disabled": true}, {"title": "5.5 Aprovechamiento de residuos y desechos sólidos", "desc": "Aprende sobre “Aprovechamiento de residuos y desechos sólidos” con teoría, mapa mental y actividades.", "href": "5-5.html", "data_file": "5-5.html", "status": "Próximamente", "disabled": true}, {"title": "5.6 Manejo, tratamiento y disposición final de los residuos y desechos sólidos", "desc": "Aprende sobre “Manejo, tratamiento y disposición final de los residuos y desechos sólidos” con teoría, mapa mental y actividades.", "href": "5-6.html", "data_file": "5-6.html", "status": "Próximamente", "disabled": true}, {"title": "5.7 Situación del tratamiento de desechos sólidos en Sololá", "desc": "Aprende sobre “Situación del tratamiento de desechos sólidos en sololá” con teoría, mapa mental y actividades.", "href": "5-7.html", "data_file": "5-7.html", "status": "Próximamente", "disabled": true}, {"title": "5.8 Desechos líquidos", "desc": "Aprende sobre “Desechos líquidos” con teoría, mapa mental y actividades.", "href": "5-8.html", "data_file": "5-8.html", "status": "Próximamente", "disabled": true}, {"title": "5.9 Impacto de las aguas residuales en el ambiente y la salud", "desc": "Aprende sobre “Impacto de las aguas residuales en el ambiente y la salud” con teoría, mapa mental y actividades.", "href": "5-9.html", "data_file": "5-9.html", "status": "Próximamente", "disabled": true}, {"title": "5.10 Tratamiento de las aguas residuales", "desc": "Aprende sobre “Tratamiento de las aguas residuales” con teoría, mapa mental y actividades.", "href": "5-10.html", "data_file": "5-10.html", "status": "Próximamente", "disabled": true}]}, {"title": "Módulo 6 · Conservación De Los Bienes Y Servicios Ambientales", "subs": [{"title": "6.1 Bienes y servicios ambientales", "desc": "Relación entre bienes y servicios ambientales con ejemplos de la vida diaria.", "href": "6-1.html", "data_file": "6-1.html", "status": "Próximamente", "disabled": true}, {"title": "6.2 Uso sostenible de los bienes y servicios ambientales", "desc": "Aprende sobre “Uso sostenible de los bienes y servicios ambientales” con teoría, mapa mental y actividades.", "href": "6-2.html", "data_file": "6-2.html", "status": "Próximamente", "disabled": true}, {"title": "6.3 Áreas protegidas", "desc": "Aprende sobre “Áreas protegidas” con teoría, mapa mental y actividades.", "href": "6-3.html", "data_file": "6-3.html", "status": "Próximamente", "disabled": true}, {"title": "6.4 Reserva de uso múltiple cuenca del Lago de Atitlán", "desc": "Aprende sobre “Reserva de uso múltiple cuenca del lago de atitlán” con teoría, mapa mental y actividades.", "href": "6-4.html", "data_file": "6-4.html", "status": "Próximamente", "disabled": true}, {"title": "6.5 Especies en peligro de extinción presentes en la RUMCLA", "desc": "Aprende sobre “Especies en peligro de extinción presentes en la rumcla” con teoría, mapa mental y actividades.", "href": "6-5.html", "data_file": "6-5.html", "status": "Próximamente", "disabled": true}, {"title": "6.6 Avifauna en la RUMCLA", "desc": "Aprende sobre “Avifauna en la rumcla” con teoría, mapa mental y actividades.", "href": "6-6.html", "data_file": "6-6.html", "status": "Próximamente", "disabled": true}]}, {"title": "Módulo 7 · Valorando Nuestros Recursos Naturales Y Culturales", "subs": [{"title": "7.1 Cosmovisión maya", "desc": "Relación entre cosmovisión maya con ejemplos de la vida diaria.", "href": "7-1.html", "data_file": "7-1.html", "status": "Próximamente", "disabled": true}, {"title": "7.2 Cruz cosmogónica maya", "desc": "Relación entre cruz cosmogónica maya con ejemplos de la vida diaria.", "href": "7-2.html", "data_file": "7-2.html", "status": "Próximamente", "disabled": true}, {"title": "7.3 Conocimientos y prácticas ancestrales tradicionales en Sololá", "desc": "Aprende sobre “Conocimientos y prácticas ancestrales tradicionales en sololá” con teoría, mapa mental y actividades.", "href": "7-3.html", "data_file": "7-3.html", "status": "Próximamente", "disabled": true}, {"title": "7.4 Historia del departamento de Sololá", "desc": "Aprende sobre “Historia del departamento de sololá” con teoría, mapa mental y actividades.", "href": "7-4.html", "data_file": "7-4.html", "status": "Próximamente", "disabled": true}, {"title": "7.5 Turismo", "desc": "Aprende sobre “Turismo” con teoría, mapa mental y actividades.", "href": "7-5.html", "data_file": "7-5.html", "status": "Próximamente", "disabled": true}]}];

    (() => {
      const LS_LAST = 'epc_last';
      const LS_READ_PREFIX = 'epc_read:';

      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

      const state = {
        mode: 'modules', // 'modules' | 'subs'
        filter: 'all',
        query: '',
        modules: JSON.parse(JSON.stringify(DATA)),
        visibleModuleIdxs: [],
        activeVisibleIndex: 0, // index within visible list
        activeModuleIdx: 0, // index within modules
        activeSubVisibleIndex: 0,
        subVisibleIdxs: [],
      };

      function norm(s){
        return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      }

      function setStatus(msg){ $('#statusLine').textContent = msg; }

      function getBase() {
        return location.href.replace(/\/index\.html.*$/,'/').replace(/\/index_.*\.html.*$/,'/').replace(/#.*$/,'');
      }

      async function checkFile(url) {
        try {
          let res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
          if (!res || (res.status === 405 || res.status === 403)) {
            res = await fetch(url, { method: 'GET', cache: 'no-store' });
          }
          return !!res && res.ok;
        } catch (_) {
          return null; // desconocido
        }
      }

      async function refreshAvailabilityForModule(moduleIdx) {
        const base = getBase();
        const mod = state.modules[moduleIdx];
        if (!mod) return;

        const tasks = mod.subs.map(async (s) => {
          if (!s.data_file) return;
          const url = new URL(s.data_file, base).toString();
          const ok = await checkFile(url);
          if (ok === null) return;

          s._available = ok;
          s.status = ok ? 'Disponible' : 'Próximamente';
        });

        await Promise.all(tasks);
      }

      function isRead(href){
        try { return localStorage.getItem(LS_READ_PREFIX + href) === '1'; } catch(_) { return false; }
      }
      function markRead(href){
        try { localStorage.setItem(LS_READ_PREFIX + href, '1'); } catch(_) {}
      }

      function setLastVisited(payload) {
        try { localStorage.setItem(LS_LAST, JSON.stringify(payload)); } catch(_) {}
      }
      function getLastVisited() {
        try {
          const raw = localStorage.getItem(LS_LAST);
          return raw ? JSON.parse(raw) : null;
        } catch(_) { return null; }
      }

      function getContinueTarget() {
        const last = getLastVisited();
        if (!last || !last.href) return null;
        return last;
      }

      function showContinueIfAny() {
        const btn = $('#continueBtn');
        const t = getContinueTarget();
        if (t) {
          btn.style.display = '';
          btn.textContent = `Continuar: ${t.title || 'Subtema'}`;
        } else {
          btn.style.display = 'none';
        }
      }

      function applyFilters() {
        const q = norm(state.query);

        if (state.mode === 'modules') {
          const visible = [];
          state.modules.forEach((m, mi) => {
            const moduleHay = norm(m.title);
            const anySub = m.subs.some(s => norm(`${s.title} ${s.desc}`).includes(q));
            const matchesQ = !q || moduleHay.includes(q) || anySub;

            let matchesF = true;
            if (state.filter === 'available') {
              matchesF = m.subs.some(s => (s._available === true) || (s.status || '').toLowerCase() === 'disponible');
            }
            if (state.filter === 'coming') {
              matchesF = m.subs.some(s => (s._available === false) || (s.status || '').toLowerCase().includes('próxim'));
            }
            if (state.filter === 'read') {
              matchesF = m.subs.some(s => s.href && isRead(s.href));
            }

            if (matchesQ && matchesF) visible.push(mi);
          });
          state.visibleModuleIdxs = visible;
          state.activeVisibleIndex = Math.min(state.activeVisibleIndex, Math.max(0, visible.length-1));
          state.activeModuleIdx = visible[state.activeVisibleIndex] ?? 0;
        } else {
          // subs view
          const mi = state.activeModuleIdx;
          const m = state.modules[mi];
          const visible = [];
          m.subs.forEach((s, si) => {
            const hay = norm(`${s.title} ${s.desc}`);
            const matchesQ = !q || hay.includes(q);

            let matchesF = true;
            const available = (s._available === true) || (s.status || '').toLowerCase() === 'disponible';
            const coming = (s._available === false) || (s.status || '').toLowerCase().includes('próxim');
            const read = s.href && isRead(s.href);

            if (state.filter === 'available') matchesF = available;
            if (state.filter === 'coming') matchesF = coming;
            if (state.filter === 'read') matchesF = read;

            if (matchesQ && matchesF) visible.push(si);
          });
          state.subVisibleIdxs = visible;
          state.activeSubVisibleIndex = Math.min(state.activeSubVisibleIndex, Math.max(0, visible.length-1));
        }
      }

      function updateHeaderText() {
        const pill = $('#counterPill');
        const modeHint = $('#modeHint');

        if (state.mode === 'modules') {
          const total = state.modules.length;
          const shown = state.visibleModuleIdxs.length;
          pill.textContent = `Módulos: ${shown}/${total}`;
          modeHint.textContent = 'Desliza a izquierda/derecha para cambiar de módulo.';
        } else {
          const m = state.modules[state.activeModuleIdx];
          const total = m?.subs?.length ?? 0;
          const shown = state.subVisibleIdxs.length;
          pill.textContent = `Subtemas: ${shown}/${total}`;
          modeHint.textContent = 'Desliza a izquierda/derecha para cambiar de subtema.';
        }
      }

      function buildDots(count, activeIndex) {
        const dots = $('#dots');
        dots.innerHTML = '';
        for (let i=0;i<count;i++) {
          const b = document.createElement('button');
          b.className = 'dot' + (i===activeIndex ? ' active' : '');
          b.type = 'button';
          b.setAttribute('aria-label', `Ir a ${state.mode === 'modules' ? 'módulo' : 'subtema'} ${i+1}`);
          b.addEventListener('click', () => {
            if (state.mode === 'modules') scrollToVisible(i);
            else scrollToVisible(i);
          });
          dots.appendChild(b);
        }
      }

      function render() {
        applyFilters();
        updateHeaderText();
        showContinueIfAny();

        const track = $('#track');
        track.innerHTML = '';

        if (state.mode === 'modules') {
          $('#viewTitle').textContent = 'Módulos';
          $('#subTitleLine').textContent = 'Selecciona un módulo para ver sus subtemas.';
          $('#backBtn').style.display = 'none';
          $('#prevBtn').style.display = '';
          $('#nextBtn').style.display = '';

          const idxs = state.visibleModuleIdxs;
          idxs.forEach((mi, vi) => {
            const m = state.modules[mi];
            const availableCount = m.subs.filter(s => (s._available === true) || (s.status || '').toLowerCase() === 'disponible').length;
            const comingCount = m.subs.filter(s => (s._available === false) || (s.status || '').toLowerCase().includes('próxim')).length;

            const card = document.createElement('article');
            card.className = 'cardBig';
            card.dataset.moduleIndex = String(mi);

            // read badge si hay al menos 1 subtema leído
            const anyRead = m.subs.some(s => s.href && isRead(s.href));
            if (anyRead) card.classList.add('read');

            const h3 = document.createElement('h3');
            h3.textContent = m.title;

            const meta = document.createElement('div');
            meta.className = 'metaRow';

            const t1 = document.createElement('span');
            t1.className = 'tag ok';
            t1.textContent = `${availableCount} disponibles`;

            const t2 = document.createElement('span');
            t2.className = 'tag todo';
            t2.textContent = `${comingCount} próximamente`;

            meta.appendChild(t1);
            meta.appendChild(t2);

            const prev = document.createElement('div');
            prev.className = 'previewList';

            m.subs.slice(0,3).forEach(s => {
              const item = document.createElement('div');
              item.className = 'previewItem';

              const left = document.createElement('div');
              const tt = document.createElement('div');
              tt.className = 't';
              tt.textContent = s.title || 'Subtema';

              const dd = document.createElement('div');
              dd.className = 'd';
              dd.textContent = s.desc || '';

              left.appendChild(tt);
              if (s.desc) left.appendChild(dd);

              const st = document.createElement('span');
              const avail = (s._available === true) || (s.status || '').toLowerCase() === 'disponible';
              st.className = 'tag ' + (avail ? 'ok' : 'todo');
              st.textContent = avail ? 'Disponible' : 'Próximamente';

              item.appendChild(left);
              item.appendChild(st);
              prev.appendChild(item);
            });

            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '10px';
            actions.style.marginTop = '6px';

            const enter = document.createElement('button');
            enter.className = 'btn primary';
            enter.type = 'button';
            enter.textContent = 'Entrar';
            enter.addEventListener('click', () => enterModule(mi));

            const openFirst = document.createElement('button');
            openFirst.className = 'btn';
            openFirst.type = 'button';
            openFirst.textContent = 'Ver subtemas';
            openFirst.addEventListener('click', () => enterModule(mi));

            actions.appendChild(enter);
            actions.appendChild(openFirst);

            const rb = document.createElement('div');
            rb.className = 'readBadge';
            rb.textContent = '✓ Progreso';

            card.appendChild(rb);
            card.appendChild(h3);
            card.appendChild(meta);
            card.appendChild(prev);
            card.appendChild(actions);

            // Enter con teclado
            card.tabIndex = 0;
            card.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') enterModule(mi);
            });

            track.appendChild(card);
          });

          buildDots(idxs.length, state.activeVisibleIndex);
          requestAnimationFrame(() => {
            scrollToVisible(state.activeVisibleIndex, true);
            updateActiveByCenter();
          });
        } else {
          const m = state.modules[state.activeModuleIdx];
          $('#viewTitle').textContent = m?.title || 'Subtemas';
          $('#subTitleLine').textContent = 'Selecciona un subtema para abrirlo.';
          $('#backBtn').style.display = '';
          $('#prevBtn').style.display = '';
          $('#nextBtn').style.display = '';

          const visible = state.subVisibleIdxs;
          visible.forEach((si, vi) => {
            const s = m.subs[si];
            const card = document.createElement('article');
            card.className = 'cardBig';
            card.dataset.subIndex = String(si);

            const href = s.href || '#';
            const read = href && isRead(href);
            if (read) card.classList.add('read');

            const h3 = document.createElement('h3');
            h3.textContent = s.title || 'Subtema';

            const p = document.createElement('p');
            p.textContent = s.desc || '';

            const meta = document.createElement('div');
            meta.className = 'metaRow';

            const avail = (s._available === true) || (s.status || '').toLowerCase() === 'disponible';
            const st = document.createElement('span');
            st.className = 'tag ' + (avail ? 'ok' : 'todo');
            st.textContent = avail ? 'Disponible' : 'Próximamente';
            meta.appendChild(st);

            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '10px';
            actions.style.marginTop = '6px';
            actions.style.flexWrap = 'wrap';

            const open = document.createElement('a');
            open.className = 'btn primary';
            open.textContent = 'Abrir';
            open.href = href || '#';
            if (!avail || !href || href === '#') {
              open.setAttribute('aria-disabled', 'true');
              open.href = '#';
              open.style.pointerEvents = 'none';
              open.style.opacity = '.62';
            } else {
              open.addEventListener('click', () => {
                setLastVisited({ title: s.title, href });
                markRead(href);
              });
            }

            const mark = document.createElement('button');
            mark.className = 'btn';
            mark.type = 'button';
            mark.textContent = read ? 'Leído ✓' : 'Marcar leído';
            mark.addEventListener('click', () => {
              if (href && href !== '#') {
                markRead(href);
                setLastVisited({ title: s.title, href });
                setStatus('Marcado como leído.');
                render();
              }
            });

            actions.appendChild(open);
            actions.appendChild(mark);

            const rb = document.createElement('div');
            rb.className = 'readBadge';
            rb.textContent = '✓ Leído';

            card.appendChild(rb);
            card.appendChild(h3);
            if (s.desc) card.appendChild(p);
            card.appendChild(meta);
            card.appendChild(actions);

            card.tabIndex = 0;
            card.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                if (avail && href && href !== '#') window.location.href = href;
              }
            });

            track.appendChild(card);
          });

          buildDots(visible.length, state.activeSubVisibleIndex);
          requestAnimationFrame(() => {
            scrollToVisible(state.activeSubVisibleIndex, true);
            updateActiveByCenter();
          });
        }
      }

      function getVisibleCards() {
        return $$('.cardBig', $('#track'));
      }

      function updateActiveByCenter() {
        const track = $('#track');
        const cards = getVisibleCards();
        if (!cards.length) return;

        const center = track.scrollLeft + track.clientWidth / 2;
        let bestIdx = 0;
        let bestDist = Infinity;

        cards.forEach((c, i) => {
          const cCenter = c.offsetLeft + c.clientWidth / 2;
          const d = Math.abs(cCenter - center);
          if (d < bestDist) { bestDist = d; bestIdx = i; }
        });

        cards.forEach((c, i) => c.classList.toggle('active', i === bestIdx));

        // actualizar dot
        const dots = $$('.dot', $('#dots'));
        dots.forEach((d, i) => d.classList.toggle('active', i === bestIdx));

        if (state.mode === 'modules') {
          state.activeVisibleIndex = bestIdx;
          state.activeModuleIdx = state.visibleModuleIdxs[bestIdx] ?? state.activeModuleIdx;
        } else {
          state.activeSubVisibleIndex = bestIdx;
        }
      }

      function scrollToVisible(visibleIndex, instant=false) {
        const track = $('#track');
        const cards = getVisibleCards();
        const el = cards[visibleIndex];
        if (!el) return;
        track.scrollTo({ left: el.offsetLeft - 6, behavior: instant ? 'instant' : 'smooth' });
      }

      function step(dir) {
        const cards = getVisibleCards();
        if (!cards.length) return;
        updateActiveByCenter();
        const current = cards.findIndex(c => c.classList.contains('active'));
        const next = Math.max(0, Math.min(cards.length-1, (current === -1 ? 0 : current) + dir));
        scrollToVisible(next);
      }

      async function enterModule(moduleIdx) {
        state.mode = 'subs';
        state.activeModuleIdx = moduleIdx;
        state.activeSubVisibleIndex = 0;

        $('#backBtn').style.display = '';
        $('#modeHint').textContent = 'Cargando subtemas…';
        setStatus('Cargando subtemas…');

        await refreshAvailabilityForModule(moduleIdx);

        // reset búsqueda pero mantiene filtro (opcional)
        // state.query = '';
        render();

        $('#modeHint').textContent = 'Desliza a izquierda/derecha para cambiar de subtema.';
        setStatus('Subtemas listos.');
      }

      function goBack() {
        state.mode = 'modules';
        state.activeSubVisibleIndex = 0;
        render();
        setStatus('De vuelta a módulos.');
      }

      function hookUI() {
        const track = $('#track');
        track.addEventListener('scroll', () => requestAnimationFrame(updateActiveByCenter), { passive: true });

        $('#prevBtn').addEventListener('click', () => step(-1));
        $('#nextBtn').addEventListener('click', () => step(1));

        $('#backBtn').addEventListener('click', goBack);

        $('#continueBtn').addEventListener('click', () => {
          const t = getContinueTarget();
          if (t && t.href) window.location.href = t.href;
        });

        const input = $('#searchInput');
        const clear = $('#clearSearch');

        input.addEventListener('input', () => {
          state.query = input.value || '';
          if (state.mode === 'modules') state.activeVisibleIndex = 0;
          else state.activeSubVisibleIndex = 0;
          render();
        });
        clear.addEventListener('click', () => {
          input.value = '';
          state.query = '';
          render();
          input.focus();
        });

        const chips = $$('.chip[data-filter]');
        chips.forEach(ch => {
          ch.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('active'));
            ch.classList.add('active');
            state.filter = ch.getAttribute('data-filter') || 'all';
            if (state.mode === 'modules') state.activeVisibleIndex = 0;
            else state.activeSubVisibleIndex = 0;
            render();
          });
        });

        // teclado
        window.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') step(-1);
          if (e.key === 'ArrowRight') step(1);
          if (e.key === 'Escape' && state.mode === 'subs') goBack();
          if (e.key === 'Enter') {
            if (state.mode === 'modules') {
              const mi = state.activeModuleIdx;
              enterModule(mi);
            }
          }
        });
      }

      function init() {
        // Preseed availability flags from status text, then we'll refresh per module on demand
        state.modules.forEach(m => {
          m.subs.forEach(s => {
            const st = (s.status || '').toLowerCase();
            if (st === 'disponible') s._available = true;
            else if (st.includes('próxim') || st.includes('proxim')) s._available = false;
          });
        });

        hookUI();
        render();
        setStatus('Listo.');
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
