<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Módulo 1 · 1.2 Cadenas alimenticias o tróficas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Markmap (importación directa y estable para GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.16.1/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.16.1/dist/browser/index.min.js"></script>

  <style>
    :root{
      --ink:#0b1020;
      --muted:rgba(11,16,32,.72);
      --glass:rgba(255,255,255,.66);
      --glass2:rgba(255,255,255,.52);
      --stroke:rgba(11,16,32,.10);
      --shadow:0 18px 45px rgba(11,16,32,.16);
      --shadow-soft:0 10px 24px rgba(11,16,32,.12);
      --radius:24px;

      --good: rgba(30, 160, 90, .18);
      --bad: rgba(210, 70, 100, .18);
      --focus: rgba(45, 160, 220, .30);
      --focus2: rgba(120, 190, 255, .28);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* Fondo pastel azul/celeste */
      background:
        radial-gradient(1100px 760px at 12% 12%, rgba(185, 235, 255, .92), transparent 58%),
        radial-gradient(980px 760px at 84% 18%, rgba(160, 210, 255, .90), transparent 62%),
        radial-gradient(1200px 920px at 48% 96%, rgba(210, 245, 255, .88), transparent 58%),
        linear-gradient(135deg, #ecf9ff 0%, #e7f6ff 45%, #effbff 100%);

      min-height:100vh;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 26px 18px 64px; }

    header{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap:wrap;
    }
    .kicker{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.3px;
    }
    h1{
      margin: 6px 0 0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: clamp(20px, 2.5vw, 28px);
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 92ch;
    }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      color: rgba(11,16,32,.92);
      font-weight: 800;
      text-decoration:none;
      font-size: 13px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg,
        rgba(185,235,255,.92),
        rgba(160,210,255,.90),
        rgba(210,245,255,.90)
      );
    }

    .stack{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h2{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    .twoCols{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .twoCols{ grid-template-columns: 1fr; }
    }
    .theory{
      line-height: 1.6;
      color: rgba(11,16,32,.90);
      font-size: 14px;
    }
    .theory p{ margin: 10px 0 0; }
    .theory ul{ margin: 10px 0 0 18px; }
    .theory li{ margin: 8px 0; }

    /* Markmap */
    .mapWrap{
      width:100%;
      height: 720px;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      position: relative;
    }
    svg.markmap{ width:100%; height:100%; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.58);
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
      white-space: nowrap;
    }

    /* Modal fullscreen (mapa) */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(11,16,32,.35);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modal.open{ display:flex; }
    .modalBox{
      width: min(1200px, 96vw);
      height: min(860px, 92vh);
      border-radius: 18px;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(11,16,32,.14);
      box-shadow: 0 30px 80px rgba(11,16,32,.30);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.70);
    }
    .modalTop strong{
      font-family: Outfit, Inter, system-ui;
      letter-spacing:.2px;
    }
    .modalMap{
      flex:1;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
    }
    .modalMap svg{ width:100%; height:100%; }

    /* Cadenas SVG */
    .chainWrap{
      width:100%;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      background: rgba(255,255,255,.45);
      overflow:hidden;
      position: relative;
      padding: 12px;
    }
    .svgBox{
      width:100%;
      height: 330px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.07) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      border: 1px solid rgba(11,16,32,.10);
      overflow:hidden;
    }
    @media (max-width: 720px){
      .svgBox{ height: 440px; }
    }
    .chainSvg{ width:100%; height:100%; }

    .node{ cursor:pointer; }
    .node rect{
      fill: rgba(255,255,255,.78);
      stroke: rgba(11,16,32,.18);
      stroke-width: 1;
    }
    .node text{
      font-family: Inter, system-ui;
      font-size: 13px;
      font-weight: 800;
      fill: rgba(11,16,32,.90);
    }
    .node .sub{
      font-size: 11px;
      font-weight: 600;
      fill: rgba(11,16,32,.70);
    }
    .arrow{
      stroke: rgba(11,16,32,.65);
      stroke-width: 2.2;
      fill: none;
      opacity: .95;
    }
    .arrow.dim{ opacity: .25; }
    .arrow.active{ opacity: 1; stroke-width: 3.1; }
    .node.active rect{
      stroke-width: 2.5;
      stroke: rgba(45, 160, 220, .85);
    }

    .infoBox{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }

    /* Juego nuevo: conectar nodos */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .tab{
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.60);
      padding: 9px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      outline: 3px solid var(--focus);
      background: rgba(255,255,255,.80);
    }

    .gameArea{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      padding: 12px;
      box-shadow: var(--shadow-soft);
    }
    .gameTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .score{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.58);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,16,32,.78);
    }
    .gameCanvas{
      width:100%;
      height: 420px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.10);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.07) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      overflow:hidden;
    }
    @media (max-width: 720px){
      .gameCanvas{ height: 520px; }
    }

    .g-node circle{
      fill: rgba(255,255,255,.85);
      stroke: rgba(11,16,32,.20);
      stroke-width: 1.2;
    }
    .g-node text{
      font-family: Inter, system-ui;
      font-size: 12px;
      font-weight: 900;
      fill: rgba(11,16,32,.92);
    }
    .g-node .sub{
      font-size: 11px;
      font-weight: 650;
      fill: rgba(11,16,32,.72);
    }
    .g-node.selected circle{
      stroke: rgba(45,160,220,.90);
      stroke-width: 3.0;
    }

    .g-edge{
      stroke: rgba(11,16,32,.62);
      stroke-width: 2.5;
      fill: none;
      marker-end: url(#gArrowHead);
      opacity: .92;
    }

    .result{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }
    .ok{ background: var(--good); border-color: rgba(30,160,90,.28); }
    .no{ background: var(--bad); border-color: rgba(210,70,100,.26); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">Módulo 1 · Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tróficas</h1>
        <p class="subtitle">
          Una cadena alimenticia (o red trófica) representa la dependencia entre organismos y la transferencia de energía y materia a través de niveles tróficos.
          En ecosistemas reales, múltiples cadenas se interconectan formando redes tróficas.
        </p>
      </div>
      <nav class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="1-1.html">Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Pendiente: 1-3.html'); return false;">Siguiente (1.3)</a>
      </nav>
    </header>

    <main class="stack">
      <!-- TEORÍA -->
      <section class="card">
        <h2>Conceptualización técnica y contexto local</h2>
        <div class="twoCols">
          <div class="theory">
            <p>
              Las cadenas alimenticias describen el flujo de energía (direccional) y el ciclado de materia (reciclaje de nutrientes) entre componentes bióticos.
              Se estructuran en:
            </p>
            <ul>
              <li><strong>Productores (autótrofos):</strong> plantas, algas y fitoplancton; sintetizan biomasa usando energía solar y recursos abióticos.</li>
              <li><strong>Consumidores (heterótrofos):</strong> se organizan por niveles: primarios, secundarios, terciarios y cuaternarios según su dieta y posición.</li>
              <li><strong>Descomponedores:</strong> bacterias y hongos (entre otros) degradan materia orgánica y liberan nutrientes para sostener nuevamente a productores.</li>
            </ul>
            <p>
              La energía disminuye entre niveles tróficos, por lo que la estabilidad de depredadores superiores depende del mantenimiento de productores y consumidores inferiores.
            </p>
          </div>

          <div class="theory">
            <p>
              En Sololá, el funcionamiento trófico puede interpretarse en dos grandes marcos:
            </p>
            <ul>
              <li><strong>Terrestre:</strong> cadenas asociadas a agroecosistemas, bosques y matorrales donde insectos herbívoros, anfibios, reptiles y aves interactúan.</li>
              <li><strong>Acuático (cuenca del Lago de Atitlán):</strong> productores acuáticos (algas/fitoplancton) sostienen consumidores (plancton, peces), con niveles superiores y reciclaje bacteriano.</li>
            </ul>
            <p>
              Alteraciones en nutrientes, cobertura vegetal o calidad del agua pueden modificar la productividad primaria y generar efectos en cascada sobre toda la red trófica.
            </p>
          </div>
        </div>
      </section>

      <!-- MAPA CONCEPTUAL (MARKMAP) -->
      <section class="card">
        <h2>Mapa conceptual interactivo (expandido)</h2>
        <p class="muted" style="margin:8px 0 0;">Mapa expandido por defecto.</p>

        <div class="mapWrap">
          <svg id="mmConcept" class="markmap"></svg>
        </div>

        <div class="row">
          <button class="btn" id="fitConcept">Ajustar</button>
          <button class="btn" id="resetConcept">Reiniciar</button>
          <button class="btn primary" id="fsConcept">Pantalla completa</button>
          <span class="pill">Expandido</span>
        </div>
      </section>

      <!-- CADENA TERRESTRE -->
      <section class="card">
        <h2>Cadena trófica terrestre (flujo de energía)</h2>
        <p class="muted" style="margin:8px 0 0;">Clic en un nodo para resaltar el flujo.</p>

        <div class="chainWrap">
          <div class="svgBox">
            <svg class="chainSvg" viewBox="0 0 1000 320" preserveAspectRatio="xMidYMid meet">
              <defs>
                <marker id="arrowHeadT" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                  <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(11,16,32,.65)"></path>
                </marker>
              </defs>

              <path id="tArrow1" class="arrow" d="M 150 160 L 330 160" marker-end="url(#arrowHeadT)"></path>
              <path id="tArrow2" class="arrow" d="M 390 160 L 570 160" marker-end="url(#arrowHeadT)"></path>
              <path id="tArrow3" class="arrow" d="M 630 160 L 810 160" marker-end="url(#arrowHeadT)"></path>

              <g id="tNodeP" class="node" data-node="P" transform="translate(40,110)">
                <rect rx="18" ry="18" width="190" height="100"></rect>
                <text x="18" y="40">Productores</text>
                <text class="sub" x="18" y="66">Plantas</text>
              </g>

              <g id="tNodeC1" class="node" data-node="C1" transform="translate(280,110)">
                <rect rx="18" ry="18" width="190" height="100"></rect>
                <text x="18" y="40">Consumidor primario</text>
                <text class="sub" x="18" y="66">Orugas</text>
              </g>

              <g id="tNodeC2" class="node" data-node="C2" transform="translate(520,110)">
                <rect rx="18" ry="18" width="190" height="100"></rect>
                <text x="18" y="40">Consumidor secundario</text>
                <text class="sub" x="18" y="66">Sapos y ranas</text>
              </g>

              <g id="tNodeTop" class="node" data-node="TOP" transform="translate(760,110)">
                <rect rx="18" ry="18" width="200" height="100"></rect>
                <text x="18" y="40">Depredadores</text>
                <text class="sub" x="18" y="66">Serpientes / gavilanes</text>
              </g>
            </svg>
          </div>

          <div class="infoBox" id="tInfo">
            Selecciona un nodo para resaltar el flujo de energía.
          </div>

          <div class="row">
            <button class="btn" id="tReset">Reiniciar resaltado</button>
          </div>
        </div>
      </section>

      <!-- CADENA ACUÁTICA -->
      <section class="card">
        <h2>Cadena trófica acuática (cuenca del Lago de Atitlán)</h2>
        <p class="muted" style="margin:8px 0 0;">Clic en un nodo para resaltar el flujo.</p>

        <div class="chainWrap">
          <div class="svgBox">
            <svg class="chainSvg" viewBox="0 0 1000 320" preserveAspectRatio="xMidYMid meet">
              <defs>
                <marker id="arrowHeadA" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                  <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(11,16,32,.65)"></path>
                </marker>
              </defs>

              <path id="aArrow1" class="arrow" d="M 165 160 L 330 160" marker-end="url(#arrowHeadA)"></path>
              <path id="aArrow2" class="arrow" d="M 405 160 L 570 160" marker-end="url(#arrowHeadA)"></path>
              <path id="aArrow3" class="arrow" d="M 645 160 L 810 160" marker-end="url(#arrowHeadA)"></path>

              <g id="aNodeP" class="node" data-node="P" transform="translate(40,110)">
                <rect rx="18" ry="18" width="210" height="100"></rect>
                <text x="18" y="40">Productores acuáticos</text>
                <text class="sub" x="18" y="66">Algas / fitoplancton</text>
              </g>

              <g id="aNodeC1" class="node" data-node="C1" transform="translate(300,110)">
                <rect rx="18" ry="18" width="210" height="100"></rect>
                <text x="18" y="40">Consumidores</text>
                <text class="sub" x="18" y="66">Plancton / peces pequeños</text>
              </g>

              <g id="aNodeC2" class="node" data-node="C2" transform="translate(560,110)">
                <rect rx="18" ry="18" width="210" height="100"></rect>
                <text x="18" y="40">Peces más grandes</text>
                <text class="sub" x="18" y="66">Depredación</text>
              </g>

              <g id="aNodeTop" class="node" data-node="TOP" transform="translate(820,110)">
                <rect rx="18" ry="18" width="160" height="100"></rect>
                <text x="18" y="40">Aves</text>
                <text class="sub" x="18" y="66">Consumo de biota acuática</text>
              </g>
            </svg>
          </div>

          <div class="infoBox" id="aInfo">
            Selecciona un nodo para resaltar el flujo de energía.
          </div>

          <div class="row">
            <button class="btn" id="aReset">Reiniciar resaltado</button>
          </div>
        </div>
      </section>

      <!-- JUEGO NUEVO -->
      <section class="card">
        <h2>Mini-juego: construye el flujo de energía conectando nodos</h2>
        <p class="muted" style="margin:8px 0 0;">
          Instrucción: clic en un nodo (origen) y luego clic en otro nodo (destino) para crear una flecha de flujo de energía.
        </p>

        <div class="tabs">
          <button class="tab active" id="tabTer">Modo terrestre</button>
          <button class="tab" id="tabAcu">Modo acuático</button>
        </div>

        <div class="gameArea">
          <div class="gameTop">
            <div class="row" style="margin:0;">
              <button class="btn primary" id="btnEval">Evaluar</button>
              <button class="btn" id="btnUndo">Deshacer</button>
              <button class="btn" id="btnClear">Reiniciar</button>
            </div>
            <span class="score" id="score">Conexiones: 0</span>
          </div>

          <div class="gameCanvas">
            <svg id="gameSvg" viewBox="0 0 1000 420" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
              <defs>
                <marker id="gArrowHead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                  <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(11,16,32,.62)"></path>
                </marker>
              </defs>

              <g id="edgeLayer"></g>
              <g id="nodeLayer"></g>
            </svg>
          </div>

          <div class="result" id="result">
            Estado: sin evaluación.
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL MAPA -->
  <div class="modal" id="modalConcept">
    <div class="modalBox" role="dialog" aria-modal="true" aria-label="Mapa conceptual en pantalla completa">
      <div class="modalTop">
        <strong>Mapa conceptual · 1.2</strong>
        <div class="row" style="margin:0;">
          <button class="btn" id="mFitConcept">Ajustar</button>
          <button class="btn" id="mResetConcept">Reiniciar</button>
          <button class="btn primary" id="mCloseConcept">Cerrar</button>
        </div>
      </div>
      <div class="modalMap">
        <svg id="mmConceptFull" class="markmap"></svg>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 1) MARKMAP (siempre expandido)
    // =========================
    const mdConcept = `
# 1.2 Cadenas alimenticias o tróficas
## Propósito
- Representar dependencia entre organismos
- Describir flujo de energía y transferencia de materia
- Integrar cadenas conectadas como redes tróficas
## Niveles tróficos
### Productores (autótrofos)
- Plantas, algas, fitoplancton
- Base energética: síntesis de biomasa (energía solar → materia orgánica)
### Consumidores (heterótrofos)
- Primarios: herbivoría / consumo de productores
- Secundarios: depredación de primarios
- Terciarios y cuaternarios: depredadores superiores
### Descomponedores
- Bacterias y hongos
- Mineralización y reciclaje de nutrientes
## Contexto Sololá / cuenca Lago de Atitlán
- Terrestre: productores → insectos herbívoros → anfibios → reptiles/aves
- Acuático: algas/fitoplancton → plancton/peces pequeños → peces grandes → aves
`.trim();

    let mm = null;
    let mmFull = null;

    function renderMarkmap(svgId, md){
      const { Transformer } = window.markmap;
      const transformer = new Transformer();
      const { root } = transformer.transform(md);

      const svg = document.getElementById(svgId);
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      const m = window.markmap.Markmap.create(svg, { autoFit: true, duration: 240 }, root);
      m.unfoldAll();
      m.fit();
      return m;
    }

    function initMap(){
      mm = renderMarkmap('mmConcept', mdConcept);
    }
    // render cuando todo está cargado (evita fallo CDN)
    window.addEventListener('load', () => {
      try{ initMap(); }catch(e){}
    });

    document.getElementById('fitConcept').addEventListener('click', () => mm && mm.fit());
    document.getElementById('resetConcept').addEventListener('click', () => {
      try{ initMap(); }catch(e){}
    });

    const modalConcept = document.getElementById('modalConcept');
    document.getElementById('fsConcept').addEventListener('click', () => {
      modalConcept.classList.add('open');
      setTimeout(() => {
        try{ mmFull = renderMarkmap('mmConceptFull', mdConcept); }catch(e){}
      }, 0);
    });
    document.getElementById('mCloseConcept').addEventListener('click', () => modalConcept.classList.remove('open'));
    modalConcept.addEventListener('click', (e) => { if (e.target === modalConcept) modalConcept.classList.remove('open'); });
    document.getElementById('mFitConcept').addEventListener('click', () => mmFull && mmFull.fit());
    document.getElementById('mResetConcept').addEventListener('click', () => {
      try{ mmFull = renderMarkmap('mmConceptFull', mdConcept); }catch(e){}
    });

    // =========================
    // 2) RESALTADO DE CADENAS (terrestre / acuática)
    // =========================
    function setActiveChain(prefix, node){
      const nodes = [
        document.getElementById(prefix+'NodeP'),
        document.getElementById(prefix+'NodeC1'),
        document.getElementById(prefix+'NodeC2'),
        document.getElementById(prefix+'NodeTop')
      ].filter(Boolean);

      const arrows = [
        document.getElementById(prefix+'Arrow1'),
        document.getElementById(prefix+'Arrow2'),
        document.getElementById(prefix+'Arrow3')
      ].filter(Boolean);

      nodes.forEach(n => n.classList.remove('active'));
      arrows.forEach(a => { a.classList.remove('active'); a.classList.add('dim'); });

      const info = document.getElementById(prefix.toLowerCase()+'Info');
      if (!node){
        arrows.forEach(a => a.classList.remove('dim'));
        info.textContent = 'Selecciona un nodo para resaltar el flujo de energía.';
        return;
      }

      const mapNodeId = { P: prefix+'NodeP', C1: prefix+'NodeC1', C2: prefix+'NodeC2', TOP: prefix+'NodeTop' };
      document.getElementById(mapNodeId[node]).classList.add('active');

      const explainT = {
        P: 'Productores: convierten energía solar en biomasa.',
        C1:'Consumidor primario: consume productores.',
        C2:'Consumidor secundario: depreda consumidores primarios.',
        TOP:'Depredadores superiores: depredación sobre niveles previos.'
      };

      const explainA = {
        P: 'Productores acuáticos: algas/fitoplancton como base energética.',
        C1:'Consumidores: plancton/peces pequeños.',
        C2:'Peces más grandes: depredación y concentración de energía.',
        TOP:'Aves: consumo de organismos acuáticos.'
      };

      const explain = (prefix === 't') ? explainT : explainA;
      info.innerHTML = '<strong>' + explain[node] + '</strong>';

      const order = ['P','C1','C2','TOP'];
      const idx = order.indexOf(node);
      for (let i=0;i<Math.max(1, idx);i++){
        if (arrows[i]){
          arrows[i].classList.remove('dim');
          arrows[i].classList.add('active');
        }
      }
      if (node === 'P'){
        arrows.forEach(a => a.classList.add('dim'));
        if (arrows[0]){
          arrows[0].classList.remove('dim');
          arrows[0].classList.add('active');
        }
      }
    }

    document.getElementById('tNodeP').addEventListener('click', () => setActiveChain('t','P'));
    document.getElementById('tNodeC1').addEventListener('click', () => setActiveChain('t','C1'));
    document.getElementById('tNodeC2').addEventListener('click', () => setActiveChain('t','C2'));
    document.getElementById('tNodeTop').addEventListener('click', () => setActiveChain('t','TOP'));
    document.getElementById('tReset').addEventListener('click', () => setActiveChain('t',null));
    setActiveChain('t',null);

    document.getElementById('aNodeP').addEventListener('click', () => setActiveChain('a','P'));
    document.getElementById('aNodeC1').addEventListener('click', () => setActiveChain('a','C1'));
    document.getElementById('aNodeC2').addEventListener('click', () => setActiveChain('a','C2'));
    document.getElementById('aNodeTop').addEventListener('click', () => setActiveChain('a','TOP'));
    document.getElementById('aReset').addEventListener('click', () => setActiveChain('a',null));
    setActiveChain('a',null);

    // =========================
    // 3) JUEGO NUEVO: Conectar nodos (dos modos)
    // =========================
    const tabTer = document.getElementById('tabTer');
    const tabAcu = document.getElementById('tabAcu');
    const nodeLayer = document.getElementById('nodeLayer');
    const edgeLayer = document.getElementById('edgeLayer');
    const scoreEl = document.getElementById('score');
    const resultEl = document.getElementById('result');

    const MODES = {
      terrestrial: {
        name: 'Terrestre',
        nodes: [
          { id:'P',  x:140, y:120, label:'Productores', sub:'Plantas' },
          { id:'C1', x:420, y:120, label:'Consumidor primario', sub:'Orugas' },
          { id:'C2', x:700, y:120, label:'Consumidor secundario', sub:'Sapos/ranas' },
          { id:'TOP',x:860, y:280, label:'Depredadores', sub:'Serpientes/aves' }
        ],
        requiredEdges: [
          ['P','C1'],
          ['C1','C2'],
          ['C2','TOP']
        ]
      },
      aquatic: {
        name: 'Acuático',
        nodes: [
          { id:'P',  x:140, y:120, label:'Productores acuáticos', sub:'Algas/fitoplancton' },
          { id:'C1', x:470, y:120, label:'Consumidores', sub:'Plancton/peces pequeños' },
          { id:'C2', x:770, y:120, label:'Peces más grandes', sub:'Depredación' },
          { id:'TOP',x:860, y:300, label:'Aves', sub:'Consumo de biota acuática' }
        ],
        requiredEdges: [
          ['P','C1'],
          ['C1','C2'],
          ['C2','TOP']
        ]
      }
    };

    let mode = 'terrestrial';
    let selected = null;            // id del nodo origen seleccionado
    let edges = [];                 // lista de pares [from,to]
    let edgeEls = [];               // elementos SVG
    let nodeEls = new Map();        // id -> g

    function setTabs(){
      tabTer.classList.toggle('active', mode === 'terrestrial');
      tabAcu.classList.toggle('active', mode === 'aquatic');
    }

    function clearLayers(){
      while (nodeLayer.firstChild) nodeLayer.removeChild(nodeLayer.firstChild);
      while (edgeLayer.firstChild) edgeLayer.removeChild(edgeLayer.firstChild);
      nodeEls.clear();
      edgeEls = [];
    }

    function edgeKey(a,b){ return a+'->'+b; }
    function hasEdge(a,b){
      const k = edgeKey(a,b);
      return edges.some(e => edgeKey(e[0],e[1]) === k);
    }

    function drawEdge(a,b){
      const nodes = MODES[mode].nodes;
      const na = nodes.find(n => n.id === a);
      const nb = nodes.find(n => n.id === b);
      if (!na || !nb) return;

      const path = document.createElementNS('http://www.w3.org/2000/svg','path');

      // flecha con curva suave para evitar choque visual
      const dx = nb.x - na.x;
      const dy = nb.y - na.y;
      const c1x = na.x + dx * 0.45;
      const c1y = na.y + dy * 0.05;
      const c2x = na.x + dx * 0.55;
      const c2y = na.y + dy * 0.95;
      const d = `M ${na.x} ${na.y} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${nb.x} ${nb.y}`;

      path.setAttribute('d', d);
      path.setAttribute('class','g-edge');
      edgeLayer.appendChild(path);
      edgeEls.push(path);
    }

    function updateScore(){
      scoreEl.textContent = 'Conexiones: ' + edges.length;
    }

    function setResult(type, html){
      resultEl.classList.remove('ok','no');
      if (type) resultEl.classList.add(type);
      resultEl.innerHTML = html;
    }

    function deselectAll(){
      selected = null;
      nodeEls.forEach(g => g.classList.remove('selected'));
    }

    function onNodeClick(id){
      if (!selected){
        selected = id;
        deselectAll();
        nodeEls.get(id).classList.add('selected');
        return;
      }
      if (selected === id){
        deselectAll();
        return;
      }
      // crear arista selected -> id
      if (!hasEdge(selected, id)){
        edges.push([selected, id]);
        drawEdge(selected, id);
        updateScore();
      }
      deselectAll();
    }

    function renderNodes(){
      const nodes = MODES[mode].nodes;

      nodes.forEach(n => {
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','g-node');
        g.style.cursor = 'pointer';

        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', n.x);
        c.setAttribute('cy', n.y);
        c.setAttribute('r', 52);

        const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t1.setAttribute('x', n.x);
        t1.setAttribute('y', n.y - 6);
        t1.setAttribute('text-anchor','middle');
        t1.textContent = n.label;

        const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t2.setAttribute('x', n.x);
        t2.setAttribute('y', n.y + 16);
        t2.setAttribute('text-anchor','middle');
        t2.setAttribute('class','sub');
        t2.textContent = n.sub;

        g.appendChild(c);
        g.appendChild(t1);
        g.appendChild(t2);

        g.addEventListener('click', () => onNodeClick(n.id));

        nodeLayer.appendChild(g);
        nodeEls.set(n.id, g);
      });
    }

    function initGame(newMode){
      mode = newMode;
      setTabs();
      clearLayers();
      edges = [];
      selected = null;
      updateScore();
      setResult(null, 'Estado: sin evaluación.');
      renderNodes();
    }

    function undo(){
      if (edges.length === 0) return;
      edges.pop();
      const lastEl = edgeEls.pop();
      if (lastEl && lastEl.parentNode) lastEl.parentNode.removeChild(lastEl);
      updateScore();
      setResult(null, 'Estado: sin evaluación.');
    }

    function clearAll(){
      initGame(mode);
    }

    function evaluate(){
      const required = MODES[mode].requiredEdges;
      const reqKeys = required.map(e => edgeKey(e[0],e[1]));
      const userKeys = edges.map(e => edgeKey(e[0],e[1]));

      let correct = 0;
      reqKeys.forEach(k => { if (userKeys.includes(k)) correct++; });

      // penaliza aristas extra que no están en el modelo
      const extras = userKeys.filter(k => !reqKeys.includes(k)).length;

      if (correct === reqKeys.length && extras === 0){
        setResult('ok',
          '<strong>Evaluación:</strong> flujo correcto y sin conexiones extra. ' +
          'Interpretación: la energía fluye desde productores hacia consumidores y niveles superiores.'
        );
      } else {
        setResult('no',
          '<strong>Evaluación:</strong> correctas: ' + correct + '/' + reqKeys.length +
          ' · extras: ' + extras +
          '<br>Requeridas: ' + required.map(e => e[0] + '→' + e[1]).join(', ')
        );
      }
    }

    tabTer.addEventListener('click', () => initGame('terrestrial'));
    tabAcu.addEventListener('click', () => initGame('aquatic'));
    document.getElementById('btnUndo').addEventListener('click', undo);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    document.getElementById('btnEval').addEventListener('click', evaluate);

    // inicia juego
    initGame('terrestrial');
  </script>
</body>
</html>
