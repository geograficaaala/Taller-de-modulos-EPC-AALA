<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Módulo 1 · 1.2 Las cadenas alimenticias o tróficas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Markmap (mapa mental) -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16.1"></script>

  <!-- D3 + Sankey (diagrama editorial) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

  <style>
    :root{
      --ink:#0b1020;
      --muted:rgba(11,16,32,.72);
      --glass:rgba(255,255,255,.66);
      --stroke:rgba(11,16,32,.10);
      --shadow:0 18px 45px rgba(11,16,32,.16);
      --shadow-soft:0 10px 24px rgba(11,16,32,.12);
      --radius:24px;

      --good: rgba(30, 160, 90, .18);
      --bad: rgba(210, 70, 100, .16);
      --focus: rgba(45, 160, 220, .22);

      --aqua: rgba(45,160,220,.86);
      --mint: rgba(50, 170, 120, .86);
      --rose: rgba(240, 110, 170, .82);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 760px at 12% 12%, rgba(175, 255, 216, .88), transparent 58%),
        radial-gradient(980px 760px at 82% 18%, rgba(170, 226, 255, .88), transparent 62%),
        radial-gradient(1200px 920px at 48% 96%, rgba(255, 191, 228, .76), transparent 58%),
        linear-gradient(135deg, #eafff4 0%, #e8f6ff 45%, #fff0f7 100%);
      min-height:100vh;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 26px 18px 64px; }

    header{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap:wrap;
    }
    .kicker{ font-size: 12px; color: var(--muted); font-weight: 800; letter-spacing:.3px; }
    h1{
      margin: 6px 0 0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: clamp(20px, 2.5vw, 28px);
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 92ch;
    }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      color: rgba(11,16,32,.92);
      font-weight: 800;
      text-decoration:none;
      font-size: 13px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); box-shadow: 0 10px 18px rgba(11,16,32,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82)); }

    .stack{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h2{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    .twoCols{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .twoCols{ grid-template-columns: 1fr; } }
    .theory{ line-height: 1.58; color: rgba(11,16,32,.90); font-size: 14px; }
    .theory p{ margin: 10px 0 0; }
    .theory ul{ margin: 10px 0 0 18px; }
    .theory li{ margin: 8px 0; }
    .callout{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      color: rgba(11,16,32,.86);
      font-size: 13px;
      line-height: 1.45;
    }

    /* =========================
       DIAGRAMA SANKEY (arreglado)
       ========================= */
    .diagramWrap{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.60), rgba(255,255,255,.45));
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      position: relative;
    }
    .diagramTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
    }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tab{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{ background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82)); }

    .badge{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
    }

    .sankeyStage{
      height: 560px;
      width: 100%;
      position: relative;
    }
    @media (max-width: 820px){ .sankeyStage{ height: 660px; } }

    .legendBox{
      position:absolute;
      right: 14px;
      top: 14px;
      width: min(360px, calc(100% - 28px));
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      z-index: 3;
    }
    .legendBox h3{
      margin:0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .legendList{ margin:0; padding-left: 16px; }
    .legendList li{
      margin: 6px 0;
      font-size: 12px;
      color: rgba(11,16,32,.80);
      line-height: 1.35;
    }

    .sErr{
      position:absolute;
      left: 14px;
      bottom: 14px;
      right: 14px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      font-size: 12.5px;
      color: rgba(11,16,32,.86);
      display:none;
      z-index: 3;
    }
    .sErr.show{ display:block; }

    .tooltip{
      position:absolute;
      pointer-events:none;
      z-index: 4;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .10s ease, transform .10s ease;
      max-width: 320px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(11,16,32,.86);
    }
    .tooltip strong{ font-weight: 900; }

    .hint{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }

    /* =========================
       MAPA MENTAL (igual patrón)
       ========================= */
    .mapWrap{
      width:100%;
      height: 720px;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      position: relative;
    }
    svg.markmap{ width:100%; height:100%; }
    .mapFallback{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: rgba(11,16,32,.75);
      background: rgba(255,255,255,.55);
    }
    .mapFallback.show{ display:flex; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    /* =========================
       JUEGO (más vistoso)
       ========================= */
    .simGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .simGrid{ grid-template-columns: 1fr; } }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      padding: 12px;
    }
    .panel h3{
      margin: 0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .ctrl{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      margin: 10px 0;
    }
    .ctrl label{ font-weight: 800; font-size: 13px; color: rgba(11,16,32,.86); }
    .ctrl .val{
      font-weight: 900;
      font-size: 13px;
      color: rgba(11,16,32,.86);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      min-width: 64px;
      text-align:center;
    }
    input[type="range"]{ width: 100%; accent-color: rgba(45,160,220,.75); }

    .simBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }

    .statRow{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){ .statRow{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px){ .statRow{ grid-template-columns: 1fr; } }

    .stat{
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.62);
      padding: 10px;
    }
    .stat .k{
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
      margin: 0 0 6px;
    }
    .stat .v{
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 18px;
      color: rgba(11,16,32,.92);
      margin: 0 0 8px;
      letter-spacing:.2px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(11,16,32,.10);
      overflow:hidden;
      border: 1px solid rgba(11,16,32,.10);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(45,160,220,.80), rgba(50,170,120,.80), rgba(240,110,170,.72));
    }

    .canvasWrap{
      border-radius: 16px;
      border: 1px dashed rgba(11,16,32,.22);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        linear-gradient(180deg, rgba(255,255,255,.56), rgba(255,255,255,.40));
      overflow:hidden;
      padding: 10px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
    }
    canvas{ width: 100%; height: 320px; display:block; }

    .result{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }
    .ok{ background: var(--good); border-color: rgba(30,160,90,.26); }
    .no{ background: var(--bad); border-color: rgba(210,70,100,.24); }

    footer{ margin-top: 14px; color: rgba(11,16,32,.62); font-size: 12px; line-height: 1.4; text-align:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">Módulo 1 · Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tróficas</h1>
        <p class="subtitle">
          Diagrama editorial interactivo de cadena trófica y ciclos (C, N, P), mapa mental, y un simulador de cascada trófica para evaluar comprensión.
        </p>
      </div>
      <nav class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="1-1.html">Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Se agregará la siguiente sección.'); return false;">Siguiente</a>
      </nav>
    </header>

    <main class="stack">
      <section class="card">
        <h2>Contexto teórico</h2>
        <div class="twoCols">
          <div class="theory">
            <p>
              Una <strong>cadena alimenticia</strong> (o trófica) describe quién se alimenta de quién y cómo fluye la <strong>energía</strong>
              desde los <strong>productores</strong> hacia consumidores y depredadores. La <strong>materia</strong> (C, N, P) se transforma
              y puede reciclarse por suelo y microbiota.
            </p>
            <ul>
              <li><strong>Productores:</strong> plantas/algas (energía solar a biomasa).</li>
              <li><strong>Consumidores:</strong> primarios (herbívoros), secundarios/terciarios (carnívoros).</li>
              <li><strong>Descomponedores:</strong> hongos y bacterias (retorno de nutrientes).</li>
            </ul>
            <div class="callout">
              La energía disponible disminuye en cada transferencia; los niveles superiores suelen tener menor biomasa.
            </div>
          </div>

          <div class="theory">
            <p>
              En sistemas agrícolas (por ejemplo, café bajo sombra) la cadena trófica se integra con procesos de ciclos biogeoquímicos:
              fotosíntesis/respiración, mineralización, nitrificación, asimilación radicular, lixiviación y escorrentía.
            </p>
            <div class="callout">
              Pregunta guía: ¿qué ocurre con la cadena si disminuye la producción primaria o se pierden depredadores?
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Diagrama conceptual editorial (interactivo)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Interacción: pasar el cursor o tocar resalta; clic fija el resaltado; clic en fondo lo quita.
        </p>

        <div class="diagramWrap">
          <div class="diagramTop">
            <div class="tabs">
              <button class="tab active" id="sTabCafe" type="button">Sistema café (conceptual)</button>
              <button class="tab" id="sTabSimple" type="button">Cadena trófica simple</button>
              <span class="badge" id="sBadge">Resaltado: ninguno</span>
            </div>
            <div class="tabs">
              <button class="btn" id="sReset" type="button">Reiniciar</button>
            </div>
          </div>

          <div class="sankeyStage" id="sankeyStage">
            <div class="legendBox">
              <h3>Leyenda</h3>
              <ul class="legendList">
                <li>Reservorios: atmósfera y agua.</li>
                <li>Vegetación: productores primarios.</li>
                <li>Fauna: herbívoros y depredadores.</li>
                <li>Microbiota: descomposición y simbiosis.</li>
                <li>Suelo: MO y formas minerales (N y P).</li>
                <li>El grosor de bandas indica intensidad relativa del flujo.</li>
              </ul>
            </div>
            <div class="tooltip" id="tip"></div>
            <div class="sErr" id="sErr"></div>
          </div>

          <div class="hint" id="sHint">
            Sugerencia: identifica productores, ruta herbívoros-depredadores y cómo suelo y microbiota cierran el ciclo.
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Mapa mental interactivo</h2>
        <p class="muted" style="margin:8px 0 0;">Si no carga, recarga la página. El simulador funciona aunque el mapa falle.</p>

        <div class="mapWrap">
          <svg id="mindmap" class="markmap"></svg>
          <div class="mapFallback" id="mapFallback">
            <div>
              <strong>No se pudo cargar el mapa mental.</strong><br>
              Recarga la página. El simulador sigue funcionando.
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnFit" type="button">Ajustar</button>
          <button class="btn" id="btnToggle" type="button">Expandir/Colapsar</button>
          <button class="btn" id="btnReset" type="button">Reiniciar mapa</button>
        </div>
      </section>

      <section class="card">
        <h2>Simulador de cascada trófica (evaluación)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Ajusta parámetros para mantener un sistema estable. Prueba eventos y recupera el equilibrio.
        </p>

        <div class="simGrid">
          <div class="panel">
            <h3>Controles</h3>

            <div class="ctrl">
              <label for="kProd">Producción primaria (productores)</label>
              <span class="val" id="vProd">0.70</span>
            </div>
            <input id="kProd" type="range" min="0.20" max="1.20" step="0.01" value="0.70">

            <div class="ctrl">
              <label for="kHerb">Consumo herbívoro (presión)</label>
              <span class="val" id="vHerb">0.60</span>
            </div>
            <input id="kHerb" type="range" min="0.20" max="1.20" step="0.01" value="0.60">

            <div class="ctrl">
              <label for="kPred">Depredación (control)</label>
              <span class="val" id="vPred">0.55</span>
            </div>
            <input id="kPred" type="range" min="0.20" max="1.20" step="0.01" value="0.55">

            <div class="ctrl">
              <label for="kRecycle">Reciclaje (retorno de nutrientes)</label>
              <span class="val" id="vRec">0.45</span>
            </div>
            <input id="kRecycle" type="range" min="0.10" max="1.10" step="0.01" value="0.45">

            <div class="simBtns">
              <button class="btn" id="btnStart" type="button">Iniciar</button>
              <button class="btn" id="btnPause" type="button">Pausar</button>
              <button class="btn" id="btnShock1" type="button">Evento: sequía</button>
              <button class="btn" id="btnShock2" type="button">Evento: pérdida de depredadores</button>
              <button class="btn primary" id="btnSimReset" type="button">Reiniciar</button>
              <span class="badge" id="simScore">Estado: detenido</span>
            </div>

            <div class="statRow">
              <div class="stat">
                <div class="k">Productores</div>
                <div class="v" id="svP">0.00</div>
                <div class="bar"><i id="sbP"></i></div>
              </div>
              <div class="stat">
                <div class="k">Herbívoros</div>
                <div class="v" id="svH">0.00</div>
                <div class="bar"><i id="sbH"></i></div>
              </div>
              <div class="stat">
                <div class="k">Depredadores</div>
                <div class="v" id="svD">0.00</div>
                <div class="bar"><i id="sbD"></i></div>
              </div>
              <div class="stat">
                <div class="k">Nutrientes</div>
                <div class="v" id="svN">0.00</div>
                <div class="bar"><i id="sbN"></i></div>
              </div>
            </div>

            <div class="result" id="simFeedback">
              Presiona Iniciar. Luego aplica un evento y ajusta controles para recuperar estabilidad.
            </div>
          </div>

          <div class="panel">
            <h3>Gráfica</h3>
            <div class="canvasWrap">
              <canvas id="chart" width="900" height="360"></canvas>
            </div>
            <div class="hint">
              Lectura rápida: si productores caen demasiado, todo colapsa. Si herbívoros suben mucho, productores bajan. Si depredadores desaparecen, herbívoros tienden a explotar.
            </div>
          </div>
        </div>
      </section>

      <footer>EPC AALA · Módulo 1 · 1.2 Cadenas tróficas</footer>
    </main>
  </div>

  <script>
    /* =========================================================
       A) SANKEY (robusto + arreglado)
       - Reintenta si CDN tarda
       - Usa ResizeObserver
       - Si contenedor reporta 0, usa altura CSS como respaldo
       ========================================================= */
    const sankeyStage = document.getElementById('sankeyStage');
    const tip = document.getElementById('tip');
    const sBadge = document.getElementById('sBadge');
    const sErr = document.getElementById('sErr');

    let sLocked = false;
    let sLockKey = null;
    let sMode = 'cafe';
    let ro = null;

    function badge(text){ sBadge.textContent = 'Resaltado: ' + text; }

    function setTip(html, x, y){
      tip.innerHTML = html;
      tip.style.left = x + 'px';
      tip.style.top = y + 'px';
      tip.style.opacity = 1;
      tip.style.transform = 'translateY(0)';
    }
    function hideTip(){
      tip.style.opacity = 0;
      tip.style.transform = 'translateY(6px)';
    }

    function sankeyData(mode){
      if(mode === 'simple'){
        return {
          nodes: [
            {id:'Prod', name:'Productores', group:'Vegetación'},
            {id:'Herb', name:'Herbívoros', group:'Fauna'},
            {id:'Pred', name:'Depredadores', group:'Fauna'},
            {id:'Deco', name:'Descomponedores', group:'Microbiota'},
            {id:'Soil', name:'Suelo (MO y minerales)', group:'Suelo'},
            {id:'Water', name:'Agua (pérdidas)', group:'Agua'}
          ],
          links: [
            {source:'Prod', target:'Herb', value: 6.0, label:'Consumo'},
            {source:'Herb', target:'Pred', value: 4.2, label:'Depredación'},
            {source:'Prod', target:'Soil', value: 2.2, label:'Hojarasca'},
            {source:'Herb', target:'Soil', value: 1.4, label:'Excretas'},
            {source:'Pred', target:'Soil', value: 1.0, label:'Restos'},
            {source:'Soil', target:'Deco', value: 3.2, label:'Sustrato'},
            {source:'Deco', target:'Soil', value: 2.6, label:'Mineralización'},
            {source:'Soil', target:'Water', value: 1.2, label:'Lixiviación'}
          ]
        };
      }
      return {
        nodes: [
          {id:'Atm',   name:'Atmósfera (CO2, N2)', group:'Atmósfera'},
          {id:'Veg',   name:'Vegetación (cafeto y sombra)', group:'Vegetación'},
          {id:'Herb',  name:'Herbívoros', group:'Fauna'},
          {id:'Pred',  name:'Depredadores', group:'Fauna'},
          {id:'Micro', name:'Microbiota (descomp. y simbiosis)', group:'Microbiota'},
          {id:'MO',    name:'Suelo: materia orgánica (MO)', group:'Suelo'},
          {id:'NH4',   name:'Suelo: NH4+', group:'Suelo'},
          {id:'NO3',   name:'Suelo: NO3-', group:'Suelo'},
          {id:'PO4',   name:'Suelo: PO4---', group:'Suelo'},
          {id:'Water', name:'Agua (N, P disueltos)', group:'Agua'}
        ],
        links: [
          {source:'Atm',  target:'Veg',   value: 6.2, label:'Fotosíntesis (C)'},
          {source:'Veg',  target:'Atm',   value: 2.6, label:'Respiración (CO2)'},
          {source:'Veg',  target:'MO',    value: 3.1, label:'Restos (C, N, P)'},
          {source:'MO',   target:'Micro', value: 2.4, label:'Sustrato'},
          {source:'Micro',target:'NH4',   value: 1.6, label:'Mineralización (N)'},
          {source:'NH4',  target:'NO3',   value: 1.2, label:'Nitrificación'},
          {source:'NO3',  target:'Veg',   value: 1.1, label:'Asimilación (N)'},
          {source:'PO4',  target:'Veg',   value: 0.9, label:'Asimilación (P)'},
          {source:'Veg',  target:'Herb',  value: 2.2, label:'Consumo'},
          {source:'Herb', target:'Pred',  value: 1.6, label:'Depredación'},
          {source:'Herb', target:'MO',    value: 0.9, label:'Excretas'},
          {source:'Pred', target:'MO',    value: 0.6, label:'Restos'},
          {source:'NO3',  target:'Water', value: 0.8, label:'Lixiviación'},
          {source:'PO4',  target:'Water', value: 0.6, label:'Arrastre de P'},
          {source:'MO',   target:'PO4',   value: 0.7, label:'Liberación (P)'},
          {source:'Atm',  target:'Water', value: 0.4, label:'Intercambio (N)'}
        ]
      };
    }

    function sankeyColors(group){
      const map = {
        'Atmósfera': 'rgba(70, 120, 190, .85)',
        'Vegetación': 'rgba(90, 160, 110, .85)',
        'Fauna': 'rgba(140, 140, 140, .85)',
        'Microbiota': 'rgba(160, 90, 170, .85)',
        'Suelo': 'rgba(120, 95, 70, .85)',
        'Agua': 'rgba(55, 160, 220, .85)'
      };
      return map[group] || 'rgba(11,16,32,.55)';
    }

    function stageSize(){
      const rect = sankeyStage.getBoundingClientRect();
      let W = Math.floor(rect.width);
      let H = Math.floor(rect.height);

      if(W < 10) W = Math.floor(sankeyStage.clientWidth || 900);
      if(H < 10){
        const cs = getComputedStyle(sankeyStage);
        const h = parseFloat(cs.height || '0');
        H = (h && h > 10) ? Math.floor(h) : 560;
      }
      return {W, H};
    }

    function pointerXY(evt, W, H){
      const r = sankeyStage.getBoundingClientRect();
      const cx = (evt && evt.clientX) || (evt && evt.touches && evt.touches[0] && evt.touches[0].clientX) || 0;
      const cy = (evt && evt.clientY) || (evt && evt.touches && evt.touches[0] && evt.touches[0].clientY) || 0;
      const x = cx - r.left;
      const y = cy - r.top;
      return {
        x: Math.max(10, Math.min(W - 340, x + 12)),
        y: Math.max(10, Math.min(H - 120, y + 12))
      };
    }

    function showSankeyError(msg){
      sErr.textContent = msg;
      sErr.classList.add('show');
    }
    function clearSankeyError(){
      sErr.classList.remove('show');
      sErr.textContent = '';
    }

    function renderSankey(mode){
      if(!window.d3 || !d3.sankey || !d3.sankeyLinkHorizontal){
        showSankeyError('No se pudo cargar la librería del diagrama (D3 Sankey). Revisa conexión o recarga la página.');
        return;
      }
      clearSankeyError();

      const prev = sankeyStage.querySelector('svg.__sankey');
      if(prev) prev.remove();

      const {W, H} = stageSize();
      if(W < 50 || H < 50){
        showSankeyError('El contenedor del diagrama no tiene tamaño. Intenta recargar la página.');
        return;
      }

      // Estado inicial
      sLocked = false;
      sLockKey = null;
      badge('ninguno');
      hideTip();

      const data = sankeyData(mode);

      const nodes = data.nodes.map(d => ({...d}));
      const indexById = new Map(nodes.map((d,i)=>[d.id, i]));
      const links = data.links.map(d => ({
        ...d,
        source: indexById.get(d.source),
        target: indexById.get(d.target)
      }));

      const svg = d3.select(sankeyStage)
        .append('svg')
        .attr('class','__sankey')
        .attr('width', W)
        .attr('height', H)
        .attr('viewBox', `0 0 ${W} ${H}`)
        .attr('preserveAspectRatio','xMidYMid meet')
        .style('display','block');

      svg.append('rect')
        .attr('x',0).attr('y',0).attr('width',W).attr('height',H)
        .attr('fill','transparent')
        .on('click', () => {
          sLocked = false;
          sLockKey = null;
          dimNone();
          badge('ninguno');
          hideTip();
        });

      const sk = d3.sankey()
        .nodeWidth(16)
        .nodePadding(18)
        .extent([[24, 22], [W - 24, H - 24]]);

      const graph = sk({ nodes, links });

      const linkG = svg.append('g').attr('class','links');
      const nodeG = svg.append('g').attr('class','nodes');

      const linkPath = linkG.selectAll('path')
        .data(graph.links)
        .enter()
        .append('path')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('fill','none')
        .attr('stroke', d => {
          const g1 = d.source.group;
          const g2 = d.target.group;
          return (g1 === g2) ? sankeyColors(g1) : 'rgba(11,16,32,.38)';
        })
        .attr('stroke-opacity', 0.45)
        .attr('stroke-linecap','round')
        .attr('stroke-width', d => Math.max(2.5, d.width))
        .style('cursor','pointer');

      const node = nodeG.selectAll('g')
        .data(graph.nodes)
        .enter()
        .append('g')
        .style('cursor','pointer');

      node.append('rect')
        .attr('x', d => d.x0)
        .attr('y', d => d.y0)
        .attr('height', d => Math.max(12, d.y1 - d.y0))
        .attr('width', d => d.x1 - d.x0)
        .attr('rx', 6)
        .attr('fill', d => sankeyColors(d.group))
        .attr('fill-opacity', 0.92)
        .attr('stroke', 'rgba(11,16,32,.18)');

      node.append('text')
        .attr('x', d => d.x0 < W/2 ? d.x1 + 10 : d.x0 - 10)
        .attr('y', d => (d.y0 + d.y1) / 2)
        .attr('dy', '0.32em')
        .attr('text-anchor', d => d.x0 < W/2 ? 'start' : 'end')
        .attr('font-family', 'Outfit, Inter, system-ui')
        .attr('font-weight', 800)
        .attr('font-size', 12)
        .attr('fill', 'rgba(11,16,32,.86)')
        .text(d => d.name);

      function dimNone(){
        node.selectAll('rect')
          .attr('fill-opacity', 0.92)
          .attr('stroke', 'rgba(11,16,32,.18)');

        linkPath
          .attr('stroke-opacity', 0.45)
          .attr('stroke', d => {
            const g1 = d.source.group;
            const g2 = d.target.group;
            return (g1 === g2) ? sankeyColors(g1) : 'rgba(11,16,32,.38)';
          });
      }

      function highlightNode(n){
        const key = 'node:' + n.id;
        if(sLocked && sLockKey !== key) return;

        node.selectAll('rect')
          .attr('fill-opacity', d => d.id === n.id ? 0.98 : 0.18)
          .attr('stroke', d => d.id === n.id ? 'rgba(45,160,220,.55)' : 'rgba(11,16,32,.10)');

        linkPath
          .attr('stroke-opacity', d => (d.source.id === n.id || d.target.id === n.id) ? 0.86 : 0.12)
          .attr('stroke', d => (d.source.id === n.id || d.target.id === n.id) ? 'rgba(45,160,220,.80)' : 'rgba(11,16,32,.28)');

        badge(n.name);
      }

      function highlightLink(l){
        const key = 'link:' + l.source.id + '->' + l.target.id;
        if(sLocked && sLockKey !== key) return;

        node.selectAll('rect')
          .attr('fill-opacity', d => (d.id === l.source.id || d.id === l.target.id) ? 0.92 : 0.18)
          .attr('stroke', d => (d.id === l.source.id || d.id === l.target.id) ? 'rgba(45,160,220,.55)' : 'rgba(11,16,32,.10)');

        linkPath
          .attr('stroke-opacity', d => (d === l) ? 0.95 : 0.10)
          .attr('stroke', d => (d === l) ? 'rgba(45,160,220,.82)' : 'rgba(11,16,32,.28)');

        badge(l.label || 'flujo');
      }

      node
        .on('mousemove touchmove', (event, d) => {
          if(sLocked && sLockKey && sLockKey !== ('node:' + d.id)) return;
          const p = pointerXY(event, W, H);
          setTip(
            `<strong>${d.name}</strong><br>` +
            `<span style="color:rgba(11,16,32,.72)">Grupo:</span> ${d.group}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Magnitud:</span> ${Math.round(d.value*10)/10}`,
            p.x, p.y
          );
        })
        .on('mouseenter touchstart', (event, d) => { highlightNode(d); })
        .on('mouseleave', () => { if(!sLocked){ dimNone(); badge('ninguno'); hideTip(); } })
        .on('click', (event, d) => {
          event.stopPropagation();
          const key = 'node:' + d.id;
          if(sLocked && sLockKey === key){
            sLocked = false; sLockKey = null; dimNone(); badge('ninguno'); hideTip();
          }else{
            sLocked = true; sLockKey = key; highlightNode(d);
          }
        });

      linkPath
        .on('mousemove touchmove', (event, d) => {
          if(sLocked && sLockKey && sLockKey !== ('link:' + d.source.id + '->' + d.target.id)) return;
          const p = pointerXY(event, W, H);
          setTip(
            `<strong>${d.label || 'Flujo'}</strong><br>` +
            `<span style="color:rgba(11,16,32,.72)">Desde:</span> ${d.source.name}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Hacia:</span> ${d.target.name}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Intensidad:</span> ${Math.round(d.value*10)/10}`,
            p.x, p.y
          );
        })
        .on('mouseenter touchstart', (event, d) => { highlightLink(d); })
        .on('mouseleave', () => { if(!sLocked){ dimNone(); badge('ninguno'); hideTip(); } })
        .on('click', (event, d) => {
          event.stopPropagation();
          const key = 'link:' + d.source.id + '->' + d.target.id;
          if(sLocked && sLockKey === key){
            sLocked = false; sLockKey = null; dimNone(); badge('ninguno'); hideTip();
          }else{
            sLocked = true; sLockKey = key; highlightLink(d);
          }
        });

      dimNone();
    }

    function redrawSankey(){
      try{
        renderSankey(sMode === 'simple' ? 'simple' : 'cafe');
      }catch(e){
        showSankeyError('Ocurrió un error al dibujar el diagrama. Recarga la página.');
      }
    }

    function initSankeyWithRetries(){
      let tries = 0;
      const maxTries = 14;

      const tick = () => {
        tries++;
        const ok = (window.d3 && d3.sankey && d3.sankeyLinkHorizontal);
        if(ok){
          // defer un frame para asegurar layout
          requestAnimationFrame(() => {
            redrawSankey();
            if(!ro){
              ro = new ResizeObserver(() => {
                clearTimeout(window.__skT);
                window.__skT = setTimeout(redrawSankey, 100);
              });
              ro.observe(sankeyStage);
            }
          });
          return;
        }
        if(tries >= maxTries){
          showSankeyError('No se pudo cargar D3 Sankey. Revisa conexión o recarga.');
          return;
        }
        setTimeout(tick, 250);
      };
      tick();
    }

    document.getElementById('sTabCafe').addEventListener('click', () => {
      sMode = 'cafe';
      document.getElementById('sTabCafe').classList.add('active');
      document.getElementById('sTabSimple').classList.remove('active');
      redrawSankey();
    });
    document.getElementById('sTabSimple').addEventListener('click', () => {
      sMode = 'simple';
      document.getElementById('sTabSimple').classList.add('active');
      document.getElementById('sTabCafe').classList.remove('active');
      redrawSankey();
    });
    document.getElementById('sReset').addEventListener('click', () => redrawSankey());

    window.addEventListener('load', initSankeyWithRetries);

    /* =========================================================
       B) MAPA MENTAL (Markmap)
       ========================================================= */
    const md = `
# 1.2 Cadenas alimenticias o tróficas
## Ideas clave
- Flujo de energía (direccional)
- Transformación y reciclaje de materia (C, N, P)
## Niveles tróficos
- Productores
  - Plantas, algas, fitoplancton
- Consumidor primario
  - Herbívoros
- Consumidor secundario / terciario
  - Carnívoros
- Depredador superior
  - Control poblacional
- Descomponedores y simbiontes
  - Hongos y bacterias
  - Mutualismos
## Procesos
- Fotosíntesis y respiración
- Mineralización
- Nitrificación
- Asimilación radicular
- Lixiviación y escorrentía
## Interpretación
- Efecto en cascada si baja un nivel
- Manejo del suelo influye en ciclos
    `.trim();

    let mm = null;
    let expanded = true;

    function safeRender(){
      const fallback = document.getElementById('mapFallback');
      try{
        if (!window.markmap || !window.markmap.Transformer || !window.markmap.Markmap) return false;
        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const { root } = transformer.transform(md);
        const svg = document.getElementById('mindmap');
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        mm = Markmap.create(svg, { autoFit: true, duration: 220 }, root);
        expanded = true;
        fallback.classList.remove('show');
        return true;
      }catch(e){
        fallback.classList.add('show');
        return true;
      }
    }

    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      const done = safeRender();
      if (done || tries >= 12){
        clearInterval(timer);
        if (!mm) document.getElementById('mapFallback').classList.add('show');
      }
    }, 350);

    document.getElementById('btnFit').addEventListener('click', () => mm && mm.fit());
    document.getElementById('btnToggle').addEventListener('click', () => {
      if (!mm) return;
      if (expanded) mm.foldAll(); else mm.unfoldAll();
      expanded = !expanded;
    });
    document.getElementById('btnReset').addEventListener('click', () => safeRender());

    /* =========================================================
       C) SIMULADOR (mismo juego, más vistoso)
       ========================================================= */
    const kProd = document.getElementById('kProd');
    const kHerb = document.getElementById('kHerb');
    const kPred = document.getElementById('kPred');
    const kRecycle = document.getElementById('kRecycle');

    const vProd = document.getElementById('vProd');
    const vHerb = document.getElementById('vHerb');
    const vPred = document.getElementById('vPred');
    const vRec  = document.getElementById('vRec');

    const simScore = document.getElementById('simScore');
    const simFeedback = document.getElementById('simFeedback');

    const svP = document.getElementById('svP');
    const svH = document.getElementById('svH');
    const svD = document.getElementById('svD');
    const svN = document.getElementById('svN');
    const sbP = document.getElementById('sbP');
    const sbH = document.getElementById('sbH');
    const sbD = document.getElementById('sbD');
    const sbN = document.getElementById('sbN');

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    function fmt(x){ return (Math.round(x*100)/100).toFixed(2); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function syncVals(){
      vProd.textContent = fmt(parseFloat(kProd.value));
      vHerb.textContent = fmt(parseFloat(kHerb.value));
      vPred.textContent = fmt(parseFloat(kPred.value));
      vRec.textContent  = fmt(parseFloat(kRecycle.value));
    }
    [kProd,kHerb,kPred,kRecycle].forEach(el => el.addEventListener('input', syncVals));
    syncVals();

    let running = false;
    let t = 0;

    const MAX_POINTS = 220;
    let seriesP = [];
    let seriesH = [];
    let seriesD = [];

    let P=0.70, H=0.42, D=0.26, N=0.55;

    function setStat(elV, elB, value){
      elV.textContent = fmt(value);
      const w = clamp((value/1.2)*100, 0, 100);
      elB.style.width = w.toFixed(1) + '%';
    }
    function refreshStats(){
      setStat(svP, sbP, P);
      setStat(svH, sbH, H);
      setStat(svD, sbD, D);
      setStat(svN, sbN, N);
    }

    function resetSim(){
      running = false;
      t = 0;
      P=0.70; H=0.42; D=0.26; N=0.55;
      seriesP = [];
      seriesH = [];
      seriesD = [];
      for(let i=0;i<60;i++) stepSim(false);
      draw();
      refreshStats();
      simScore.textContent = 'Estado: detenido';
      simFeedback.className = 'result';
      simFeedback.textContent = 'Presiona Iniciar. Luego aplica un evento y ajusta controles para recuperar estabilidad.';
    }

    function shockDrought(){
      N = Math.max(0.02, N * 0.55);
      P = Math.max(0.02, P * 0.78);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: sequía. Bajó producción primaria y nutrientes. Ajusta parámetros para recuperar estabilidad.';
      draw(); refreshStats();
    }
    function shockPredLoss(){
      D = Math.max(0.01, D * 0.35);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: pérdida de depredadores. Observa si suben herbívoros y cae vegetación.';
      draw(); refreshStats();
    }

    function stepSim(push=true){
      const kp = parseFloat(kProd.value);
      const kh = parseFloat(kHerb.value);
      const kd = parseFloat(kPred.value);
      const kr = parseFloat(kRecycle.value);

      const recycle = kr * (0.30*P + 0.22*H + 0.18*D);
      const uptake  = 0.55 * kp * P;
      N = clamp(N + recycle - uptake, 0.00, 1.20);

      const growP = kp * (0.55 + 0.75*N) * P * (1.05 - P);
      const eatP  = kh * (0.68) * H * P;
      P = clamp(P + growP - eatP, 0.00, 1.20);

      const growH = kh * (0.58) * H * P;
      const predH = kd * (0.70) * D * H;
      const starv = 0.18 * H * (0.45 - P);
      H = clamp(H + growH - predH - Math.max(0, starv), 0.00, 1.20);

      const growD = kd * (0.50) * D * H;
      const costD = 0.22 * D;
      D = clamp(D + growD - costD, 0.00, 1.20);

      if(push){
        seriesP.push(P);
        seriesH.push(H);
        seriesD.push(D);
        if(seriesP.length > MAX_POINTS){
          seriesP.shift(); seriesH.shift(); seriesD.shift();
        }
      }
      t++;
    }

    function assess(){
      const okP = P > 0.25 && P < 1.05;
      const okH = H > 0.12 && H < 0.95;
      const okD = D > 0.06 && D < 0.80;

      if(okP && okH && okD){
        simScore.textContent = 'Estado: estable';
        simFeedback.className = 'result ok';
        simFeedback.textContent =
          'Estado estable. Productores sostienen herbívoros; depredadores controlan herbívoros; reciclaje mantiene nutrientes.';
      }else{
        simScore.textContent = 'Estado: inestable';
        simFeedback.className = 'result no';
        let msg = 'Estado inestable. ';
        if(P <= 0.08) msg += 'Productores casi colapsan. ';
        if(H >= 1.05) msg += 'Herbívoros demasiado altos. ';
        if(D <= 0.03) msg += 'Depredadores casi ausentes. ';
        if(D >= 0.95) msg += 'Depredadores demasiado altos. ';
        msg += 'Ajusta parámetros y observa la gráfica.';
        simFeedback.textContent = msg;
      }
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Fondo
      const bg = ctx.createLinearGradient(0,0,0,h);
      bg.addColorStop(0, 'rgba(255,255,255,.70)');
      bg.addColorStop(1, 'rgba(255,255,255,.50)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      const padL = 42, padR = 14, padT = 14, padB = 28;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      // Ejes + grid
      ctx.strokeStyle = 'rgba(11,16,32,.18)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + plotH);
      ctx.lineTo(padL + plotW, padT + plotH);
      ctx.stroke();

      ctx.fillStyle = 'rgba(11,16,32,.68)';
      ctx.font = '12px Inter, system-ui';
      for(let i=0;i<=6;i++){
        const v = (1.2/6)*i;
        const y = padT + plotH - (v/1.2)*plotH;
        ctx.strokeStyle = 'rgba(11,16,32,.10)';
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
        ctx.fillText(v.toFixed(1), 8, y+4);
      }

      // Título / leyenda
      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '13px Outfit, Inter, system-ui';
      ctx.fillText('Productores', padL + 6, padT + 14);
      ctx.fillText('Herbívoros',  padL + 150, padT + 14);
      ctx.fillText('Depredadores',padL + 278, padT + 14);

      // Colores
      const colP = 'rgba(50,170,120,.90)';
      const colH = 'rgba(210,150,80,.90)';
      const colD = 'rgba(120,120,120,.95)';

      function plotWithFill(series, color){
        if(series.length < 2) return;
        // fill
        ctx.beginPath();
        for(let i=0;i<series.length;i++){
          const x = padL + (i/(MAX_POINTS-1))*plotW;
          const y = padT + plotH - (series[i]/1.2)*plotH;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.lineTo(padL + plotW, padT + plotH);
        ctx.lineTo(padL, padT + plotH);
        ctx.closePath();

        const g = ctx.createLinearGradient(0,padT,0,padT+plotH);
        g.addColorStop(0, color.replace('0.90','0.18').replace('0.95','0.16'));
        g.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = g;
        ctx.fill();

        // stroke
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for(let i=0;i<series.length;i++){
          const x = padL + (i/(MAX_POINTS-1))*plotW;
          const y = padT + plotH - (series[i]/1.2)*plotH;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      plotWithFill(seriesP, colP);
      plotWithFill(seriesH, colH);
      plotWithFill(seriesD, colD);

      // valores
      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '12px Inter, system-ui';
      ctx.fillText('P=' + fmt(P) + '   H=' + fmt(H) + '   D=' + fmt(D) + '   N=' + fmt(N), padL, padT + plotH + 20);
    }

    function tick(){
      if(!running) return;
      stepSim(true);
      draw();
      refreshStats();
      if(t % 18 === 0) assess();
      requestAnimationFrame(tick);
    }

    document.getElementById('btnStart').addEventListener('click', () => {
      if(!running){
        running = true;
        simScore.textContent = 'Estado: ejecutando';
        requestAnimationFrame(tick);
      }
    });
    document.getElementById('btnPause').addEventListener('click', () => {
      running = false;
      simScore.textContent = 'Estado: pausado';
    });
    document.getElementById('btnShock1').addEventListener('click', shockDrought);
    document.getElementById('btnShock2').addEventListener('click', shockPredLoss);
    document.getElementById('btnSimReset').addEventListener('click', resetSim);

    resetSim();
  </script>
</body>
</html>
