<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1.2 Las cadenas alimenticias o tr√≥ficas</title>

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0a2a4a;
      --card:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.14);
      --stroke:rgba(255,255,255,.18);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.58);
      --ok:#41d693;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --shadow: 0 20px 50px rgba(0,0,0,.35);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(125,211,252,.30), transparent 60%),
        radial-gradient(900px 650px at 85% 18%, rgba(167,139,250,.26), transparent 60%),
        radial-gradient(900px 650px at 60% 90%, rgba(65,214,147,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{max-width:1120px;margin:0 auto;padding:22px 16px 60px}

    header{
      display:flex;gap:16px;align-items:flex-start;justify-content:space-between;
      padding:18px 18px 14px;
      border:1px solid var(--stroke);
      border-radius: calc(var(--r) + 6px);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .kicker{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted2)}
    h1{margin:6px 0 8px;font-size:28px;line-height:1.1}
    .subtitle{margin:0;color:var(--muted);max-width:70ch}
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid var(--stroke);color:var(--text);
      background:rgba(255,255,255,.08);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;transition:.18s transform,.18s background,.18s border-color;
      text-decoration:none;display:inline-flex;gap:8px;align-items:center;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.26)}
    .btn:active{transform:translateY(0)}
    .btn.primary{
      border-color:rgba(125,211,252,.55);
      background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.10));
    }
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid var(--stroke);
      color:var(--muted);background:rgba(255,255,255,.06);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    main{margin-top:16px;display:grid;gap:14px}
    .card{
      border:1px solid var(--stroke);
      border-radius: calc(var(--r) + 6px);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:18px}
    .muted{color:var(--muted);margin:0}
    .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width: 960px){ .grid2{grid-template-columns:1fr} }

    .callout{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(255,255,255,.06);
      border-radius:var(--r);
      padding:12px;
      color:var(--muted);
    }
    .callout strong{color:var(--text)}

    /* ========= FOOD CHAIN UI ========= */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;user-select:none;
      transition:.18s transform,.18s background,.18s border-color;
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);
    }
    .tab:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .tab.active{
      color:var(--text);
      border-color:rgba(125,211,252,.55);
      background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.10));
    }

    .chainStage{
      position:relative;
      border-radius: calc(var(--r) + 6px);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.10) 1px, transparent 1px) 0 0/22px 22px,
        rgba(0,0,0,.10);
      padding:14px;
    }

    .chainRow{
      display:grid;
      grid-template-columns: repeat(4, minmax(170px, 1fr));
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .chainRow{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 520px){
      .chainRow{grid-template-columns:1fr}
    }

    .node{
      position:relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      padding:14px 14px 12px;
      cursor:pointer;
      transition: .18s transform, .18s border-color, .18s background;
      min-height:98px;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      outline:none;
    }
    .node:hover{transform:translateY(-2px);border-color:rgba(255,255,255,.28)}
    .node:active{transform:translateY(-1px)}
    .node .t{font-weight:800;letter-spacing:.2px}
    .node .s{margin-top:6px;color:var(--muted);font-size:13px}
    .node .badge{
      position:absolute;top:10px;right:10px;
      font-size:11px;color:rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:6px 8px;border-radius:999px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .badge .mini{width:8px;height:8px;border-radius:50%}
    .mini.p{background:#86efac}
    .mini.c1{background:#fde68a}
    .mini.c2{background:#fca5a5}
    .mini.top{background:#93c5fd}

    .node.active{
      border-color:rgba(125,211,252,.70);
      background:linear-gradient(180deg, rgba(125,211,252,.22), rgba(255,255,255,.06));
      transform: translateY(-2px);
    }

    .flowSvg{
      width:100%;
      height:72px;
      margin:10px 0 8px;
    }
    .flowSvg path{
      stroke:rgba(255,255,255,.38);
      stroke-width:3.2;
      fill:none;
      stroke-linecap:round;
      stroke-dasharray: 6 8;
      animation: dash 1.2s linear infinite;
      opacity:.65;
    }
    .flowSvg .on{stroke:rgba(125,211,252,.85);opacity:1}
    .flowSvg marker path{fill:rgba(125,211,252,.85)}
    @keyframes dash{to{stroke-dashoffset:-28}}

    .chainInfo{
      display:grid;gap:10px;
      grid-template-columns: 1.1fr .9fr;
      align-items:start;
      margin-top:10px;
    }
    @media (max-width: 960px){ .chainInfo{grid-template-columns:1fr} }
    .panel{
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      background:rgba(255,255,255,.06);
      padding:12px;
    }
    .panel h3{margin:0 0 6px;font-size:14px}
    .panel p{margin:0;color:var(--muted);line-height:1.45}
    .legend{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:8px
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--muted);font-size:12px;
    }
    .tag .sw{width:10px;height:10px;border-radius:50%}
    .sw.p{background:#86efac}
    .sw.c1{background:#fde68a}
    .sw.c2{background:#fca5a5}
    .sw.top{background:#93c5fd}

    /* ========= MIND MAP ========= */
    .mindWrap{
      width:100%;
      height: 680px;
      border-radius: calc(var(--r) + 6px);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.10) 1px, transparent 1px) 0 0/22px 22px,
        rgba(0,0,0,.10);
      position:relative;
    }
    .mindTopBar{
      position:absolute;top:12px;left:12px;right:12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      pointer-events:none;
    }
    .mindTopBar .left, .mindTopBar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mindTopBar .btn, .mindTopBar .pill{pointer-events:auto}
    .mindSvg{width:100%;height:100%}
    .mmEdge{stroke:rgba(255,255,255,.32);stroke-width:2.4;fill:none}
    .mmNode{cursor:pointer}
    .mmCard{
      fill: rgba(255,255,255,.10);
      stroke: rgba(255,255,255,.18);
      stroke-width:1.2;
    }
    .mmNode:hover .mmCard{stroke: rgba(125,211,252,.70)}
    .mmText{fill:rgba(255,255,255,.92);font-size:12px;font-weight:700}
    .mmSub{fill:rgba(255,255,255,.68);font-size:11px;font-weight:600}
    .mmHint{
      position:absolute;bottom:12px;left:12px;right:12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color:var(--muted2);font-size:12px;
      pointer-events:none;
    }
    .kbd{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      padding:2px 8px;border-radius:10px;
      font-size:12px;color:var(--muted);
    }

    /* ========= GAME ========= */
    .gameGrid{display:grid;grid-template-columns: .9fr 1.1fr;gap:14px}
    @media (max-width: 960px){ .gameGrid{grid-template-columns:1fr} }
    .bank, .zones{
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      background:rgba(255,255,255,.06);
      padding:12px;
      min-height:180px;
    }
    .bankHead, .zonesHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .bankHead h3,.zonesHead h3{margin:0;font-size:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.90);
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:700;
      cursor:grab; user-select:none;
      display:inline-flex;align-items:center;gap:8px;
      transition:.14s transform,.14s background,.14s border-color;
    }
    .chip:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.28)}
    .chip:active{cursor:grabbing;transform:translateY(0)}
    .chip.selected{outline:2px solid rgba(125,211,252,.7);outline-offset:2px}
    .chip .tiny{width:8px;height:8px;border-radius:50%}
    .tiny.p{background:#86efac}
    .tiny.c1{background:#fde68a}
    .tiny.c2{background:#fca5a5}
    .tiny.c3{background:#c4b5fd}
    .tiny.top{background:#93c5fd}
    .tiny.d{background:#fda4af}

    .zoneGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 620px){ .zoneGrid{grid-template-columns:1fr} }
    .zone{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.10);
      border-radius: 16px;
      padding:10px;
      min-height:98px;
    }
    .zone.dragOver{border-color:rgba(125,211,252,.75);background:rgba(125,211,252,.10)}
    .zoneTitle{
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      font-weight:900;font-size:12px;color:rgba(255,255,255,.92);
      margin-bottom:8px;
    }
    .zoneTitle span{color:var(--muted2);font-weight:700}
    .zoneChips{display:flex;gap:8px;flex-wrap:wrap}
    .resultLine{
      margin-top:10px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color:var(--muted);
    }
    .score{
      font-weight:900;color:rgba(255,255,255,.92);
      padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
    }
    .toast{
      margin-top:10px;
      border-radius:16px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--muted);
    }
    .toast.ok{border-color:rgba(65,214,147,.5);background:rgba(65,214,147,.10);color:rgba(255,255,255,.92)}
    .toast.bad{border-color:rgba(255,107,107,.55);background:rgba(255,107,107,.10);color:rgba(255,255,255,.92)}

    footer{margin-top:14px;text-align:center;color:var(--muted2);font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">M√≥dulo 1 ¬∑ Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tr√≥ficas</h1>
        <p class="subtitle">
          Explora una cadena tr√≥fica ‚Äútipo libro‚Äù (con flujo animado), un mapa mental que s√≠ se ve (sin librer√≠as externas)
          y un mini-juego que funciona en PC y celular.
        </p>
      </div>

      <nav class="nav">
        <a class="btn" href="index.html">üè† Inicio</a>
        <a class="btn" href="1-1.html">‚¨ÖÔ∏è Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Pendiente: 1-3.html'); return false;">‚û°Ô∏è Siguiente (1.3)</a>
      </nav>
    </header>

    <main class="stack">

      <!-- TEOR√çA -->
      <section class="card">
        <h2>Conceptualizaci√≥n (clara y breve)</h2>
        <div class="grid2">
          <div class="callout">
            <p style="margin:0;line-height:1.5">
              Una <strong>cadena alimenticia</strong> (o tr√≥fica) muestra <strong>qui√©n se come a qui√©n</strong> y c√≥mo fluye
              la <strong>energ√≠a</strong> desde los <strong>productores</strong> hacia consumidores y depredadores.
              En cada paso se pierde energ√≠a (por eso los niveles superiores son menos abundantes).
            </p>
          </div>
          <div class="callout">
            <p style="margin:0;line-height:1.5">
              <strong>Niveles tr√≥ficos</strong>:
              productores ‚Üí consumidores (primario, secundario, terciario, cuaternario) ‚Üí depredador superior.
              Adem√°s, los <strong>descomponedores</strong> reciclan materia org√°nica y devuelven nutrientes.
            </p>
          </div>
        </div>
      </section>

      <!-- CADENA TR√ìFICA PRO (TAB + FLOW) -->
      <section class="card">
        <h2>Cadena tr√≥fica interactiva ‚Äútipo libro‚Äù</h2>
        <p class="muted">Toca o haz clic en un nivel para resaltar el flujo de energ√≠a y leer su explicaci√≥n.</p>

        <div class="tabs" role="tablist" aria-label="Modos de cadena tr√≥fica">
          <button class="tab active" id="tabTer" role="tab" aria-selected="true">üåø Terrestre</button>
          <button class="tab" id="tabAcu" role="tab" aria-selected="false">üåä Acu√°tica</button>
          <span class="pill"><span class="dot ok"></span> Flujo animado activo</span>
        </div>

        <div class="chainStage" aria-live="polite">
          <!-- Flow line -->
          <svg class="flowSvg" viewBox="0 0 1000 70" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                <path d="M 0 0 L 10 5 L 0 10 z"></path>
              </marker>
            </defs>
            <path id="flow1" d="M 70 35 L 330 35" marker-end="url(#arrowHead)"></path>
            <path id="flow2" d="M 350 35 L 610 35" marker-end="url(#arrowHead)"></path>
            <path id="flow3" d="M 630 35 L 930 35" marker-end="url(#arrowHead)"></path>
          </svg>

          <div class="chainRow" id="chainRow"></div>

          <div class="chainInfo">
            <div class="panel">
              <h3 id="infoTitle">Selecciona un nivel</h3>
              <p id="infoText">Elige una tarjeta para ver su rol tr√≥fico y c√≥mo afecta a los dem√°s niveles.</p>

              <div class="legend">
                <span class="tag"><span class="sw p"></span> Productor</span>
                <span class="tag"><span class="sw c1"></span> Consumidor primario</span>
                <span class="tag"><span class="sw c2"></span> Consumidor secundario</span>
                <span class="tag"><span class="sw top"></span> Depredador superior</span>
              </div>
            </div>

            <div class="panel">
              <h3>Idea clave</h3>
              <p>
                La energ√≠a fluye en una sola direcci√≥n. Si un nivel baja mucho (por ejemplo, productores),
                los niveles superiores se ven afectados ‚Äúen cascada‚Äù.
              </p>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="btnChainReset">‚Ü∫ Reiniciar resaltado</button>
            <button class="btn ghost" id="btnChainHint">üí° ¬øQu√© debo ver?</button>
          </div>

          <div class="toast" id="chainToast" style="display:none"></div>
        </div>
      </section>

      <!-- MAPA MENTAL (SIN LIBRER√çAS EXTERNAS) -->
      <section class="card">
        <h2>Mapa mental (s√≠ se ve) ‚Äî colapsable</h2>
        <p class="muted">Haz clic en un nodo para expandir/colapsar. Arrastra el fondo para mover, rueda para zoom (PC).</p>

        <div class="mindWrap" id="mindWrap">
          <div class="mindTopBar">
            <div class="left">
              <span class="pill"><span class="dot warn"></span> Click = expandir/colapsar</span>
              <span class="pill"><span class="dot ok"></span> Drag = mover</span>
            </div>
            <div class="right">
              <button class="btn" id="mmFit">Ajustar</button>
              <button class="btn" id="mmReset">Reiniciar</button>
              <button class="btn primary" id="mmFull">Pantalla completa</button>
            </div>
          </div>

          <svg class="mindSvg" id="mindSvg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
            <g id="mmViewport"></g>
          </svg>

          <div class="mmHint">
            <div>Tip: colapsa ramas para ‚Äúestudiar por partes‚Äù.</div>
            <div>
              <span class="kbd">Ctrl</span> + <span class="kbd">+</span> / <span class="kbd">-</span> (zoom) ¬∑
              <span class="kbd">Esc</span> (salir de pantalla completa)
            </div>
          </div>
        </div>
      </section>

      <!-- JUEGO: CLASIFICAR NIVELES (DRAG + TAP) -->
      <section class="card">
        <h2>Mini-juego / Evaluaci√≥n (funciona)</h2>
        <p class="muted">
          Arrastra en PC o usa modo tocar en celular: toca un chip para seleccionarlo y luego toca el nivel destino.
        </p>

        <div class="gameGrid">
          <div class="bank">
            <div class="bankHead">
              <h3>Banco de conceptos</h3>
              <span class="pill" id="inputModePill"><span class="dot ok"></span> Modo: detectando‚Ä¶</span>
            </div>
            <div class="chips" id="bankChips"></div>

            <div class="resultLine">
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn primary" id="btnEval">‚úÖ Evaluar</button>
                <button class="btn" id="btnUndo">‚Ü©Ô∏è Deshacer</button>
                <button class="btn" id="btnClear">üßπ Reiniciar</button>
              </div>
              <div class="score" id="score">Resultado: 0/0</div>
            </div>

            <div class="toast" id="gameToast" style="display:none"></div>
          </div>

          <div class="zones">
            <div class="zonesHead">
              <h3>Coloca en su nivel tr√≥fico</h3>
              <span class="pill"><span class="dot warn"></span> Tip: productores = base</span>
            </div>

            <div class="zoneGrid" id="zoneGrid"></div>
          </div>
        </div>
      </section>

      <footer>
        1.2 ¬∑ Cadenas tr√≥ficas ‚Äî versi√≥n mejorada (sin dependencias externas para el mapa mental)
      </footer>
    </main>
  </div>

  <script>
    /***********************
     * UTIL
     ***********************/
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

    /***********************
     * CADENA TR√ìFICA PRO
     ***********************/
    const CHAIN = {
      terrestrial: [
        { id:"P",  label:"Productores", sub:"Plantas", badge:"Productor", colorClass:"p",
          infoTitle:"Productores (aut√≥trofos)",
          infoText:"Producen su propio alimento con energ√≠a solar. Son la base: sin productores, la cadena colapsa."
        },
        { id:"C1", label:"Consumidor primario", sub:"Orugas", badge:"C. primario", colorClass:"c1",
          infoTitle:"Consumidor primario",
          infoText:"Se alimenta de productores (herb√≠voro). Transfiere energ√≠a al siguiente nivel."
        },
        { id:"C2", label:"Consumidor secundario", sub:"Sapos y ranas", badge:"C. secundario", colorClass:"c2",
          infoTitle:"Consumidor secundario",
          infoText:"Come al consumidor primario. Ayuda a controlar poblaciones y mantiene el equilibrio."
        },
        { id:"TOP",label:"Depredador superior", sub:"Serpientes / Gavilanes", badge:"Superior", colorClass:"top",
          infoTitle:"Depredador superior",
          infoText:"Est√° arriba de la cadena. Depende de que existan niveles inferiores estables."
        },
      ],
      aquatic: [
        { id:"P",  label:"Productores acu√°ticos", sub:"Algas / fitoplancton", badge:"Productor", colorClass:"p",
          infoTitle:"Productores acu√°ticos",
          infoText:"Algas y fitoplancton: base energ√©tica del ecosistema acu√°tico."
        },
        { id:"C1", label:"Consumidores", sub:"Organismos / peces peque√±os", badge:"C. primario", colorClass:"c1",
          infoTitle:"Consumidores (primarios)",
          infoText:"Se alimentan de productores acu√°ticos (plancton/organismos peque√±os)."
        },
        { id:"C2", label:"Peces m√°s grandes", sub:"Depredaci√≥n", badge:"C. secundario", colorClass:"c2",
          infoTitle:"Consumidores (secundarios)",
          infoText:"Depredan sobre peces peque√±os/organismos: concentran energ√≠a hacia niveles altos."
        },
        { id:"TOP",label:"Aves", sub:"Consumen biota acu√°tica", badge:"Superior", colorClass:"top",
          infoTitle:"Depredadores superiores",
          infoText:"Aves u otros depredadores: consumen peces y conectan ambientes acu√°ticos y terrestres."
        },
      ]
    };

    let mode = "terrestrial";
    let activeId = null;

    const chainRow = $("#chainRow");
    const infoTitle = $("#infoTitle");
    const infoText  = $("#infoText");
    const flowPaths = [$("#flow1"), $("#flow2"), $("#flow3")];
    const chainToast = $("#chainToast");

    function renderChain(){
      chainRow.innerHTML = "";
      CHAIN[mode].forEach(n=>{
        const div = document.createElement("button");
        div.className = "node";
        div.type = "button";
        div.setAttribute("data-id", n.id);
        div.innerHTML = `
          <span class="badge"><span class="mini ${n.colorClass}"></span>${n.badge}</span>
          <div class="t">${n.label}</div>
          <div class="s">${n.sub}</div>
        `;
        div.addEventListener("click", ()=>setActive(n.id));
        chainRow.appendChild(div);
      });
      setActive(null);
    }

    function setActive(id){
      activeId = id;
      $$(".node", chainRow).forEach(el=>{
        el.classList.toggle("active", el.dataset.id === id);
      });

      // Flujo: si selecciona nivel, resaltamos desde productor hasta ese nivel
      const order = ["P","C1","C2","TOP"];
      const idx = id ? order.indexOf(id) : -1;

      flowPaths.forEach((p,i)=>{
        const on = idx >= 0 && i < idx;
        p.classList.toggle("on", on);
      });

      if(!id){
        infoTitle.textContent = "Selecciona un nivel";
        infoText.textContent = "Elige una tarjeta para ver su rol tr√≥fico y c√≥mo afecta a los dem√°s niveles.";
        return;
      }

      const node = CHAIN[mode].find(x=>x.id===id);
      infoTitle.textContent = node.infoTitle;
      infoText.textContent  = node.infoText;
    }

    function toast(el, msg, kind=""){
      el.style.display = "block";
      el.className = "toast" + (kind ? " " + kind : "");
      el.textContent = msg;
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 3600);
    }

    $("#tabTer").addEventListener("click", ()=>{
      mode="terrestrial";
      $("#tabTer").classList.add("active"); $("#tabAcu").classList.remove("active");
      $("#tabTer").setAttribute("aria-selected","true"); $("#tabAcu").setAttribute("aria-selected","false");
      renderChain();
      toast(chainToast, "Modo terrestre: productores ‚Üí orugas ‚Üí sapos/ranas ‚Üí depredador superior.", "");
    });

    $("#tabAcu").addEventListener("click", ()=>{
      mode="aquatic";
      $("#tabAcu").classList.add("active"); $("#tabTer").classList.remove("active");
      $("#tabAcu").setAttribute("aria-selected","true"); $("#tabTer").setAttribute("aria-selected","false");
      renderChain();
      toast(chainToast, "Modo acu√°tico: algas/fitoplancton ‚Üí peces peque√±os ‚Üí peces grandes ‚Üí aves.", "");
    });

    $("#btnChainReset").addEventListener("click", ()=>setActive(null));
    $("#btnChainHint").addEventListener("click", ()=>{
      toast(chainToast, "Tip: selecciona un nivel y mira c√≥mo se iluminan las flechas desde el productor.", "");
    });

    renderChain();

    /***********************
     * MAPA MENTAL (SVG + COLLAPSE + PAN/ZOOM)
     ***********************/
    const mindData = {
      id:"root",
      title:"Cadenas tr√≥ficas (1.2)",
      sub:"Flujo de energ√≠a y materia",
      open:true,
      children:[
        {
          id:"def",
          title:"¬øQu√© representa?",
          sub:"qui√©n se come a qui√©n",
          open:true,
          children:[
            { id:"ene", title:"Energ√≠a", sub:"fluye en una direcci√≥n", open:true,
              children:[
                { id:"perd", title:"P√©rdida por nivel", sub:"menos energ√≠a arriba", open:true, children:[] }
              ]
            },
            { id:"mat", title:"Materia", sub:"se recicla", open:true,
              children:[
                { id:"deco", title:"Descomponedores", sub:"devuelven nutrientes", open:true, children:[] }
              ]
            }
          ]
        },
        {
          id:"niv",
          title:"Niveles tr√≥ficos",
          sub:"roles en la cadena",
          open:true,
          children:[
            { id:"prod", title:"Productores", sub:"plantas / algas / fitoplancton", open:true, children:[] },
            { id:"c1", title:"Consumidor primario", sub:"herb√≠voro", open:true, children:[] },
            { id:"c2", title:"Consumidor secundario", sub:"carn√≠voro", open:true, children:[] },
            { id:"c3", title:"Consumidor terciario", sub:"m√°s depredaci√≥n", open:true, children:[] },
            { id:"c4", title:"Cuaternario", sub:"depredador superior", open:true, children:[] },
          ]
        },
        {
          id:"ej",
          title:"Ejemplos",
          sub:"terrestre y acu√°tico",
          open:true,
          children:[
            { id:"ejt", title:"Terrestre", sub:"plantas ‚Üí orugas ‚Üí sapos/ranas ‚Üí serpientes/gavilanes", open:true, children:[] },
            { id:"eja", title:"Acu√°tico", sub:"algas ‚Üí peces peque√±os ‚Üí peces grandes ‚Üí aves", open:true, children:[] }
          ]
        },
        {
          id:"red",
          title:"Red tr√≥fica",
          sub:"muchas cadenas conectadas",
          open:true,
          children:[
            { id:"impact", title:"Cambios", sub:"efecto cascada", open:true, children:[] }
          ]
        }
      ]
    };

    const svg = $("#mindSvg");
    const viewport = $("#mmViewport");

    let mmState = {
      scale: 1,
      tx: 0,
      ty: 0,
      dragging: false,
      lastX: 0,
      lastY: 0,
      nodeIndex: new Map()
    };

    function buildIndex(node){
      mmState.nodeIndex.set(node.id, node);
      (node.children||[]).forEach(buildIndex);
    }
    buildIndex(mindData);

    function visibleChildren(node){
      if(!node.open) return [];
      return node.children || [];
    }

    // Layout: simple left-to-right tree
    function layoutTree(root){
      const levels = []; // depth -> nodes
      function walk(n, depth){
        if(!levels[depth]) levels[depth] = [];
        levels[depth].push(n);
        visibleChildren(n).forEach(ch=>walk(ch, depth+1));
      }
      walk(root,0);

      // assign y by ordering in traversal (compact but readable)
      let yCounter = 0;
      const pos = new Map();

      function assign(n, depth){
        const kids = visibleChildren(n);
        if(kids.length===0){
          const y = yCounter;
          yCounter += 1;
          pos.set(n.id, {x: depth, y});
          return y;
        }
        const ys = kids.map(k=>assign(k, depth+1));
        const y = (Math.min(...ys)+Math.max(...ys))/2;
        pos.set(n.id, {x: depth, y});
        return y;
      }
      assign(root,0);

      return pos;
    }

    function mmRender(){
      viewport.innerHTML = "";

      const pos = layoutTree(mindData);
      const nodes = [];
      pos.forEach((v,k)=>nodes.push({id:k, ...v}));
      // scale layout to viewBox
      const X_STEP = 260;
      const Y_STEP = 86;

      function nodeCenter(id){
        const p = pos.get(id);
        return { x: p.x * X_STEP + 80, y: p.y * Y_STEP + 80 };
      }

      // edges
      function drawEdges(n){
        visibleChildren(n).forEach(ch=>{
          const a = nodeCenter(n.id);
          const b = nodeCenter(ch.id);
          const path = document.createElementNS("http://www.w3.org/2000/svg","path");
          path.setAttribute("class","mmEdge");
          // gentle curve
          const mx = (a.x + b.x)/2;
          path.setAttribute("d", `M ${a.x+120} ${a.y} C ${mx} ${a.y}, ${mx} ${b.y}, ${b.x-120} ${b.y}`);
          viewport.appendChild(path);
          drawEdges(ch);
        });
      }
      drawEdges(mindData);

      // nodes
      function drawNodes(n){
        const {x,y} = nodeCenter(n.id);
        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("class","mmNode");
        g.setAttribute("transform", `translate(${x},${y})`);
        g.setAttribute("data-id", n.id);

        const w = 320;
        const h = 56;

        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("class","mmCard");
        rect.setAttribute("x", -w/2);
        rect.setAttribute("y", -h/2);
        rect.setAttribute("rx", 16);
        rect.setAttribute("ry", 16);
        rect.setAttribute("width", w);
        rect.setAttribute("height", h);

        const t1 = document.createElementNS("http://www.w3.org/2000/svg","text");
        t1.setAttribute("class","mmText");
        t1.setAttribute("x", -w/2 + 16);
        t1.setAttribute("y", -6);
        t1.textContent = n.title;

        const t2 = document.createElementNS("http://www.w3.org/2000/svg","text");
        t2.setAttribute("class","mmSub");
        t2.setAttribute("x", -w/2 + 16);
        t2.setAttribute("y", 14);
        t2.textContent = n.sub || "";

        // indicator
        const kids = (n.children||[]).length;
        if(kids>0){
          const badge = document.createElementNS("http://www.w3.org/2000/svg","text");
          badge.setAttribute("class","mmSub");
          badge.setAttribute("x", w/2 - 18);
          badge.setAttribute("y", 4);
          badge.setAttribute("text-anchor","end");
          badge.textContent = n.open ? "‚àí" : "+";
          g.appendChild(badge);
        }

        g.appendChild(rect);
        g.appendChild(t1);
        g.appendChild(t2);

        g.addEventListener("click",(e)=>{
          e.stopPropagation();
          if((n.children||[]).length===0) return;
          n.open = !n.open;
          mmRender();
        });

        viewport.appendChild(g);

        visibleChildren(n).forEach(drawNodes);
      }
      drawNodes(mindData);

      applyTransform();
    }

    function applyTransform(){
      viewport.setAttribute("transform", `translate(${mmState.tx},${mmState.ty}) scale(${mmState.scale})`);
    }

    // Pan
    svg.addEventListener("pointerdown",(e)=>{
      // allow dragging empty background
      if(e.target.closest && e.target.closest(".mmNode")) return;
      mmState.dragging = true;
      mmState.lastX = e.clientX;
      mmState.lastY = e.clientY;
      svg.setPointerCapture(e.pointerId);
    });
    svg.addEventListener("pointermove",(e)=>{
      if(!mmState.dragging) return;
      const dx = e.clientX - mmState.lastX;
      const dy = e.clientY - mmState.lastY;
      mmState.lastX = e.clientX;
      mmState.lastY = e.clientY;
      mmState.tx += dx;
      mmState.ty += dy;
      applyTransform();
    });
    svg.addEventListener("pointerup",(e)=>{
      mmState.dragging = false;
      try{ svg.releasePointerCapture(e.pointerId); }catch(_){}
    });

    // Zoom (wheel)
    svg.addEventListener("wheel",(e)=>{
      e.preventDefault();
      const delta = Math.sign(e.deltaY);
      const factor = delta>0 ? 0.92 : 1.08;
      mmState.scale = clamp(mmState.scale * factor, 0.55, 2.2);
      applyTransform();
    }, {passive:false});

    function mmReset(){
      mmState.scale = 1;
      mmState.tx = 0;
      mmState.ty = 0;
      // expand all
      (function openAll(n){
        n.open = true;
        (n.children||[]).forEach(openAll);
      })(mindData);
      mmRender();
    }

    function mmFit(){
      // simple fit: reset then small center shift
      mmState.scale = 0.95;
      mmState.tx = 60;
      mmState.ty = 40;
      applyTransform();
    }

    $("#mmReset").addEventListener("click", mmReset);
    $("#mmFit").addEventListener("click", mmFit);

    // Fullscreen
    const mindWrap = $("#mindWrap");
    $("#mmFull").addEventListener("click", async ()=>{
      try{
        if(!document.fullscreenElement){
          await mindWrap.requestFullscreen();
        }else{
          await document.exitFullscreen();
        }
      }catch(e){
        alert("Tu navegador no permiti√≥ pantalla completa.");
      }
    });
    window.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && document.fullscreenElement){
        document.exitFullscreen();
      }
    });

    mmRender();
    mmFit();

    /***********************
     * JUEGO (DRAG + TAP) ‚Äî CLASIFICAR NIVELES
     ***********************/
    const ITEMS = [
      { id:"it_prod", text:"Productor (aut√≥trofo)", level:"prod", dot:"p" },
      { id:"it_alg",  text:"Algas / fitoplancton", level:"prod", dot:"p" },
      { id:"it_pla",  text:"Plantas", level:"prod", dot:"p" },

      { id:"it_oru",  text:"Orugas (herb√≠voras)", level:"c1", dot:"c1" },
      { id:"it_pezp", text:"Peces peque√±os", level:"c1", dot:"c1" },
      { id:"it_c1",   text:"Consumidor primario", level:"c1", dot:"c1" },

      { id:"it_sap",  text:"Sapos y ranas", level:"c2", dot:"c2" },
      { id:"it_pezg", text:"Peces grandes", level:"c2", dot:"c2" },
      { id:"it_c2",   text:"Consumidor secundario", level:"c2", dot:"c2" },

      { id:"it_c3",   text:"Consumidor terciario", level:"c3", dot:"c3" },
      { id:"it_c4",   text:"Consumidor cuaternario", level:"top", dot:"top" },
      { id:"it_top",  text:"Depredador superior", level:"top", dot:"top" },
      { id:"it_ave",  text:"Aves", level:"top", dot:"top" },

      { id:"it_dec",  text:"Descomponedor", level:"deco", dot:"d" },
      { id:"it_bac",  text:"Bacterias (reciclan)", level:"deco", dot:"d" },
      { id:"it_hon",  text:"Hongos (reciclan)", level:"deco", dot:"d" },
    ];

    // Zones
    const ZONES = [
      { id:"prod", title:"Productores", hint:"Base energ√©tica" },
      { id:"c1", title:"Consumidor primario", hint:"Come productores" },
      { id:"c2", title:"Consumidor secundario", hint:"Come primarios" },
      { id:"c3", title:"Consumidor terciario", hint:"Come secundarios" },
      { id:"top", title:"Depredador superior", hint:"Nivel alto" },
      { id:"deco", title:"Descomponedores", hint:"Reciclan nutrientes" },
    ];

    const bankChips = $("#bankChips");
    const zoneGrid = $("#zoneGrid");
    const scoreEl = $("#score");
    const gameToast = $("#gameToast");
    const inputModePill = $("#inputModePill");

    let selectedChipId = null; // for tap mode
    let history = []; // undo
    const placements = new Map(); // chipId -> zoneId (or null)

    function shuffle(arr){
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function isTouchLike(){
      return window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
    }

    function setInputModeBadge(){
      const touch = isTouchLike();
      inputModePill.innerHTML = touch
        ? `<span class="dot warn"></span> Modo: tocar`
        : `<span class="dot ok"></span> Modo: arrastrar`;
    }
    setInputModeBadge();
    window.addEventListener("resize", setInputModeBadge);

    function chipEl(item){
      const el = document.createElement("div");
      el.className = "chip";
      el.setAttribute("draggable","true");
      el.dataset.id = item.id;
      el.innerHTML = `<span class="tiny ${item.dot}"></span>${item.text}`;

      el.addEventListener("dragstart",(e)=>{
        e.dataTransfer.setData("text/plain", item.id);
        e.dataTransfer.effectAllowed = "move";
      });

      // tap mode select
      el.addEventListener("click", ()=>{
        if(!isTouchLike()) return; // still allow click but we prioritize drag on desktop
        if(selectedChipId === item.id){
          selectedChipId = null;
        }else{
          selectedChipId = item.id;
        }
        refreshSelectionUI();
      });

      return el;
    }

    function refreshSelectionUI(){
      $$(".chip").forEach(c=>c.classList.toggle("selected", c.dataset.id===selectedChipId));
    }

    function buildZones(){
      zoneGrid.innerHTML = "";
      ZONES.forEach(z=>{
        const zone = document.createElement("div");
        zone.className = "zone";
        zone.dataset.zone = z.id;
        zone.innerHTML = `
          <div class="zoneTitle">
            <div>${z.title}</div>
            <span>${z.hint}</span>
          </div>
          <div class="zoneChips" id="zone_${z.id}"></div>
        `;

        zone.addEventListener("dragover",(e)=>{
          e.preventDefault();
          zone.classList.add("dragOver");
        });
        zone.addEventListener("dragleave",()=>zone.classList.remove("dragOver"));
        zone.addEventListener("drop",(e)=>{
          e.preventDefault();
          zone.classList.remove("dragOver");
          const id = e.dataTransfer.getData("text/plain");
          if(!id) return;
          placeChip(id, z.id);
        });

        // tap mode drop
        zone.addEventListener("click", ()=>{
          if(!isTouchLike()) return;
          if(!selectedChipId) return;
          placeChip(selectedChipId, z.id);
          selectedChipId = null;
          refreshSelectionUI();
        });

        zoneGrid.appendChild(zone);
      });
    }

    function buildBank(){
      bankChips.innerHTML = "";
      shuffle(ITEMS).forEach(item=>{
        placements.set(item.id, null);
        bankChips.appendChild(chipEl(item));
      });
      refreshScore(0, ITEMS.length);
    }

    function findChipElement(chipId){
      return $(`.chip[data-id="${chipId}"]`);
    }

    function placeChip(chipId, zoneId){
      const chip = findChipElement(chipId);
      if(!chip) return;

      const prevZone = placements.get(chipId);
      if(prevZone === zoneId) return;

      history.push({chipId, from: prevZone, to: zoneId});
      placements.set(chipId, zoneId);

      const target = $(`#zone_${zoneId}`);
      target.appendChild(chip);
      toast(gameToast, "Colocado. Cuando termines, presiona Evaluar.", "");
    }

    function undo(){
      const last = history.pop();
      if(!last) return;
      placements.set(last.chipId, last.from);

      const chip = findChipElement(last.chipId);
      if(!chip) return;

      if(last.from === null){
        bankChips.appendChild(chip);
      }else{
        $(`#zone_${last.from}`).appendChild(chip);
      }
      toast(gameToast, "Deshacer listo.", "");
    }

    function clearGame(){
      history = [];
      selectedChipId = null;
      placements.clear();
      buildZones();
      buildBank();
      toast(gameToast, "Reiniciado. Coloca los conceptos otra vez.", "");
    }

    function evaluate(){
      let correct = 0;
      for(const item of ITEMS){
        const placed = placements.get(item.id);
        if(placed && placed === item.level) correct++;
      }
      refreshScore(correct, ITEMS.length);

      if(correct === ITEMS.length){
        toast(gameToast, "¬°Perfecto! Todo correcto ‚úÖ", "ok");
      }else{
        toast(gameToast, `Vas ${correct}/${ITEMS.length}. Revisa: productores (base), consumidores por nivel, y descomponedores (reciclan).`, "bad");
      }
    }

    function refreshScore(c,t){
      scoreEl.textContent = `Resultado: ${c}/${t}`;
    }

    $("#btnUndo").addEventListener("click", undo);
    $("#btnClear").addEventListener("click", clearGame);
    $("#btnEval").addEventListener("click", evaluate);

    buildZones();
    buildBank();

    // Small polish: if user drags from a zone back to bank, allow drop on bank area
    bankChips.addEventListener("dragover",(e)=>e.preventDefault());
    bankChips.addEventListener("drop",(e)=>{
      e.preventDefault();
      const id = e.dataTransfer.getData("text/plain");
      if(!id) return;
      const prev = placements.get(id);
      history.push({chipId:id, from: prev, to: null});
      placements.set(id, null);
      const chip = findChipElement(id);
      if(chip) bankChips.appendChild(chip);
      toast(gameToast, "Devuelto al banco.", "");
    });
  </script>
</body>
</html>
