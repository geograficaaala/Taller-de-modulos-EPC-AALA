<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√≥dulo 1 ¬∑ 1.2 Cadenas alimenticias o tr√≥ficas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Markmap (mapa mental) -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16.1"></script>

  <style>
    :root{
      --ink:#0b1020;
      --muted:rgba(11,16,32,.72);
      --glass:rgba(255,255,255,.66);
      --stroke:rgba(11,16,32,.10);
      --shadow:0 18px 45px rgba(11,16,32,.16);
      --shadow-soft:0 10px 24px rgba(11,16,32,.12);
      --radius:24px;

      --good: rgba(30, 160, 90, .20);
      --bad: rgba(210, 70, 100, .18);
      --focus: rgba(45, 160, 220, .28);
      --focus2: rgba(255, 140, 200, .22);

      --blue: rgba(45,160,220,.90);
      --blue2: rgba(120,190,255,.90);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 760px at 12% 12%, rgba(185, 235, 255, .92), transparent 58%),
        radial-gradient(980px 760px at 84% 18%, rgba(160, 210, 255, .90), transparent 62%),
        radial-gradient(1200px 920px at 48% 96%, rgba(210, 245, 255, .88), transparent 58%),
        linear-gradient(135deg, #ecf9ff 0%, #e7f6ff 45%, #effbff 100%);
      min-height:100vh;
    }

    .wrap{ max-width: 1200px; margin: 0 auto; padding: 26px 18px 64px; }

    header{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap:wrap;
    }
    .kicker{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.3px;
    }
    h1{
      margin: 6px 0 0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: clamp(20px, 2.5vw, 28px);
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 92ch;
    }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      color: rgba(11,16,32,.92);
      font-weight: 800;
      text-decoration:none;
      font-size: 13px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg,
        rgba(185,235,255,.92),
        rgba(160,210,255,.90),
        rgba(210,245,255,.90)
      );
    }

    .stack{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h2{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    .twoCols{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .twoCols{ grid-template-columns: 1fr; }
    }
    .theory{
      line-height: 1.6;
      color: rgba(11,16,32,.90);
      font-size: 14px;
    }
    .theory p{ margin: 10px 0 0; }
    .theory ul{ margin: 10px 0 0 18px; }
    .theory li{ margin: 8px 0; }

    .callout{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      color: rgba(11,16,32,.86);
      font-size: 13px;
      line-height: 1.45;
    }

    /* =========================
       1) CADENA ‚ÄúTIPO LIBRO‚Äù
       ========================= */
    .chainWrap{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }

    .chainTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.45);
    }
    .tabRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .tab{
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, transform .08s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.82); border-color: rgba(11,16,32,.18); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      background: linear-gradient(135deg, rgba(185,235,255,.90), rgba(160,210,255,.84), rgba(210,245,255,.86));
      border-color: rgba(45,160,220,.24);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.58);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,16,32,.78);
      white-space: nowrap;
    }
    .dot{
      width: 9px; height: 9px;
      border-radius: 999px;
      background: rgba(45,160,220,.75);
    }

    .chainBody{ padding: 14px; }

    .chainGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 1020px){ .chainGrid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px){ .chainGrid{ grid-template-columns: 1fr; } }

    .cCard{
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.62);
      box-shadow: var(--shadow-soft);
      padding: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      position:relative;
      min-height: 120px;
    }
    .cCard:hover{ border-color: rgba(11,16,32,.18); background: rgba(255,255,255,.78); }
    .cCard:active{ transform: translateY(1px); }

    .cTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .cTitle{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 900;
      font-size: 14px;
      letter-spacing:.2px;
      line-height: 1.2;
    }
    .cTag{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.10);
      font-weight: 900;
      font-size: 12px;
      color: rgba(11,16,32,.78);
      background: rgba(255,255,255,.65);
      white-space: nowrap;
    }
    .cDesc{
      margin: 8px 0 0;
      color: rgba(11,16,32,.72);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .cCard.active{
      outline: 3px solid var(--focus);
      background: linear-gradient(135deg, rgba(185,235,255,.90), rgba(255,255,255,.78));
    }

    .chainArrows{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.50);
      padding: 10px;
      overflow:hidden;
    }
    .flowSvg{ width:100%; height: 72px; display:block; }
    .flowPath{
      stroke: rgba(11,16,32,.48);
      stroke-width: 3;
      fill:none;
      stroke-linecap: round;
      stroke-dasharray: 7 9;
      animation: dash 1.1s linear infinite;
      opacity: .55;
      marker-end: url(#arrowHead);
    }
    .flowPath.active{ stroke: rgba(45,160,220,.85); opacity: .95; }
    .flowPath.dim{ opacity: .18; }
    @keyframes dash { to { stroke-dashoffset: -32; } }

    .explainGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .explainGrid{ grid-template-columns: 1fr; } }
    .panel{
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      padding: 12px;
      box-shadow: var(--shadow-soft);
    }
    .panel h3{
      margin:0 0 6px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 900;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .panel p{
      margin:0;
      color: rgba(11,16,32,.78);
      font-size: 13px;
      line-height: 1.45;
    }

    /* =========================
       2) MAPA MENTAL (MARKMAP)
       ========================= */
    .mapWrap{
      width:100%;
      height: 720px;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      position: relative;
    }
    svg.markmap{ width:100%; height:100%; }
    .mapFallback{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: rgba(11,16,32,.75);
      background: rgba(255,255,255,.55);
    }
    .mapFallback.show{ display:flex; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    /* Modal fullscreen (mapa) */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(11,16,32,.35);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 1000;
    }
    .modal.open{ display:flex; }
    .modalBox{
      width: min(1200px, 96vw);
      height: min(860px, 92vh);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.70);
      box-shadow: 0 22px 60px rgba(11,16,32,.22);
      overflow:hidden;
      position:relative;
    }
    .modalTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      z-index: 2;
      pointer-events:none;
    }
    .modalTop .left, .modalTop .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; pointer-events:auto; }
    .modalMap{ width:100%; height:100%; }
    .modalMap svg.markmap{ width:100%; height:100%; }

    /* =========================
       3) JUEGO NUEVO: Conectar nodos
       ========================= */
    .gameWrap{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .gameTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.45);
    }

    .gameStage{
      padding: 12px;
    }
    .svgStage{
      width:100%;
      height: 430px;
      border-radius: 16px;
      border: 1px dashed rgba(11,16,32,.22);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.42);
      overflow:hidden;
    }
    @media (max-width: 620px){
      .svgStage{ height: 520px; }
    }

    .g-node circle{
      fill: rgba(255,255,255,.88);
      stroke: rgba(11,16,32,.18);
      stroke-width: 2.0;
    }
    .g-node text.title{
      font-family: Outfit, Inter, system-ui;
      font-weight: 900;
      font-size: 13px;
      fill: rgba(11,16,32,.92);
    }
    .g-node text.sub{
      font-family: Inter, system-ui;
      font-weight: 650;
      font-size: 12px;
      fill: rgba(11,16,32,.72);
    }
    .g-node:hover circle{
      stroke: rgba(45,160,220,.70);
    }
    .g-node.selected circle{
      stroke: rgba(45,160,220,.90);
      stroke-width: 3.0;
    }

    .g-edge{
      stroke: rgba(11,16,32,.62);
      stroke-width: 2.5;
      fill: none;
      marker-end: url(#gArrowHead);
      opacity: .92;
    }
    .g-edge.good{ stroke: rgba(30,160,90,.82); }
    .g-edge.bad{ stroke: rgba(210,70,100,.82); stroke-dasharray: 6 7; opacity:.95; }

    .result{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }
    .ok{ background: var(--good); border-color: rgba(30,160,90,.28); }
    .no{ background: var(--bad); border-color: rgba(210,70,100,.26); }

    footer{
      margin-top: 14px;
      color: rgba(11,16,32,.62);
      font-size: 12px;
      line-height: 1.4;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">M√≥dulo 1 ¬∑ Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tr√≥ficas</h1>
        <p class="subtitle">
          Cadenas tr√≥ficas con visual ‚Äútipo libro moderno‚Äù, mapa mental interactivo (Markmap) y un juego nuevo:
          <strong>conecta los niveles</strong> para construir la cadena correcta (terrestre y acu√°tica).
        </p>
      </div>
      <nav class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="1-1.html">Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Pendiente: 1-3.html'); return false;">Siguiente (1.3)</a>
      </nav>
    </header>

    <main class="stack">
      <!-- TEOR√çA -->
      <section class="card">
        <h2>Conceptualizaci√≥n t√©cnica y contexto local</h2>

        <div class="twoCols">
          <div class="theory">
            <p>
              Las <strong>cadenas alimenticias</strong> describen el <strong>flujo de energ√≠a</strong> (direccional) y el
              <strong>ciclado de materia</strong> (nutrientes) entre organismos. Se organizan por <strong>niveles tr√≥ficos</strong>.
            </p>
            <ul>
              <li><strong>Productores (aut√≥trofos):</strong> plantas, algas y fitoplancton; transforman energ√≠a solar en biomasa.</li>
              <li><strong>Consumidores (heter√≥trofos):</strong> primarios (herb√≠voros), secundarios/terciarios (carn√≠voros) seg√∫n su dieta.</li>
              <li><strong>Descomponedores:</strong> hongos y bacterias que degradan materia org√°nica y devuelven nutrientes al sistema.</li>
            </ul>
            <div class="callout">
              <strong>Idea clave:</strong> la energ√≠a disponible disminuye en cada paso, por eso los niveles superiores suelen ser menos abundantes.
            </div>
          </div>

          <div class="theory">
            <p>
              En Solol√° y la cuenca del Lago de Atitl√°n podemos pensar en dos marcos:
            </p>
            <ul>
              <li><strong>Terrestre:</strong> agroecosistemas, bosques y matorrales donde insectos, anfibios, reptiles y aves interact√∫an.</li>
              <li><strong>Acu√°tico:</strong> fitoplancton/algas ‚Üí consumidores (plancton/peces) ‚Üí niveles superiores, con reciclaje bacteriano.</li>
            </ul>
            <div class="callout">
              <strong>Pregunta gu√≠a:</strong> ¬øqu√© pasar√≠a con la cadena si bajan los productores (por sequ√≠a o contaminaci√≥n)?
            </div>
          </div>
        </div>
      </section>

      <!-- CADENA ‚ÄúTIPO LIBRO‚Äù -->
      <section class="card">
        <h2>Cadenas tr√≥ficas ‚Äútipo libro moderno‚Äù (interactivas)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Haz clic en un nivel para resaltar el flujo y leer una explicaci√≥n clara.
        </p>

        <div class="chainWrap">
          <div class="chainTabs">
            <div class="tabRow">
              <button class="tab active" id="tabTer" type="button">üåø Terrestre</button>
              <button class="tab" id="tabAcu" type="button">üåä Acu√°tica</button>
              <span class="pill"><span class="dot"></span> Flechas con flujo</span>
            </div>
            <div class="tabRow">
              <button class="btn" id="chainReset" type="button">Reiniciar</button>
            </div>
          </div>

          <div class="chainBody">
            <div class="chainGrid" id="chainGrid"></div>

            <div class="chainArrows" aria-hidden="true">
              <svg class="flowSvg" viewBox="0 0 1000 70" preserveAspectRatio="none">
                <defs>
                  <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                    <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(45,160,220,.85)"></path>
                  </marker>
                </defs>
                <path id="flow1" class="flowPath" d="M 70 35 L 330 35"></path>
                <path id="flow2" class="flowPath" d="M 350 35 L 610 35"></path>
                <path id="flow3" class="flowPath" d="M 630 35 L 930 35"></path>
              </svg>
            </div>

            <div class="explainGrid">
              <div class="panel">
                <h3 id="infoTitle">Selecciona un nivel</h3>
                <p id="infoText">Elige una tarjeta para ver su rol tr√≥fico y el efecto ‚Äúen cascada‚Äù.</p>
              </div>
              <div class="panel">
                <h3>Tip de estudio</h3>
                <p>
                  Para memorizar: <strong>base (productores)</strong> ‚Üí <strong>herb√≠voros</strong> ‚Üí <strong>carn√≠voros</strong> ‚Üí <strong>depredador superior</strong>.
                  Luego piensa d√≥nde entran los <strong>descomponedores</strong> (reciclaje).
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- MAPA MENTAL -->
      <section class="card">
        <h2>Mapa mental interactivo</h2>
        <p class="muted" style="margin:8px 0 0;">
          Si el mapa tarda en cargar, espera 1‚Äì2 segundos; el sistema reintenta autom√°ticamente.
        </p>

        <div class="mapWrap">
          <svg id="mindmap" class="markmap"></svg>
          <div class="mapFallback" id="mapFallback">
            <div>
              <strong>No se pudo cargar el mapa mental.</strong><br>
              Recarga la p√°gina (Ctrl+F5). El juego de abajo funciona aunque el mapa falle.
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnFit" type="button">Ajustar</button>
          <button class="btn" id="btnToggle" type="button">Expandir/Colapsar</button>
          <button class="btn" id="btnReset" type="button">Reiniciar mapa</button>
          <button class="btn primary" id="btnFull" type="button">Pantalla completa</button>
        </div>

        <div class="modal" id="modal">
          <div class="modalBox">
            <div class="modalTop">
              <div class="left">
                <span class="pill"><span class="dot"></span> Mapa en pantalla completa</span>
              </div>
              <div class="right">
                <button class="btn" id="modalFit" type="button">Ajustar</button>
                <button class="btn" id="modalToggle" type="button">Expandir/Colapsar</button>
                <button class="btn primary" id="modalClose" type="button">Cerrar</button>
              </div>
            </div>
            <div class="modalMap">
              <svg id="mindmapFull" class="markmap"></svg>
            </div>
          </div>
        </div>
      </section>

      <!-- JUEGO NUEVO -->
      <section class="card">
        <h2>Mini-juego nuevo: Conecta la cadena</h2>
        <p class="muted" style="margin:8px 0 0;">
          <strong>Instrucciones:</strong> toca/clic en un nodo y luego toca/clic en el siguiente para crear una flecha.
          Arma la cadena completa. Usa ‚ÄúEvaluar‚Äù para revisar.
        </p>

        <div class="gameWrap">
          <div class="gameTop">
            <div class="tabRow">
              <button class="tab active" id="gTabTer" type="button">üåø Terrestre</button>
              <button class="tab" id="gTabAcu" type="button">üåä Acu√°tica</button>
              <span class="pill"><span class="dot"></span> Conectar = aprender secuencia</span>
            </div>
            <div class="tabRow">
              <span class="pill" id="score">Conexiones: 0/3</span>
              <button class="btn" id="btnUndo" type="button">Deshacer</button>
              <button class="btn" id="btnClear" type="button">Reiniciar</button>
              <button class="btn primary" id="btnCheck" type="button">Evaluar</button>
            </div>
          </div>

          <div class="gameStage">
            <svg class="svgStage" id="gameSvg" viewBox="0 0 1000 430" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Juego de conectar cadena tr√≥fica">
              <defs>
                <marker id="gArrowHead" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
                  <path d="M 0 0 L 12 6 L 0 12 z" fill="rgba(11,16,32,.72)"></path>
                </marker>
              </defs>
              <g id="edgeLayer"></g>
              <g id="nodeLayer"></g>
            </svg>

            <div class="result" id="result">
              Consejo: empieza por <strong>Productores</strong> y conecta hacia consumidores hasta el depredador superior.
            </div>
          </div>
        </div>
      </section>

      <footer>
        EPC AALA ¬∑ M√≥dulo 1 ¬∑ 1.2 Cadenas tr√≥ficas
      </footer>
    </main>
  </div>

  <script>
    // =========================
    // 1) CADENA ‚ÄúTIPO LIBRO‚Äù (tarjetas + flechas)
    // =========================
    const chainData = {
      terrestrial: [
        { id:'P',   title:'Productores',           tag:'Base',      desc:'Plantas (energ√≠a solar ‚Üí biomasa).', info:'Producen alimento. Si bajan, toda la cadena se debilita.' },
        { id:'C1',  title:'Consumidor primario',   tag:'Herb√≠voro', desc:'Orugas / insectos herb√≠voros.',     info:'Se alimenta de productores y transfiere energ√≠a al siguiente nivel.' },
        { id:'C2',  title:'Consumidor secundario', tag:'Carn√≠voro', desc:'Sapos y ranas.',                   info:'Controla poblaciones de herb√≠voros y estabiliza el sistema.' },
        { id:'TOP', title:'Depredador superior',   tag:'Superior',  desc:'Serpientes / aves rapaces.',       info:'Depende de la estabilidad de los niveles inferiores.' }
      ],
      aquatic: [
        { id:'P',   title:'Productores acu√°ticos', tag:'Base',      desc:'Algas y fitoplancton.',            info:'Sostienen casi toda la energ√≠a del ecosistema acu√°tico.' },
        { id:'C1',  title:'Consumidores',          tag:'Primario',  desc:'Zooplancton / peces peque√±os.',    info:'Transforman producci√≥n primaria en biomasa consumible por niveles altos.' },
        { id:'C2',  title:'Peces m√°s grandes',     tag:'Secundario',desc:'Depredaci√≥n de peces peque√±os.',  info:'Concentran energ√≠a hacia depredadores superiores.' },
        { id:'TOP', title:'Aves / depredadores',   tag:'Superior',  desc:'Aves pisc√≠voras, etc.',           info:'Conectan ambientes (acu√°tico‚Äìterrestre) y dependen de la cadena completa.' }
      ]
    };

    const chainGrid = document.getElementById('chainGrid');
    const infoTitle = document.getElementById('infoTitle');
    const infoText  = document.getElementById('infoText');

    const flow1 = document.getElementById('flow1');
    const flow2 = document.getElementById('flow2');
    const flow3 = document.getElementById('flow3');
    const arrows = [flow1, flow2, flow3];

    let chainMode = 'terrestrial';
    let chainActive = null;

    function renderChain(){
      chainGrid.innerHTML = '';
      chainData[chainMode].forEach(n => {
        const el = document.createElement('div');
        el.className = 'cCard';
        el.id = `${chainMode === 'terrestrial' ? 't' : 'a'}Node${n.id}`;
        el.innerHTML = `
          <div class="cTop">
            <h3 class="cTitle">${n.title}</h3>
            <span class="cTag">${n.tag}</span>
          </div>
          <p class="cDesc">${n.desc}</p>
        `;
        el.addEventListener('click', () => setActiveChain(n.id));
        chainGrid.appendChild(el);
      });
      setActiveChain(null);
    }

    function setActiveChain(node){
      chainActive = node;
      document.querySelectorAll('.cCard').forEach(c => c.classList.remove('active'));
      if(node){
        const prefix = (chainMode === 'terrestrial') ? 't' : 'a';
        const card = document.getElementById(`${prefix}Node${node}`);
        if(card) card.classList.add('active');
      }

      arrows.forEach(a => { a.classList.remove('active'); a.classList.remove('dim'); });

      if(!node){
        infoTitle.textContent = 'Selecciona un nivel';
        infoText.textContent = 'Elige una tarjeta para ver su rol tr√≥fico y el efecto ‚Äúen cascada‚Äù.';
        arrows.forEach(a => a.classList.add('dim'));
        return;
      }

      const order = ['P','C1','C2','TOP'];
      const idx = order.indexOf(node);

      arrows.forEach(a => a.classList.add('dim'));
      for (let i=0;i<Math.max(1, idx);i++){
        if (arrows[i]){
          arrows[i].classList.remove('dim');
          arrows[i].classList.add('active');
        }
      }
      if (node === 'P'){
        arrows.forEach(a => a.classList.add('dim'));
        if (arrows[0]){
          arrows[0].classList.remove('dim');
          arrows[0].classList.add('active');
        }
      }

      const payload = chainData[chainMode].find(x => x.id === node);
      infoTitle.textContent = payload.title;
      infoText.textContent = payload.info;
    }

    document.getElementById('tabTer').addEventListener('click', () => {
      chainMode = 'terrestrial';
      document.getElementById('tabTer').classList.add('active');
      document.getElementById('tabAcu').classList.remove('active');
      renderChain();
    });
    document.getElementById('tabAcu').addEventListener('click', () => {
      chainMode = 'aquatic';
      document.getElementById('tabAcu').classList.add('active');
      document.getElementById('tabTer').classList.remove('active');
      renderChain();
    });
    document.getElementById('chainReset').addEventListener('click', () => setActiveChain(null));

    renderChain();

    // =========================
    // 2) MAPA MENTAL (Markmap) con protecci√≥n (no rompe el juego)
    // =========================
    const md = `
# 1.2 Cadenas alimenticias o tr√≥ficas
## ¬øQu√© representan?
- "Qui√©n se come a qui√©n"
- Flujo de energ√≠a (direccional)
- Materia se recicla (nutrientes)
## Niveles tr√≥ficos
- Productores (aut√≥trofos)
  - Plantas / algas / fitoplancton
- Consumidor primario
  - Herb√≠voros (ej. orugas, zooplancton)
- Consumidor secundario
  - Carn√≠voros (ej. sapos, peces medianos)
- Consumidor terciario / cuaternario
  - Depredadores (ej. serpientes, peces grandes)
- Depredador superior
  - Aves rapaces / aves pisc√≠voras
- Descomponedores
  - Hongos y bacterias ‚Üí devuelven nutrientes
## Ejemplos
- Terrestre
  - Plantas ‚Üí orugas ‚Üí sapos/ranas ‚Üí serpientes/aves
- Acu√°tico
  - Fitoplancton/algas ‚Üí zooplancton/peces peque√±os ‚Üí peces grandes ‚Üí aves
## Efecto en cascada
- Si baja la producci√≥n primaria (productores) afecta todo
- Alteraciones (contaminaci√≥n, p√©rdida de cobertura vegetal) modifican la red
    `.trim();

    let mm = null;
    let mmFull = null;
    let expanded = true;

    function safeRenderMap(targetSvgId, setInstance){
      const fallback = document.getElementById('mapFallback');
      try{
        if (!window.markmap || !window.markmap.Transformer || !window.markmap.Markmap) return false;

        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const { root } = transformer.transform(md);

        const svg = document.getElementById(targetSvgId);
        while (svg.firstChild) svg.removeChild(svg.firstChild);

        const inst = Markmap.create(svg, { autoFit: true, duration: 220 }, root);
        setInstance(inst);

        fallback.classList.remove('show');
        return true;
      } catch (e){
        fallback.classList.add('show');
        return true;
      }
    }

    // reintentos (por si CDN tarda)
    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      const done = safeRenderMap('mindmap', (inst)=>{ mm = inst; expanded = true; });
      if (done || tries >= 12) {
        clearInterval(timer);
        if (!mm) document.getElementById('mapFallback').classList.add('show');
      }
    }, 350);

    document.getElementById('btnFit').addEventListener('click', () => mm && mm.fit());
    document.getElementById('btnToggle').addEventListener('click', () => {
      if (!mm) return;
      if (expanded) mm.foldAll(); else mm.unfoldAll();
      expanded = !expanded;
    });
    document.getElementById('btnReset').addEventListener('click', () => {
      mm = null; expanded = true;
      safeRenderMap('mindmap', (inst)=>{ mm = inst; expanded = true; });
    });

    // Fullscreen modal
    const modal = document.getElementById('modal');
    document.getElementById('btnFull').addEventListener('click', () => {
      modal.classList.add('open');
      // render en el svg grande
      safeRenderMap('mindmapFull', (inst)=>{ mmFull = inst; });
      setTimeout(()=> mmFull && mmFull.fit(), 50);
    });
    document.getElementById('modalClose').addEventListener('click', () => modal.classList.remove('open'));
    document.getElementById('modalFit').addEventListener('click', () => mmFull && mmFull.fit());
    document.getElementById('modalToggle').addEventListener('click', () => {
      if (!mmFull) return;
      // usa el mismo estado "expanded" para simplificar
      if (expanded) mmFull.foldAll(); else mmFull.unfoldAll();
      expanded = !expanded;
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') modal.classList.remove('open');
    });

    // =========================
    // 3) JUEGO NUEVO: Conectar nodos (terrestre/acu√°tico)
    // =========================
    const gTabTer = document.getElementById('gTabTer');
    const gTabAcu = document.getElementById('gTabAcu');
    const nodeLayer = document.getElementById('nodeLayer');
    const edgeLayer = document.getElementById('edgeLayer');
    const scoreEl = document.getElementById('score');
    const resultEl = document.getElementById('result');

    const MODES = {
      terrestrial: {
        name: 'Terrestre',
        nodes: [
          { id:'P',   x:140, y:120, label:'Productores', sub:'Plantas' },
          { id:'C1',  x:420, y:120, label:'Consumidor primario', sub:'Orugas' },
          { id:'C2',  x:700, y:120, label:'Consumidor secundario', sub:'Sapos/ranas' },
          { id:'TOP', x:860, y:280, label:'Depredadores', sub:'Serpientes/aves' }
        ],
        requiredEdges: [['P','C1'], ['C1','C2'], ['C2','TOP']]
      },
      aquatic: {
        name: 'Acu√°tico',
        nodes: [
          { id:'P',   x:140, y:120, label:'Productores acu√°ticos', sub:'Algas/fitoplancton' },
          { id:'C1',  x:470, y:120, label:'Consumidores', sub:'Plancton/peces peque√±os' },
          { id:'C2',  x:780, y:120, label:'Peces m√°s grandes', sub:'Depredaci√≥n' },
          { id:'TOP', x:860, y:280, label:'Aves', sub:'Peces ‚Üí aves' }
        ],
        requiredEdges: [['P','C1'], ['C1','C2'], ['C2','TOP']]
      }
    };

    let gameMode = 'terrestrial';
    let selected = null;
    let edges = []; // {from,to, el, status}

    function setGameMode(m){
      gameMode = m;
      selected = null;
      edges = [];
      edgeLayer.innerHTML = '';
      nodeLayer.innerHTML = '';
      renderNodes();
      updateScore();
      resultEl.className = 'result';
      resultEl.innerHTML = `Consejo: empieza por <strong>Productores</strong> y conecta hacia consumidores hasta el depredador superior.`;
    }

    function updateScore(){
      const need = MODES[gameMode].requiredEdges.length;
      scoreEl.textContent = `Conexiones: ${edges.length}/${need}`;
    }

    function renderNodes(){
      const data = MODES[gameMode].nodes;
      data.forEach(n => {
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','g-node');
        g.setAttribute('data-id', n.id);
        g.setAttribute('transform', `translate(${n.x},${n.y})`);
        g.style.cursor = 'pointer';

        // card-ish node
        const r = 46;
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', 0);
        c.setAttribute('cy', 0);
        c.setAttribute('r', r);

        const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t1.setAttribute('class','title');
        t1.setAttribute('x', 0);
        t1.setAttribute('y', -6);
        t1.setAttribute('text-anchor','middle');
        t1.textContent = n.label;

        const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t2.setAttribute('class','sub');
        t2.setAttribute('x', 0);
        t2.setAttribute('y', 16);
        t2.setAttribute('text-anchor','middle');
        t2.textContent = n.sub;

        // fondo texto (mejor legibilidad en pantallas chicas)
        const labelBox = document.createElementNS('http://www.w3.org/2000/svg','rect');
        labelBox.setAttribute('x', -92);
        labelBox.setAttribute('y', -28);
        labelBox.setAttribute('width', 184);
        labelBox.setAttribute('height', 62);
        labelBox.setAttribute('rx', 14);
        labelBox.setAttribute('fill', 'rgba(255,255,255,.72)');
        labelBox.setAttribute('stroke', 'rgba(11,16,32,.10)');

        // manda el rect atr√°s del texto, pero sobre el c√≠rculo
        g.appendChild(c);
        g.appendChild(labelBox);
        g.appendChild(t1);
        g.appendChild(t2);

        g.addEventListener('click', () => onNodeClick(n.id));
        nodeLayer.appendChild(g);
      });
    }

    function nodePos(id){
      const n = MODES[gameMode].nodes.find(x => x.id === id);
      return n ? {x:n.x, y:n.y} : {x:0,y:0};
    }

    function edgeKey(a,b){ return `${a}->${b}`; }

    function hasEdge(a,b){
      return edges.some(e => e.from === a && e.to === b);
    }

    function markSelected(id){
      document.querySelectorAll('.g-node').forEach(el => el.classList.remove('selected'));
      if(!id) return;
      const el = document.querySelector(`.g-node[data-id="${id}"]`);
      if(el) el.classList.add('selected');
    }

    function addEdge(from, to){
      if(from === to) return;
      if(hasEdge(from,to)) return;

      const p1 = nodePos(from);
      const p2 = nodePos(to);

      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('class','g-edge');
      // curva suave
      const midX = (p1.x + p2.x) / 2;
      const d = `M ${p1.x} ${p1.y} C ${midX} ${p1.y}, ${midX} ${p2.y}, ${p2.x} ${p2.y}`;
      path.setAttribute('d', d);

      edgeLayer.appendChild(path);
      edges.push({from, to, el: path, status: 'pending'});

      updateScore();
    }

    function onNodeClick(id){
      if(!selected){
        selected = id;
        markSelected(selected);
        return;
      }
      // crear conexi√≥n
      addEdge(selected, id);
      selected = null;
      markSelected(null);
    }

    function undo(){
      const last = edges.pop();
      if(!last) return;
      try{ last.el.remove(); }catch(_){}
      updateScore();
      resultEl.className = 'result';
      resultEl.textContent = 'Deshiciste la √∫ltima conexi√≥n.';
    }

    function clearAll(){
      edges = [];
      edgeLayer.innerHTML = '';
      selected = null;
      markSelected(null);
      updateScore();
      resultEl.className = 'result';
      resultEl.innerHTML = 'Reiniciado. Consejo: conecta en orden desde productores.';
    }

    function check(){
      const required = MODES[gameMode].requiredEdges.map(e => edgeKey(e[0], e[1]));
      const made = edges.map(e => edgeKey(e.from, e.to));

      let correct = 0;
      edges.forEach(e => {
        const ok = required.includes(edgeKey(e.from, e.to));
        e.status = ok ? 'good' : 'bad';
        e.el.classList.remove('good','bad');
        e.el.classList.add(ok ? 'good' : 'bad');
        if(ok) correct++;
      });

      const missing = required.filter(r => !made.includes(r));
      const total = required.length;

      if(correct === total && missing.length === 0 && edges.length === total){
        resultEl.className = 'result ok';
        resultEl.innerHTML = `<strong>¬°Excelente!</strong> Construiste la cadena correcta. Ahora explica: ¬øqu√© pasa si disminuyen los productores?`;
        return;
      }

      resultEl.className = 'result no';
      const missTxt = missing.length
        ? `<br><strong>Te faltan:</strong> ${missing.map(x => x.replace('->',' ‚Üí ')).join(', ')}`
        : '';
      resultEl.innerHTML = `Vas en <strong>${correct}/${total}</strong>. Las l√≠neas <strong>rojas</strong> est√°n mal. Corrige y vuelve a evaluar.${missTxt}`;
    }

    gTabTer.addEventListener('click', () => {
      gTabTer.classList.add('active');
      gTabAcu.classList.remove('active');
      setGameMode('terrestrial');
    });
    gTabAcu.addEventListener('click', () => {
      gTabAcu.classList.add('active');
      gTabTer.classList.remove('active');
      setGameMode('aquatic');
    });

    document.getElementById('btnUndo').addEventListener('click', undo);
    document.getElementById('btnClear').addEventListener('click', clearAll);
    document.getElementById('btnCheck').addEventListener('click', check);

    setGameMode('terrestrial');
  </script>
</body>
</html>
