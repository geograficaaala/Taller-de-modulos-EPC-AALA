<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Módulo 1 · 1.2 Las cadenas alimenticias o tróficas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Markmap -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16.1"></script>

  <!-- D3 + Sankey (para diagrama tipo libro: flujo editorial) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

  <style>
    :root{
      --ink:#0b1020;
      --muted:rgba(11,16,32,.72);
      --glass:rgba(255,255,255,.66);
      --stroke:rgba(11,16,32,.10);
      --shadow:0 18px 45px rgba(11,16,32,.16);
      --shadow-soft:0 10px 24px rgba(11,16,32,.12);
      --radius:24px;

      --good: rgba(30, 160, 90, .20);
      --bad: rgba(210, 70, 100, .18);
      --focus: rgba(45, 160, 220, .28);
      --focus2: rgba(255, 140, 200, .22);

      --blue: rgba(45,160,220,.88);
      --pink: rgba(255, 140, 200, .82);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 760px at 12% 12%, rgba(175, 255, 216, .88), transparent 58%),
        radial-gradient(980px 760px at 82% 18%, rgba(170, 226, 255, .88), transparent 62%),
        radial-gradient(1200px 920px at 48% 96%, rgba(255, 191, 228, .76), transparent 58%),
        linear-gradient(135deg, #eafff4 0%, #e8f6ff 45%, #fff0f7 100%);
      min-height:100vh;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 26px 18px 64px;
    }

    header{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap:wrap;
    }
    .kicker{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.3px;
    }
    h1{
      margin: 6px 0 0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: clamp(20px, 2.5vw, 28px);
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 86ch;
    }
    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      color: rgba(11,16,32,.92);
      font-weight: 800;
      text-decoration:none;
      font-size: 13px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82));
    }

    .stack{
      margin-top: 14px;
      display:grid;
      gap: 14px;
    }
    .card{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h2{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    .twoCols{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .twoCols{ grid-template-columns: 1fr; }
    }
    .theory{
      line-height: 1.58;
      color: rgba(11,16,32,.90);
      font-size: 14px;
    }
    .theory p{ margin: 10px 0 0; }
    .theory ul{ margin: 10px 0 0 18px; }
    .theory li{ margin: 8px 0; }

    .callout{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      color: rgba(11,16,32,.86);
      font-size: 13px;
      line-height: 1.45;
    }

    /* ======= DIAGRAMA SANKEY (estilo editorial tipo libro) ======= */
    .diagramWrap{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background:
        linear-gradient(180deg, rgba(255,255,255,.60), rgba(255,255,255,.45));
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      position: relative;
    }
    .diagramTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{
      background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82));
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
    }

    .sankeyStage{
      height: 540px;
      width: 100%;
      position: relative;
    }
    @media (max-width: 820px){
      .sankeyStage{ height: 620px; }
    }

    .legendBox{
      position:absolute;
      right: 14px;
      top: 14px;
      width: min(360px, calc(100% - 28px));
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
    }
    .legendBox h3{
      margin:0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .legendList{ margin:0; padding-left: 16px; }
    .legendList li{
      margin: 6px 0;
      font-size: 12px;
      color: rgba(11,16,32,.80);
      line-height: 1.35;
    }

    .tooltip{
      position:absolute;
      pointer-events:none;
      z-index: 4;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .10s ease, transform .10s ease;
      max-width: 320px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(11,16,32,.86);
    }
    .tooltip strong{ font-weight: 900; }

    .hint{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }

    /* ======= MAPA MENTAL GRANDE (igual que 1-1) ======= */
    .mapWrap{
      width:100%;
      height: 720px;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      position: relative;
    }
    svg.markmap{ width:100%; height:100%; }
    .mapFallback{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: rgba(11,16,32,.75);
      background: rgba(255,255,255,.55);
    }
    .mapFallback.show{ display:flex; }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }

    /* ======= JUEGO NUEVO: Simulador de cascada trófica ======= */
    .simGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .simGrid{ grid-template-columns: 1fr; }
    }
    .panel{
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      padding: 12px;
    }
    .panel h3{
      margin: 0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .ctrl{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      margin: 10px 0;
    }
    .ctrl label{
      font-weight: 800;
      font-size: 13px;
      color: rgba(11,16,32,.86);
    }
    .ctrl .val{
      font-weight: 900;
      font-size: 13px;
      color: rgba(11,16,32,.86);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      min-width: 64px;
      text-align:center;
    }
    input[type="range"]{
      width: 100%;
      accent-color: rgba(45,160,220,.75);
    }
    .simBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }
    .canvasWrap{
      border-radius: 16px;
      border: 1px dashed rgba(11,16,32,.22);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.40);
      overflow:hidden;
      padding: 10px;
    }
    canvas{
      width: 100%;
      height: 320px;
      display:block;
    }
    .result{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }
    .ok{ background: var(--good); border-color: rgba(30,160,90,.28); }
    .no{ background: var(--bad); border-color: rgba(210,70,100,.26); }
    footer{
      margin-top: 14px;
      color: rgba(11,16,32,.62);
      font-size: 12px;
      line-height: 1.4;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">Módulo 1 · Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tróficas</h1>
        <p class="subtitle">
          Comprende el flujo de energía y nutrientes en una cadena trófica. Abajo tienes un diagrama editorial
          tipo libro (interactivo), un mapa mental y un mini-juego nuevo: simulador de cascada trófica.
        </p>
      </div>
      <nav class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="1-1.html">Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Luego hacemos 1-3.html.'); return false;">Siguiente</a>
      </nav>
    </header>

    <main class="stack">
      <!-- TEORÍA -->
      <section class="card">
        <h2>Contexto teórico (ampliado y técnico)</h2>

        <div class="twoCols">
          <div class="theory">
            <p>
              Una <strong>cadena alimenticia</strong> (o trófica) describe <strong>quién se alimenta de quién</strong> y cómo fluye la
              <strong>energía</strong> desde los <strong>productores</strong> hacia los consumidores y depredadores.
              A la vez, la <strong>materia</strong> (C, N, P) se transforma y se recicla mediante suelo y microbiota.
            </p>
            <ul>
              <li><strong>Productores:</strong> plantas/algas (capturan energía, generan biomasa).</li>
              <li><strong>Consumidores:</strong> primarios (herbívoros) y secundarios/terciarios (carnívoros).</li>
              <li><strong>Descomponedores y simbiontes:</strong> hongos/bacterias y mutualismos que sostienen la fertilidad y la absorción.</li>
            </ul>
            <div class="callout">
              <strong>Idea clave:</strong> en cada transferencia se pierde energía; por eso los niveles superiores suelen tener menor biomasa.
            </div>
          </div>

          <div class="theory">
            <p>
              En agroecosistemas (por ejemplo, café bajo sombra) la cadena trófica se integra con procesos de
              <strong>ciclos biogeoquímicos</strong> de C, N y P: fotosíntesis/respiración, mineralización, nitrificación,
              lixiviación y escorrentía, entre otros.
            </p>
            <div class="callout">
              <strong>Pregunta guía:</strong> ¿qué procesos aumentan o reducen la disponibilidad de N y P para las plantas?
            </div>
          </div>
        </div>
      </section>

      <!-- DIAGRAMA EDITORIAL TIPO LIBRO (SANKEY) -->
      <section class="card">
        <h2>Cadena trófica y ciclos de C, N y P (diagrama conceptual editorial)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Interacción: pasa el cursor o toca una banda/nodo para resaltar. Clic fija el resaltado; clic en fondo lo quita.
        </p>

        <div class="diagramWrap">
          <div class="diagramTop">
            <div class="tabs">
              <button class="tab active" id="sTabCafe" type="button">Sistema café (conceptual)</button>
              <button class="tab" id="sTabSimple" type="button">Cadena trófica simple</button>
              <span class="badge" id="sBadge">Resaltado: ninguno</span>
            </div>
            <div class="tabs">
              <button class="btn" id="sReset" type="button">Reiniciar</button>
            </div>
          </div>

          <div class="sankeyStage" id="sankeyStage">
            <div class="legendBox">
              <h3>Leyenda (lectura rápida)</h3>
              <ul class="legendList">
                <li><strong>Reservorios:</strong> atmósfera (CO2, N2), agua (N, P disueltos).</li>
                <li><strong>Vegetación:</strong> productores primarios (cafeto y sombra).</li>
                <li><strong>Fauna:</strong> herbívoros y depredadores (control poblacional).</li>
                <li><strong>Microbiota:</strong> descomposición y simbiosis (mejora absorción).</li>
                <li><strong>Suelo:</strong> materia orgánica (MO) y formas minerales (NH4+, NO3-, PO4---).</li>
                <li><strong>Bandas:</strong> representan flujos (energía/materia). El grosor indica intensidad relativa.</li>
              </ul>
            </div>
            <div class="tooltip" id="tip"></div>
          </div>

          <div class="hint" id="sHint">
            Sugerencia de estudio: identifica primero los productores, luego la ruta herbívoros-depredadores, y finalmente cómo suelo y microbiota cierran el ciclo.
          </div>
        </div>
      </section>

      <!-- MAPA -->
      <section class="card">
        <h2>Mapa mental interactivo</h2>
        <p class="muted" style="margin:8px 0 0;">Si no carga, revisa tu conexión o recarga la página. El simulador funciona aunque el mapa falle.</p>

        <div class="mapWrap">
          <svg id="mindmap" class="markmap"></svg>
          <div class="mapFallback" id="mapFallback">
            <div>
              <strong>No se pudo cargar el mapa mental.</strong><br>
              Recarga la página (Ctrl+F5). El simulador de abajo sigue funcionando.
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnFit">Ajustar</button>
          <button class="btn" id="btnToggle">Expandir/Colapsar</button>
          <button class="btn" id="btnReset">Reiniciar mapa</button>
        </div>
      </section>

      <!-- JUEGO NUEVO: Simulador -->
      <section class="card">
        <h2>Mini-juego / Evaluación: simulador de cascada trófica</h2>
        <p class="muted" style="margin:8px 0 0;">
          Ajusta parámetros y busca un equilibrio razonable. El objetivo es lograr una cadena estable:
          productores sostienen herbívoros, y depredadores controlan herbívoros sin colapsar el sistema.
        </p>

        <div class="simGrid">
          <div class="panel">
            <h3>Controles del sistema</h3>

            <div class="ctrl">
              <label for="kProd">Producción primaria (crecimiento de productores)</label>
              <span class="val" id="vProd">0.70</span>
            </div>
            <input id="kProd" type="range" min="0.20" max="1.20" step="0.01" value="0.70">

            <div class="ctrl">
              <label for="kHerb">Consumo herbívoro (presión sobre productores)</label>
              <span class="val" id="vHerb">0.60</span>
            </div>
            <input id="kHerb" type="range" min="0.20" max="1.20" step="0.01" value="0.60">

            <div class="ctrl">
              <label for="kPred">Depredación (control sobre herbívoros)</label>
              <span class="val" id="vPred">0.55</span>
            </div>
            <input id="kPred" type="range" min="0.20" max="1.20" step="0.01" value="0.55">

            <div class="ctrl">
              <label for="kRecycle">Reciclaje (descomposición y retorno de nutrientes)</label>
              <span class="val" id="vRec">0.45</span>
            </div>
            <input id="kRecycle" type="range" min="0.10" max="1.10" step="0.01" value="0.45">

            <div class="simBtns">
              <button class="btn" id="btnStart" type="button">Iniciar</button>
              <button class="btn" id="btnPause" type="button">Pausar</button>
              <button class="btn" id="btnShock1" type="button">Evento: sequía</button>
              <button class="btn" id="btnShock2" type="button">Evento: pérdida de depredadores</button>
              <button class="btn primary" id="btnSimReset" type="button">Reiniciar</button>
              <span class="badge" id="simScore">Estado: detenido</span>
            </div>

            <div class="result" id="simFeedback">
              Instrucción: presiona Iniciar y observa. Luego aplica un evento y ajusta controles para recuperar estabilidad.
            </div>
          </div>

          <div class="panel">
            <h3>Gráfica (poblaciones relativas)</h3>
            <div class="canvasWrap">
              <canvas id="chart" width="900" height="360"></canvas>
            </div>
            <div class="hint">
              Cómo leer: si productores caen a cero, todo colapsa. Si herbívoros explotan, bajan productores. Si depredadores son muy altos, herbívoros caen demasiado.
            </div>
          </div>
        </div>
      </section>

      <footer>
        EPC AALA · Módulo 1 · 1.2 Cadenas tróficas
      </footer>
    </main>
  </div>

  <script>
    // =========================================================
    // A) SANKEY (diagrama tipo libro)
    // =========================================================
    const sankeyStage = document.getElementById('sankeyStage');
    const tip = document.getElementById('tip');
    const sBadge = document.getElementById('sBadge');

    let sLocked = false;
    let sLockKey = null;

    function setTip(html, x, y){
      tip.innerHTML = html;
      tip.style.left = x + 'px';
      tip.style.top = y + 'px';
      tip.style.opacity = 1;
      tip.style.transform = 'translateY(0)';
    }
    function hideTip(){
      tip.style.opacity = 0;
      tip.style.transform = 'translateY(6px)';
    }
    function badge(text){ sBadge.textContent = 'Resaltado: ' + text; }

    function sankeyData(mode){
      if(mode === 'simple'){
        return {
          nodes: [
            {id:'Prod', name:'Productores', group:'Vegetación'},
            {id:'Herb', name:'Herbívoros', group:'Fauna'},
            {id:'Pred', name:'Depredadores', group:'Fauna'},
            {id:'Deco', name:'Descomponedores', group:'Microbiota'},
            {id:'Soil', name:'Suelo (MO y minerales)', group:'Suelo'},
            {id:'Water', name:'Agua (pérdidas)', group:'Agua'}
          ],
          links: [
            {source:'Prod', target:'Herb', value: 6.0, label:'Consumo'},
            {source:'Herb', target:'Pred', value: 4.2, label:'Depredación'},
            {source:'Prod', target:'Soil', value: 2.2, label:'Hojarasca'},
            {source:'Herb', target:'Soil', value: 1.4, label:'Excretas'},
            {source:'Pred', target:'Soil', value: 1.0, label:'Restos'},
            {source:'Soil', target:'Deco', value: 3.2, label:'Sustrato'},
            {source:'Deco', target:'Soil', value: 2.6, label:'Mineralización'},
            {source:'Soil', target:'Water', value: 1.2, label:'Lixiviación'}
          ],
          title: 'Cadena trófica simple (flujo conceptual)'
        };
      }

      // Sistema café conceptual, inspirado en el diagrama que mostraste (sin copiar texto literal)
      return {
        nodes: [
          {id:'Atm',   name:'Atmósfera (CO2, N2)', group:'Atmósfera'},
          {id:'Veg',   name:'Vegetación (cafeto y sombra)', group:'Vegetación'},
          {id:'Herb',  name:'Herbívoros', group:'Fauna'},
          {id:'Pred',  name:'Depredadores', group:'Fauna'},
          {id:'Micro', name:'Microbiota (descomp. y simbiosis)', group:'Microbiota'},
          {id:'MO',    name:'Suelo: materia orgánica (MO)', group:'Suelo'},
          {id:'NH4',   name:'Suelo: NH4+', group:'Suelo'},
          {id:'NO3',   name:'Suelo: NO3-', group:'Suelo'},
          {id:'PO4',   name:'Suelo: PO4---', group:'Suelo'},
          {id:'Water', name:'Agua (N, P disueltos)', group:'Agua'}
        ],
        links: [
          {source:'Atm',  target:'Veg',   value: 6.2, label:'Fotosíntesis (C)'},
          {source:'Veg',  target:'Atm',   value: 2.6, label:'Respiración (CO2)'},
          {source:'Veg',  target:'MO',    value: 3.1, label:'Hojarasca / restos (C, N, P)'},
          {source:'MO',   target:'Micro', value: 2.4, label:'Sustrato para descomposición'},
          {source:'Micro',target:'NH4',   value: 1.6, label:'Mineralización (N)'},
          {source:'NH4',  target:'NO3',   value: 1.2, label:'Nitrificación'},
          {source:'NO3',  target:'Veg',   value: 1.1, label:'Asimilación radicular (N)'},
          {source:'PO4',  target:'Veg',   value: 0.9, label:'Asimilación radicular (P)'},
          {source:'Veg',  target:'Herb',  value: 2.2, label:'Consumo (energía)'},
          {source:'Herb', target:'Pred',  value: 1.6, label:'Depredación'},
          {source:'Herb', target:'MO',    value: 0.9, label:'Excretas / restos'},
          {source:'Pred', target:'MO',    value: 0.6, label:'Restos'},
          {source:'NO3',  target:'Water', value: 0.8, label:'Lixiviación / escorrentía'},
          {source:'PO4',  target:'Water', value: 0.6, label:'Arrastre de P'},
          {source:'MO',   target:'PO4',   value: 0.7, label:'Liberación (P)'},
          {source:'Atm',  target:'Water', value: 0.4, label:'Depósito / intercambio (N)'}
        ],
        title: 'Sistema café y ciclos de C, N y P (conceptual)'
      };
    }

    function sankeyColors(group){
      const map = {
        'Atmósfera': 'rgba(70, 120, 190, .85)',
        'Vegetación': 'rgba(90, 160, 110, .85)',
        'Fauna': 'rgba(140, 140, 140, .85)',
        'Microbiota': 'rgba(160, 90, 170, .85)',
        'Suelo': 'rgba(120, 95, 70, .85)',
        'Agua': 'rgba(55, 160, 220, .85)'
      };
      return map[group] || 'rgba(11,16,32,.55)';
    }

    function renderSankey(mode){
      // Limpieza
      const prev = sankeyStage.querySelector('svg');
      if(prev) prev.remove();

      const title = sankeyData(mode).title;
      document.getElementById('sHint').textContent =
        (mode === 'simple')
          ? 'Sugerencia de estudio: explica el rol de productores, herbívoros, depredadores y cómo los descomponedores retornan nutrientes al suelo.'
          : 'Sugerencia de estudio: ubica atmósfera, vegetación, fauna, microbiota y suelo; describe cómo se conectan por C, N y P.';

      // Dimensiones
      const W = sankeyStage.clientWidth;
      const H = sankeyStage.clientHeight;

      const svg = d3.select(sankeyStage)
        .append('svg')
        .attr('width', W)
        .attr('height', H)
        .style('display','block');

      // Fondo clickeable para quitar lock
      svg.append('rect')
        .attr('x',0).attr('y',0).attr('width',W).attr('height',H)
        .attr('fill','transparent')
        .on('click', () => {
          sLocked = false;
          sLockKey = null;
          badge('ninguno');
          dimNone();
          hideTip();
        });

      const data = sankeyData(mode);

      // Copia para sankey
      const nodes = data.nodes.map(d => ({...d}));
      const indexById = new Map(nodes.map((d,i)=>[d.id, i]));
      const links = data.links.map(d => ({
        ...d,
        source: indexById.get(d.source),
        target: indexById.get(d.target)
      }));

      // Sankey layout
      const sk = d3.sankey()
        .nodeId(d => d.id)
        .nodeWidth(16)
        .nodePadding(18)
        .extent([[24, 22], [W - 24, H - 24]]);

      const graph = sk({
        nodes: nodes,
        links: links
      });

      // Bands (link paths)
      const linkG = svg.append('g');

      const linkPath = linkG.selectAll('path')
        .data(graph.links)
        .enter()
        .append('path')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('fill','none')
        .attr('stroke', d => {
          const g1 = graph.nodes[d.source.index].group;
          const g2 = graph.nodes[d.target.index].group;
          // Mezcla ligera por destino
          return (g1 === g2) ? sankeyColors(g1) : 'rgba(11,16,32,.38)';
        })
        .attr('stroke-opacity', 0.45)
        .attr('stroke-linecap','round')
        .attr('stroke-width', d => Math.max(2.5, d.width))
        .style('cursor','pointer');

      // Nodes
      const nodeG = svg.append('g');

      const node = nodeG.selectAll('g')
        .data(graph.nodes)
        .enter()
        .append('g')
        .style('cursor','pointer');

      node.append('rect')
        .attr('x', d => d.x0)
        .attr('y', d => d.y0)
        .attr('height', d => Math.max(12, d.y1 - d.y0))
        .attr('width', d => d.x1 - d.x0)
        .attr('rx', 6)
        .attr('fill', d => sankeyColors(d.group))
        .attr('fill-opacity', 0.92)
        .attr('stroke', 'rgba(11,16,32,.18)');

      // Labels (name)
      node.append('text')
        .attr('x', d => d.x0 < W/2 ? d.x1 + 10 : d.x0 - 10)
        .attr('y', d => (d.y0 + d.y1) / 2)
        .attr('dy', '0.32em')
        .attr('text-anchor', d => d.x0 < W/2 ? 'start' : 'end')
        .attr('font-family', 'Outfit, Inter, system-ui')
        .attr('font-weight', 800)
        .attr('font-size', 12)
        .attr('fill', 'rgba(11,16,32,.86)')
        .text(d => d.name);

      // Layer strips (optional): subtle banded background by group columns
      const groupY = d3.group(graph.nodes, d => d.group);

      // Interacciones
      function dimNone(){
        node.selectAll('rect').attr('fill-opacity', 0.92).attr('stroke','rgba(11,16,32,.18)');
        linkPath.attr('stroke-opacity', 0.45);
        linkPath.attr('stroke', d => {
          const g1 = graph.nodes[d.source.index].group;
          const g2 = graph.nodes[d.target.index].group;
          return (g1 === g2) ? sankeyColors(g1) : 'rgba(11,16,32,.38)';
        });
      }

      function highlightNode(n){
        const key = 'node:' + n.id;
        if(sLocked && sLockKey !== key) return;

        node.selectAll('rect')
          .attr('fill-opacity', d => d.id === n.id ? 0.98 : 0.18)
          .attr('stroke', d => d.id === n.id ? 'rgba(45,160,220,.55)' : 'rgba(11,16,32,.10)');

        // Links incidentes
        linkPath
          .attr('stroke-opacity', d => (d.source.id === n.id || d.target.id === n.id) ? 0.86 : 0.12)
          .attr('stroke', d => (d.source.id === n.id || d.target.id === n.id) ? 'rgba(45,160,220,.80)' : 'rgba(11,16,32,.28)');

        badge(n.name);
      }

      function highlightLink(l){
        const key = 'link:' + l.source.id + '->' + l.target.id;
        if(sLocked && sLockKey !== key) return;

        node.selectAll('rect')
          .attr('fill-opacity', d => (d.id === l.source.id || d.id === l.target.id) ? 0.92 : 0.18)
          .attr('stroke', d => (d.id === l.source.id || d.id === l.target.id) ? 'rgba(45,160,220,.55)' : 'rgba(11,16,32,.10)');

        linkPath
          .attr('stroke-opacity', d => (d === l) ? 0.95 : 0.10)
          .attr('stroke', d => (d === l) ? 'rgba(45,160,220,.82)' : 'rgba(11,16,32,.28)');

        badge(l.label || 'flujo');
      }

      function pointerXY(evt){
        const r = sankeyStage.getBoundingClientRect();
        const x = (evt.clientX || (evt.touches && evt.touches[0].clientX) || 0) - r.left;
        const y = (evt.clientY || (evt.touches && evt.touches[0].clientY) || 0) - r.top;
        return {x: Math.max(10, Math.min(W - 340, x + 12)), y: Math.max(10, Math.min(H - 110, y + 12))};
      }

      node
        .on('mousemove touchmove', (event, d) => {
          if(sLocked && sLockKey && sLockKey !== ('node:' + d.id)) return;
          const p = pointerXY(event);
          setTip(
            `<strong>${d.name}</strong><br><span style="color:rgba(11,16,32,.72)">Grupo:</span> ${d.group}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Entradas/Salidas:</span> ${Math.round(d.value*10)/10}`,
            p.x, p.y
          );
        })
        .on('mouseenter touchstart', (event, d) => {
          highlightNode(d);
        })
        .on('mouseleave', () => {
          if(!sLocked){ dimNone(); badge('ninguno'); hideTip(); }
        })
        .on('click', (event, d) => {
          event.stopPropagation();
          const key = 'node:' + d.id;
          if(sLocked && sLockKey === key){
            sLocked = false; sLockKey = null; dimNone(); badge('ninguno'); hideTip();
          }else{
            sLocked = true; sLockKey = key; highlightNode(d);
          }
        });

      linkPath
        .on('mousemove touchmove', (event, d) => {
          if(sLocked && sLockKey && sLockKey !== ('link:' + d.source.id + '->' + d.target.id)) return;
          const p = pointerXY(event);
          setTip(
            `<strong>${d.label || 'Flujo'}</strong><br>` +
            `<span style="color:rgba(11,16,32,.72)">Desde:</span> ${d.source.name}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Hacia:</span> ${d.target.name}<br>` +
            `<span style="color:rgba(11,16,32,.72)">Intensidad relativa:</span> ${Math.round(d.value*10)/10}`,
            p.x, p.y
          );
        })
        .on('mouseenter touchstart', (event, d) => {
          highlightLink(d);
        })
        .on('mouseleave', () => {
          if(!sLocked){ dimNone(); badge('ninguno'); hideTip(); }
        })
        .on('click', (event, d) => {
          event.stopPropagation();
          const key = 'link:' + d.source.id + '->' + d.target.id;
          if(sLocked && sLockKey === key){
            sLocked = false; sLockKey = null; dimNone(); badge('ninguno'); hideTip();
          }else{
            sLocked = true; sLockKey = key; highlightLink(d);
          }
        });

      // Título invisible (para lectores)
      svg.append('title').text(title);

      // Estado inicial
      dimNone();
      badge('ninguno');
      hideTip();
    }

    let sMode = 'cafe';
    function redrawSankey(){
      try { renderSankey(sMode === 'cafe' ? 'cafe' : 'simple'); }
      catch(e){
        // fallback mínimo: sin romper la página
        const hint = document.getElementById('sHint');
        hint.textContent = 'No se pudo renderizar el diagrama en este navegador. Revisa tu conexión o vuelve a cargar.';
      }
    }

    const sTabCafe = document.getElementById('sTabCafe');
    const sTabSimple = document.getElementById('sTabSimple');

    sTabCafe.addEventListener('click', () => {
      sMode = 'cafe';
      sTabCafe.classList.add('active');
      sTabSimple.classList.remove('active');
      sLocked = false; sLockKey = null;
      redrawSankey();
    });
    sTabSimple.addEventListener('click', () => {
      sMode = 'simple';
      sTabSimple.classList.add('active');
      sTabCafe.classList.remove('active');
      sLocked = false; sLockKey = null;
      redrawSankey();
    });
    document.getElementById('sReset').addEventListener('click', () => {
      sLocked = false; sLockKey = null;
      redrawSankey();
    });

    // Render inicial + responsive
    window.addEventListener('load', redrawSankey);
    window.addEventListener('resize', () => {
      // throttling simple
      clearTimeout(window.__sankeyT);
      window.__sankeyT = setTimeout(redrawSankey, 120);
    });

    // =========================================================
    // B) MAPA MENTAL (Markmap) - mismo patrón que 1-1.html
    // =========================================================
    const md = `
# 1.2 Cadenas alimenticias o tróficas
## Ideas clave
- Flujo de energía (direccional)
- Transformación y reciclaje de materia (C, N, P)
## Niveles tróficos
- Productores (autótrofos)
  - Plantas, algas, fitoplancton
- Consumidor primario
  - Herbívoros
- Consumidor secundario / terciario
  - Carnívoros
- Depredador superior
  - Control poblacional
- Descomponedores y simbiontes
  - Hongos y bacterias
  - Mutualismos (mejoran absorción)
## Procesos (ejemplos)
- Fotosíntesis y respiración (C)
- Mineralización (liberación de nutrientes)
- Nitrificación (NH4+ a NO3-)
- Asimilación (raíces)
- Lixiviación y escorrentía (pérdidas)
## Interpretación
- Efecto en cascada si baja un nivel
- Manejo del suelo y cobertura influyen en ciclos
    `.trim();

    let mm = null;
    let expanded = true;

    function safeRender(){
      const fallback = document.getElementById('mapFallback');
      try{
        if (!window.markmap || !window.markmap.Transformer || !window.markmap.Markmap) return false;
        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const { root } = transformer.transform(md);
        const svg = document.getElementById('mindmap');
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        mm = Markmap.create(svg, { autoFit: true, duration: 220 }, root);
        expanded = true;
        fallback.classList.remove('show');
        return true;
      }catch(e){
        fallback.classList.add('show');
        return true;
      }
    }

    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      const done = safeRender();
      if (done || tries >= 12){
        clearInterval(timer);
        if (!mm) document.getElementById('mapFallback').classList.add('show');
      }
    }, 350);

    document.getElementById('btnFit').addEventListener('click', () => mm && mm.fit());
    document.getElementById('btnToggle').addEventListener('click', () => {
      if (!mm) return;
      if (expanded) mm.foldAll(); else mm.unfoldAll();
      expanded = !expanded;
    });
    document.getElementById('btnReset').addEventListener('click', () => safeRender());

    // =========================================================
    // C) JUEGO NUEVO: Simulador de cascada trófica (canvas)
    // =========================================================
    const kProd = document.getElementById('kProd');
    const kHerb = document.getElementById('kHerb');
    const kPred = document.getElementById('kPred');
    const kRecycle = document.getElementById('kRecycle');

    const vProd = document.getElementById('vProd');
    const vHerb = document.getElementById('vHerb');
    const vPred = document.getElementById('vPred');
    const vRec  = document.getElementById('vRec');

    const simScore = document.getElementById('simScore');
    const simFeedback = document.getElementById('simFeedback');

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    function fmt(x){ return (Math.round(x*100)/100).toFixed(2); }
    function syncVals(){
      vProd.textContent = fmt(parseFloat(kProd.value));
      vHerb.textContent = fmt(parseFloat(kHerb.value));
      vPred.textContent = fmt(parseFloat(kPred.value));
      vRec.textContent  = fmt(parseFloat(kRecycle.value));
    }
    [kProd,kHerb,kPred,kRecycle].forEach(el => el.addEventListener('input', syncVals));
    syncVals();

    // Modelo simple (discreto) para aprendizaje:
    // P: productores, H: herbívoros, D: depredadores, N: nutrientes
    // Crece P con N y kProd; H consume P con kHerb; D consume H con kPred; N se recupera por reciclaje.
    let running = false;
    let t = 0;

    const MAX_POINTS = 220;
    let seriesP = [];
    let seriesH = [];
    let seriesD = [];

    let P=0.70, H=0.42, D=0.26, N=0.55;

    function resetSim(){
      running = false;
      t = 0;
      P=0.70; H=0.42; D=0.26; N=0.55;
      seriesP = [];
      seriesH = [];
      seriesD = [];
      for(let i=0;i<60;i++) stepSim(false); // precalienta para que arranque con curvas suaves
      draw();
      simScore.textContent = 'Estado: detenido';
      simFeedback.className = 'result';
      simFeedback.textContent = 'Instrucción: presiona Iniciar y observa. Luego aplica un evento y ajusta controles para recuperar estabilidad.';
    }

    function shockDrought(){
      // sequía reduce N y P
      N = Math.max(0.02, N * 0.55);
      P = Math.max(0.02, P * 0.78);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: sequía. Bajó la producción primaria y nutrientes disponibles. Ajusta parámetros para recuperar estabilidad.';
      draw();
    }
    function shockPredLoss(){
      // pérdida de depredadores
      D = Math.max(0.01, D * 0.35);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: pérdida de depredadores. Observa si suben herbívoros y cae la vegetación.';
      draw();
    }

    function stepSim(push=true){
      const kp = parseFloat(kProd.value);
      const kh = parseFloat(kHerb.value);
      const kd = parseFloat(kPred.value);
      const kr = parseFloat(kRecycle.value);

      // Dinámica (estable y entendible, no científica exacta)
      // Nutrientes: suben por reciclaje desde biomasa total y bajan por uso de productores
      const recycle = kr * (0.30*P + 0.22*H + 0.18*D);
      const uptake  = 0.55 * kp * P;
      N = clamp(N + recycle - uptake, 0.00, 1.20);

      // Productores: crecen con N y kp, bajan por consumo herbívoro
      const growP = kp * (0.55 + 0.75*N) * P * (1.05 - P);
      const eatP  = kh * (0.68) * H * P;
      P = clamp(P + growP - eatP, 0.00, 1.20);

      // Herbívoros: suben si hay P, bajan por depredación y por falta de alimento
      const growH = kh * (0.58) * H * P;
      const predH = kd * (0.70) * D * H;
      const starv = 0.18 * H * (0.45 - P); // si P bajo, cae H
      H = clamp(H + growH - predH - Math.max(0, starv), 0.00, 1.20);

      // Depredadores: suben si hay H, bajan por costo metabólico
      const growD = kd * (0.50) * D * H;
      const costD = 0.22 * D;
      D = clamp(D + growD - costD, 0.00, 1.20);

      if(push){
        seriesP.push(P);
        seriesH.push(H);
        seriesD.push(D);
        if(seriesP.length > MAX_POINTS){
          seriesP.shift(); seriesH.shift(); seriesD.shift();
        }
      }
      t++;
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function assess(){
      // criterio simple de "estabilidad razonable"
      const okP = P > 0.25 && P < 1.05;
      const okH = H > 0.12 && H < 0.95;
      const okD = D > 0.06 && D < 0.80;

      if(okP && okH && okD){
        simScore.textContent = 'Estado: estable';
        simFeedback.className = 'result ok';
        simFeedback.textContent =
          'Estado estable. Explicación esperada: productores sostienen herbívoros; depredadores controlan herbívoros; reciclaje mantiene nutrientes.';
      }else{
        simScore.textContent = 'Estado: inestable';
        simFeedback.className = 'result no';
        let msg = 'Estado inestable. ';
        if(P <= 0.08) msg += 'Productores casi colapsan. ';
        if(H >= 1.05) msg += 'Herbívoros están demasiado altos. ';
        if(D <= 0.03) msg += 'Depredadores casi ausentes. ';
        if(D >= 0.95) msg += 'Depredadores demasiado altos. ';
        msg += 'Ajusta parámetros y observa la gráfica.';
        simFeedback.textContent = msg;
      }
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Fondo suave
      ctx.fillStyle = 'rgba(255,255,255,.65)';
      ctx.fillRect(0,0,w,h);

      // Ejes
      const padL = 42, padR = 14, padT = 14, padB = 28;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      ctx.strokeStyle = 'rgba(11,16,32,.18)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + plotH);
      ctx.lineTo(padL + plotW, padT + plotH);
      ctx.stroke();

      // marcas 0..1.2
      ctx.fillStyle = 'rgba(11,16,32,.68)';
      ctx.font = '12px Inter, system-ui';
      for(let i=0;i<=6;i++){
        const v = (1.2/6)*i;
        const y = padT + plotH - (v/1.2)*plotH;
        ctx.strokeStyle = 'rgba(11,16,32,.10)';
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
        ctx.fillText(v.toFixed(1), 8, y+4);
      }

      // Leyenda
      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '13px Outfit, Inter, system-ui';
      ctx.fillText('Productores', padL + 6, padT + 14);
      ctx.fillText('Herbívoros',  padL + 150, padT + 14);
      ctx.fillText('Depredadores',padL + 278, padT + 14);

      // Colores (sin fijar "tema"; aquí sí fijamos porque es UI del juego)
      const colP = 'rgba(90,160,110,.88)';
      const colH = 'rgba(200,150,80,.88)';
      const colD = 'rgba(140,140,140,.92)';

      function plot(series, color, x0){
        if(series.length < 2) return;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for(let i=0;i<series.length;i++){
          const x = padL + (i/(MAX_POINTS-1))*plotW;
          const y = padT + plotH - (series[i]/1.2)*plotH;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      plot(seriesP, colP);
      plot(seriesH, colH);
      plot(seriesD, colD);

      // Estado actual (valores)
      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '12px Inter, system-ui';
      ctx.fillText('P=' + fmt(P) + '   H=' + fmt(H) + '   D=' + fmt(D) + '   N=' + fmt(N), padL, padT + plotH + 20);
    }

    function tick(){
      if(!running) return;
      stepSim(true);
      draw();

      // Evaluación periódica
      if(t % 18 === 0) assess();

      requestAnimationFrame(tick);
    }

    document.getElementById('btnStart').addEventListener('click', () => {
      if(!running){
        running = true;
        simScore.textContent = 'Estado: ejecutando';
        requestAnimationFrame(tick);
      }
    });
    document.getElementById('btnPause').addEventListener('click', () => {
      running = false;
      simScore.textContent = 'Estado: pausado';
    });
    document.getElementById('btnShock1').addEventListener('click', shockDrought);
    document.getElementById('btnShock2').addEventListener('click', shockPredLoss);
    document.getElementById('btnSimReset').addEventListener('click', resetSim);

    // estado inicial
    resetSim();
  </script>
</body>
</html>
