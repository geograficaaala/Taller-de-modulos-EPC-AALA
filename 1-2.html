<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Módulo 1 · 1.2 Las cadenas alimenticias o tróficas</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Markmap (mapa mental) -->
  <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.16.1"></script>

  <style>
    :root{
      --ink:#0b1020;
      --muted:rgba(11,16,32,.72);
      --glass:rgba(255,255,255,.66);
      --stroke:rgba(11,16,32,.10);
      --shadow:0 18px 45px rgba(11,16,32,.16);
      --shadow-soft:0 10px 24px rgba(11,16,32,.12);
      --radius:24px;

      --good: rgba(30, 160, 90, .18);
      --bad: rgba(210, 70, 100, .16);
      --focus: rgba(45, 160, 220, .22);

      --aqua: rgba(45,160,220,.86);
      --mint: rgba(50, 170, 120, .86);
      --rose: rgba(240, 110, 170, .82);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 760px at 12% 12%, rgba(175, 255, 216, .88), transparent 58%),
        radial-gradient(980px 760px at 82% 18%, rgba(170, 226, 255, .88), transparent 62%),
        radial-gradient(1200px 920px at 48% 96%, rgba(255, 191, 228, .76), transparent 58%),
        linear-gradient(135deg, #eafff4 0%, #e8f6ff 45%, #fff0f7 100%);
      min-height:100vh;
    }
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 26px 18px 64px; }

    header{
      border: 1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(12px);
      padding: 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap:wrap;
    }
    .kicker{ font-size: 12px; color: var(--muted); font-weight: 800; letter-spacing:.3px; }
    h1{
      margin: 6px 0 0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: clamp(20px, 2.5vw, 28px);
      line-height: 1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 92ch;
    }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      color: rgba(11,16,32,.92);
      font-weight: 800;
      text-decoration:none;
      font-size: 13px;
      transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); box-shadow: 0 10px 18px rgba(11,16,32,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82)); }

    .stack{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 16px;
    }
    .card h2{
      margin:0;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .muted{ color: var(--muted); }

    .twoCols{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .twoCols{ grid-template-columns: 1fr; } }
    .theory{ line-height: 1.58; color: rgba(11,16,32,.90); font-size: 14px; }
    .theory p{ margin: 10px 0 0; }
    .theory ul{ margin: 10px 0 0 18px; }
    .theory li{ margin: 8px 0; }
    .callout{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
      color: rgba(11,16,32,.86);
      font-size: 13px;
      line-height: 1.45;
    }

    /* =========================
       DIAGRAMA EDITORIAL (SVG NATIVO, SIEMPRE FUNCIONA)
       ========================= */
    .diagramWrap{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.62), rgba(255,255,255,.46));
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      position: relative;
    }
    .diagramTop{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.55);
    }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tab{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .tab:hover{ background: rgba(255,255,255,.80); border-color: rgba(11,16,32,.18); }
    .tab:active{ transform: translateY(1px); }
    .tab.active{ background: linear-gradient(135deg, rgba(170,255,216,.90), rgba(170,226,255,.90), rgba(255,191,228,.82)); }

    .badge{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
    }

    .flowStage{
      height: 560px;
      width: 100%;
      position: relative;
      padding: 10px;
    }
    @media (max-width: 820px){ .flowStage{ height: 700px; } }

    .flowSvg{
      width:100%;
      height:100%;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.10);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.06) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.40);
      overflow:hidden;
    }

    .legendBox{
      position:absolute;
      right: 18px;
      top: 18px;
      width: min(360px, calc(100% - 36px));
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.75);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      z-index: 3;
    }
    .legendBox h3{
      margin:0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .legendList{ margin:0; padding-left: 16px; }
    .legendList li{
      margin: 6px 0;
      font-size: 12px;
      color: rgba(11,16,32,.80);
      line-height: 1.35;
    }

    .tooltip{
      position:absolute;
      pointer-events:none;
      z-index: 4;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .10s ease, transform .10s ease;
      max-width: 340px;
      border-radius: 14px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      color: rgba(11,16,32,.86);
    }
    .tooltip strong{ font-weight: 900; }

    .hint{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
    }

    /* =========================
       MAPA MENTAL
       ========================= */
    .mapWrap{
      width:100%;
      height: 720px;
      margin-top: 10px;
      border: 1px solid rgba(11,16,32,.12);
      border-radius: 16px;
      overflow:hidden;
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        rgba(255,255,255,.35);
      position: relative;
    }
    svg.markmap{ width:100%; height:100%; }
    .mapFallback{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
      color: rgba(11,16,32,.75);
      background: rgba(255,255,255,.55);
    }
    .mapFallback.show{ display:flex; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; align-items:center; }

    /* =========================
       SIMULADOR (más vistoso)
       ========================= */
    .simGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){ .simGrid{ grid-template-columns: 1fr; } }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow-soft);
      padding: 12px;
      position: relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at 30% 30%, rgba(45,160,220,.22), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }
    .panel h3{
      margin: 0 0 8px;
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 14px;
      letter-spacing:.2px;
      position: relative;
      z-index: 1;
    }
    .ctrl{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items:center;
      margin: 10px 0;
      position: relative;
      z-index: 1;
    }
    .ctrl label{ font-weight: 800; font-size: 13px; color: rgba(11,16,32,.86); }
    .ctrl .val{
      font-weight: 900;
      font-size: 13px;
      color: rgba(11,16,32,.86);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.62);
      min-width: 64px;
      text-align:center;
    }
    input[type="range"]{ width: 100%; accent-color: rgba(45,160,220,.75); position: relative; z-index: 1; }

    .simBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
      position: relative;
      z-index: 1;
    }

    .badge.ok{
      border-color: rgba(30,160,90,.26);
      background: rgba(30,160,90,.15);
      color: rgba(11,16,32,.88);
      box-shadow: 0 0 0 6px rgba(30,160,90,.08);
    }
    .badge.no{
      border-color: rgba(210,70,100,.22);
      background: rgba(210,70,100,.13);
      color: rgba(11,16,32,.88);
      box-shadow: 0 0 0 6px rgba(210,70,100,.06);
    }

    .statRow{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
      position: relative;
      z-index: 1;
    }
    @media (max-width: 980px){ .statRow{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px){ .statRow{ grid-template-columns: 1fr; } }

    .stat{
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.10);
      background: rgba(255,255,255,.62);
      padding: 10px;
    }
    .stat .k{
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 12px;
      color: rgba(11,16,32,.78);
      margin: 0 0 6px;
    }
    .stat .v{
      font-family: Outfit, Inter, system-ui;
      font-weight: 800;
      font-size: 18px;
      color: rgba(11,16,32,.92);
      margin: 0 0 8px;
      letter-spacing:.2px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(11,16,32,.10);
      overflow:hidden;
      border: 1px solid rgba(11,16,32,.10);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(45,160,220,.80), rgba(50,170,120,.80), rgba(240,110,170,.72));
      transition: width .12s ease;
    }

    .canvasWrap{
      border-radius: 16px;
      border: 1px dashed rgba(11,16,32,.22);
      background:
        radial-gradient(circle at 1px 1px, rgba(11,16,32,.08) 1px, transparent 1px) 0 0 / 22px 22px,
        linear-gradient(180deg, rgba(255,255,255,.56), rgba(255,255,255,.40));
      overflow:hidden;
      padding: 10px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
    }
    canvas{ width: 100%; height: 320px; display:block; }

    .result{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,16,32,.12);
      background: rgba(255,255,255,.55);
      padding: 12px;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(11,16,32,.86);
      position: relative;
      z-index: 1;
    }
    .ok{ background: var(--good); border-color: rgba(30,160,90,.26); }
    .no{ background: var(--bad); border-color: rgba(210,70,100,.24); }

    footer{ margin-top: 14px; color: rgba(11,16,32,.62); font-size: 12px; line-height: 1.4; text-align:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <div class="kicker">Módulo 1 · Medio ambiente</div>
        <h1>1.2 Las cadenas alimenticias o tróficas</h1>
        <p class="subtitle">
          Diagrama editorial interactivo (tipo libro) de cadena trófica y ciclos (C, N, P), mapa mental y simulador de cascada trófica.
        </p>
      </div>
      <nav class="nav">
        <a class="btn" href="index.html">Inicio</a>
        <a class="btn" href="1-1.html">Anterior (1.1)</a>
        <a class="btn primary" href="#" onclick="alert('Se agregará la siguiente sección.'); return false;">Siguiente</a>
      </nav>
    </header>

    <main class="stack">
      <section class="card">
        <h2>Contexto teórico</h2>
        <div class="twoCols">
          <div class="theory">
            <p>
              Una <strong>cadena alimenticia</strong> (o trófica) describe quién se alimenta de quién y cómo fluye la <strong>energía</strong>
              desde los <strong>productores</strong> hacia consumidores y depredadores. La <strong>materia</strong> (C, N, P) se transforma
              y puede reciclarse por suelo y microbiota.
            </p>
            <ul>
              <li><strong>Productores:</strong> plantas/algas (energía solar a biomasa).</li>
              <li><strong>Consumidores:</strong> primarios (herbívoros), secundarios/terciarios (carnívoros).</li>
              <li><strong>Descomponedores:</strong> hongos y bacterias (retorno de nutrientes).</li>
            </ul>
            <div class="callout">
              La energía disponible disminuye en cada transferencia; los niveles superiores suelen tener menor biomasa.
            </div>
          </div>

          <div class="theory">
            <p>
              En sistemas agrícolas (por ejemplo, café bajo sombra) la cadena trófica se integra con procesos de ciclos biogeoquímicos:
              fotosíntesis/respiración, mineralización, nitrificación, asimilación radicular, lixiviación y escorrentía.
            </p>
            <div class="callout">
              Pregunta guía: ¿qué ocurre con la cadena si disminuye la producción primaria o se pierden depredadores?
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Diagrama conceptual editorial (interactivo)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Interacción: pasar el cursor resalta; clic fija el resaltado; clic en el fondo lo quita.
        </p>

        <div class="diagramWrap">
          <div class="diagramTop">
            <div class="tabs">
              <button class="tab active" id="fTabCafe" type="button">Sistema café (conceptual)</button>
              <button class="tab" id="fTabSimple" type="button">Cadena trófica simple</button>
              <span class="badge" id="fBadge">Resaltado: ninguno</span>
            </div>
            <div class="tabs">
              <button class="btn" id="fReset" type="button">Reiniciar</button>
            </div>
          </div>

          <div class="flowStage" id="flowStage">
            <svg class="flowSvg" id="flowSvg" viewBox="0 0 1200 560" preserveAspectRatio="xMidYMid meet" role="img" aria-label="Diagrama conceptual de cadena trófica y ciclos">
              <defs>
                <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
                  <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(11,16,32,.18)"/>
                </filter>
                <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
                  <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="rgba(45,160,220,.25)"/>
                </filter>
              </defs>
              <!-- contenido se inyecta por JS -->
            </svg>

            <div class="legendBox">
              <h3>Leyenda</h3>
              <ul class="legendList">
                <li>Bandas: reservorios y compartimentos (atmósfera, suelo, agua, etc.).</li>
                <li>Nodos: componentes (vegetación, herbívoros, microbiota).</li>
                <li>Flujos: grosor indica intensidad relativa.</li>
                <li>Resaltado: pasa el cursor o haz clic para fijar.</li>
              </ul>
            </div>

            <div class="tooltip" id="fTip"></div>
          </div>

          <div class="hint" id="fHint">
            Sugerencia: identifica productores, ruta herbívoros-depredadores y cómo suelo y microbiota cierran el ciclo.
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Mapa mental interactivo</h2>
        <p class="muted" style="margin:8px 0 0;">Si no carga, recarga la página. El simulador funciona aunque el mapa falle.</p>

        <div class="mapWrap">
          <svg id="mindmap" class="markmap"></svg>
          <div class="mapFallback" id="mapFallback">
            <div>
              <strong>No se pudo cargar el mapa mental.</strong><br>
              Recarga la página. El simulador sigue funcionando.
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnFit" type="button">Ajustar</button>
          <button class="btn" id="btnToggle" type="button">Expandir/Colapsar</button>
          <button class="btn" id="btnReset" type="button">Reiniciar mapa</button>
        </div>
      </section>

      <section class="card">
        <h2>Simulador de cascada trófica (evaluación)</h2>
        <p class="muted" style="margin:8px 0 0;">
          Ajusta parámetros para mantener un sistema estable. Prueba eventos y recupera el equilibrio.
        </p>

        <div class="simGrid">
          <div class="panel">
            <h3>Controles</h3>

            <div class="ctrl">
              <label for="kProd">Producción primaria (productores)</label>
              <span class="val" id="vProd">0.70</span>
            </div>
            <input id="kProd" type="range" min="0.20" max="1.20" step="0.01" value="0.70">

            <div class="ctrl">
              <label for="kHerb">Consumo herbívoro (presión)</label>
              <span class="val" id="vHerb">0.60</span>
            </div>
            <input id="kHerb" type="range" min="0.20" max="1.20" step="0.01" value="0.60">

            <div class="ctrl">
              <label for="kPred">Depredación (control)</label>
              <span class="val" id="vPred">0.55</span>
            </div>
            <input id="kPred" type="range" min="0.20" max="1.20" step="0.01" value="0.55">

            <div class="ctrl">
              <label for="kRecycle">Reciclaje (retorno de nutrientes)</label>
              <span class="val" id="vRec">0.45</span>
            </div>
            <input id="kRecycle" type="range" min="0.10" max="1.10" step="0.01" value="0.45">

            <div class="simBtns">
              <button class="btn" id="btnStart" type="button">Iniciar</button>
              <button class="btn" id="btnPause" type="button">Pausar</button>
              <button class="btn" id="btnShock1" type="button">Evento: sequía</button>
              <button class="btn" id="btnShock2" type="button">Evento: pérdida de depredadores</button>
              <button class="btn primary" id="btnSimReset" type="button">Reiniciar</button>
              <span class="badge" id="simScore">Estado: detenido</span>
            </div>

            <div class="statRow">
              <div class="stat">
                <div class="k">Productores</div>
                <div class="v" id="svP">0.00</div>
                <div class="bar"><i id="sbP"></i></div>
              </div>
              <div class="stat">
                <div class="k">Herbívoros</div>
                <div class="v" id="svH">0.00</div>
                <div class="bar"><i id="sbH"></i></div>
              </div>
              <div class="stat">
                <div class="k">Depredadores</div>
                <div class="v" id="svD">0.00</div>
                <div class="bar"><i id="sbD"></i></div>
              </div>
              <div class="stat">
                <div class="k">Nutrientes</div>
                <div class="v" id="svN">0.00</div>
                <div class="bar"><i id="sbN"></i></div>
              </div>
            </div>

            <div class="result" id="simFeedback">
              Presiona Iniciar. Luego aplica un evento y ajusta controles para recuperar estabilidad.
            </div>
          </div>

          <div class="panel">
            <h3>Gráfica</h3>
            <div class="canvasWrap">
              <canvas id="chart" width="900" height="360"></canvas>
            </div>
            <div class="hint">
              Lectura rápida: si productores caen demasiado, todo colapsa. Si herbívoros suben mucho, productores bajan. Si depredadores desaparecen, herbívoros tienden a explotar.
            </div>
          </div>
        </div>
      </section>

      <footer>EPC AALA · Módulo 1 · 1.2 Cadenas tróficas</footer>
    </main>
  </div>

  <script>
    /* =========================================================
       A) DIAGRAMA EDITORIAL SVG (SIN LIBRERÍAS)
       ========================================================= */
    const flowSvg = document.getElementById('flowSvg');
    const flowStage = document.getElementById('flowStage');
    const fTip = document.getElementById('fTip');
    const fBadge = document.getElementById('fBadge');
    const fHint = document.getElementById('fHint');

    let flowMode = 'cafe';
    let locked = false;
    let lockKey = null;

    function badgeFlow(text){ fBadge.textContent = 'Resaltado: ' + text; }

    function showTip(html, x, y){
      fTip.innerHTML = html;
      fTip.style.left = x + 'px';
      fTip.style.top = y + 'px';
      fTip.style.opacity = 1;
      fTip.style.transform = 'translateY(0)';
    }
    function hideTip(){
      fTip.style.opacity = 0;
      fTip.style.transform = 'translateY(6px)';
    }
    function tipPos(evt){
      const r = flowStage.getBoundingClientRect();
      const cx = evt.clientX || 0;
      const cy = evt.clientY || 0;
      const x = cx - r.left;
      const y = cy - r.top;
      // mantener dentro
      const maxX = Math.max(10, r.width - 360);
      const maxY = Math.max(10, r.height - 120);
      return { x: Math.max(10, Math.min(maxX, x + 12)), y: Math.max(10, Math.min(maxY, y + 12)) };
    }

    // Paleta por grupo (coherente editorial)
    function groupColor(g){
      const map = {
        'Atmósfera': 'rgba(70,120,190,.90)',
        'Vegetación': 'rgba(90,160,110,.90)',
        'Fauna': 'rgba(140,140,140,.90)',
        'Microbiota': 'rgba(160,90,170,.90)',
        'Suelo': 'rgba(120,95,70,.90)',
        'Agua': 'rgba(55,160,220,.90)'
      };
      return map[g] || 'rgba(11,16,32,.70)';
    }

    // Diagrama tipo “swimlanes”
    const diagrams = {
      cafe: {
        title: 'Sistema café y ciclos de C, N y P (conceptual)',
        hint: 'Sugerencia: ubica atmósfera, vegetación, fauna, microbiota y suelo; describe cómo se conectan por C, N y P.',
        lanes: [
          { id:'atm',  label:'Atmósfera (reservorios gaseosos)',  y0:  20, y1: 100 },
          { id:'veg',  label:'Vegetación (productores primarios)', y0: 110, y1: 200 },
          { id:'faun', label:'Fauna (herbívoros y depredadores)',  y0: 210, y1: 300 },
          { id:'mic',  label:'Microbiota (descomponedores y simbiontes)', y0: 310, y1: 400 },
          { id:'soil', label:'Suelo (MO, N mineral, P disponible)', y0: 410, y1: 500 },
          { id:'water',label:'Agua (pérdidas por lixiviación/escorrentía)', y0: 510, y1: 540 }
        ],
        nodes: [
          // atm
          { id:'Atm', name:'Atmósfera', group:'Atmósfera', lane:'atm', x: 70,  w: 150, h: 44, sub:'CO2, N2' },
          { id:'AtmN',name:'Atm: N2',   group:'Atmósfera', lane:'atm', x: 920, w: 120, h: 40, sub:'Reservorio' },

          // veg
          { id:'Veg', name:'Vegetación', group:'Vegetación', lane:'veg', x: 120, w: 200, h: 52, sub:'Cafeto y sombra' },
          { id:'AMF', name:'Mutualismo', group:'Microbiota', lane:'veg', x: 420, w: 190, h: 44, sub:'Mejora absorción N y P' },

          // fauna
          { id:'Herb', name:'Herbívoros', group:'Fauna', lane:'faun', x: 300, w: 170, h: 46, sub:'Consumo de plantas' },
          { id:'Pred', name:'Depredadores', group:'Fauna', lane:'faun', x: 650, w: 180, h: 46, sub:'Control poblacional' },

          // micro
          { id:'Micro', name:'Microbiota', group:'Microbiota', lane:'mic', x: 180, w: 190, h: 46, sub:'Descomposición / simbiosis' },
          { id:'FBN', name:'Fijación biológica', group:'Microbiota', lane:'mic', x: 520, w: 220, h: 46, sub:'N2 → NH4+' },

          // soil
          { id:'MO',  name:'Suelo: MO', group:'Suelo', lane:'soil', x: 90,  w: 150, h: 46, sub:'Materia orgánica' },
          { id:'NH4', name:'NH4+', group:'Suelo', lane:'soil', x: 340, w: 120, h: 46, sub:'Amonio' },
          { id:'NO3', name:'NO3-', group:'Suelo', lane:'soil', x: 520, w: 120, h: 46, sub:'Nitrato' },
          { id:'PO4', name:'PO4---', group:'Suelo', lane:'soil', x: 700, w: 140, h: 46, sub:'Fosfato' },

          // water
          { id:'Water', name:'Agua', group:'Agua', lane:'water', x: 940, w: 140, h: 40, sub:'N, P disueltos' }
        ],
        links: [
          // C
          { id:'L1', source:'Atm', target:'Veg',  value: 9, label:'Fotosíntesis (C)', note:'Entrada de C desde CO2 atmosférico.' },
          { id:'L2', source:'Veg', target:'Atm',  value: 4, label:'Respiración (CO2)', note:'Salida de CO2 por respiración.' },

          // biomasa hacia fauna
          { id:'L3', source:'Veg', target:'Herb', value: 5, label:'Consumo (energía)', note:'Transferencia a consumidores primarios.' },
          { id:'L4', source:'Herb',target:'Pred', value: 4, label:'Depredación', note:'Control sobre herbívoros.' },

          // restos al suelo
          { id:'L5', source:'Veg', target:'MO',   value: 5, label:'Hojarasca/restos', note:'Aporta MO y nutrientes.' },
          { id:'L6', source:'Herb',target:'MO',   value: 3, label:'Excretas/restos', note:'Retorno de materia al suelo.' },
          { id:'L7', source:'Pred',target:'MO',   value: 2, label:'Restos', note:'Retorno de materia al suelo.' },

          // micro y mineralización
          { id:'L8', source:'MO', target:'Micro', value: 4, label:'Sustrato', note:'Microbiota usa MO para descomponer.' },
          { id:'L9', source:'Micro', target:'NH4',value: 3, label:'Mineralización (N)', note:'Liberación de N a forma mineral.' },

          // fijación biológica
          { id:'L10',source:'AtmN', target:'FBN', value: 2, label:'N2', note:'Entrada de N2 para fijación.' },
          { id:'L11',source:'FBN', target:'NH4',  value: 2, label:'Fijación', note:'Conversión N2 → NH4+.' },

          // nitrificación y absorción
          { id:'L12',source:'NH4', target:'NO3',  value: 2.5, label:'Nitrificación', note:'Transformación NH4+ → NO3-.' },
          { id:'L13',source:'NO3', target:'Veg',  value: 2.2, label:'Asimilación (N)', note:'Absorción de NO3- por raíces.' },
          { id:'L14',source:'PO4', target:'Veg',  value: 1.8, label:'Asimilación (P)', note:'Absorción de fosfato por raíces.' },

          // mutualismo mejora absorción (conceptual)
          { id:'L15',source:'AMF', target:'Veg',  value: 1.6, label:'Mejora absorción', note:'Mutualismo que mejora adquisición de nutrientes.' },
          { id:'L16',source:'Micro', target:'AMF',value: 1.2, label:'Simbiosis', note:'Conexión microbiota–raíces.' },

          // pérdidas al agua
          { id:'L17',source:'NO3', target:'Water',value: 2.0, label:'Lixiviación', note:'Pérdidas hacia cuerpos de agua.' },
          { id:'L18',source:'PO4', target:'Water',value: 1.4, label:'Escorrentía', note:'Arrastre de P hacia el agua.' }
        ]
      },

      simple: {
        title: 'Cadena trófica simple (flujo conceptual)',
        hint: 'Sugerencia: explica el rol de productores, herbívoros, depredadores y cómo los descomponedores retornan nutrientes.',
        lanes: [
          { id:'veg',  label:'Vegetación (productores)', y0:  70, y1: 160 },
          { id:'faun', label:'Fauna (consumidores)',     y0: 170, y1: 260 },
          { id:'mic',  label:'Descomposición',           y0: 270, y1: 360 },
          { id:'soil', label:'Suelo (reciclaje)',        y0: 370, y1: 470 },
          { id:'water',label:'Pérdidas',                 y0: 480, y1: 530 }
        ],
        nodes: [
          { id:'Prod', name:'Productores', group:'Vegetación', lane:'veg', x: 120, w: 210, h: 54, sub:'Plantas' },
          { id:'Herb', name:'Consumidor primario', group:'Fauna', lane:'faun', x: 380, w: 240, h: 50, sub:'Herbívoros' },
          { id:'Pred', name:'Consumidor secundario', group:'Fauna', lane:'faun', x: 720, w: 260, h: 50, sub:'Depredadores' },
          { id:'Deco', name:'Descomponedores', group:'Microbiota', lane:'mic', x: 200, w: 240, h: 50, sub:'Hongos y bacterias' },
          { id:'Soil', name:'Suelo', group:'Suelo', lane:'soil', x: 520, w: 200, h: 50, sub:'Minerales y MO' },
          { id:'Water',name:'Agua', group:'Agua', lane:'water', x: 900, w: 160, h: 44, sub:'Pérdidas' }
        ],
        links: [
          { id:'S1', source:'Prod', target:'Herb', value: 8, label:'Consumo', note:'Transferencia de energía a herbívoros.' },
          { id:'S2', source:'Herb', target:'Pred', value: 6, label:'Depredación', note:'Control de herbívoros por depredadores.' },
          { id:'S3', source:'Prod', target:'Soil', value: 3, label:'Restos', note:'Hojarasca y materia orgánica.' },
          { id:'S4', source:'Herb', target:'Soil', value: 2, label:'Excretas', note:'Retorno de materia al suelo.' },
          { id:'S5', source:'Pred', target:'Soil', value: 1.4, label:'Restos', note:'Retorno de materia al suelo.' },
          { id:'S6', source:'Soil', target:'Deco', value: 3.5, label:'Sustrato', note:'Materia para descomposición.' },
          { id:'S7', source:'Deco', target:'Soil', value: 3.0, label:'Mineralización', note:'Nutrientes regresan al suelo.' },
          { id:'S8', source:'Soil', target:'Water', value: 1.8, label:'Lixiviación', note:'Pérdidas del sistema.' }
        ]
      }
    };

    function clearSvg(){
      while(flowSvg.firstChild) flowSvg.removeChild(flowSvg.firstChild);
      // restaurar defs
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      defs.innerHTML = `
        <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="rgba(11,16,32,.18)"/>
        </filter>
        <filter id="glow" x="-30%" y="-30%" width="160%" height="160%">
          <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="rgba(45,160,220,.25)"/>
        </filter>
      `;
      flowSvg.appendChild(defs);
    }

    function nodeCenter(n, lanesById){
      const lane = lanesById.get(n.lane);
      const yMid = (lane.y0 + lane.y1)/2;
      const x = n.x + n.w/2;
      const y = yMid;
      return { x, y };
    }

    function thick(v){
      // escala de grosor tipo editorial (controlado)
      // min 4, max 22
      const t = 4 + (v * 1.8);
      return Math.max(4, Math.min(22, t));
    }

    function renderFlow(mode){
      flowMode = mode;
      const d = diagrams[mode];
      fHint.textContent = d.hint;

      locked = false;
      lockKey = null;
      badgeFlow('ninguno');
      hideTip();

      clearSvg();

      const lanesById = new Map(d.lanes.map(x => [x.id, x]));
      const nodesById = new Map(d.nodes.map(x => [x.id, x]));

      // Fondo lanes
      d.lanes.forEach((lane, i) => {
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', 10);
        rect.setAttribute('y', lane.y0);
        rect.setAttribute('width', 1180);
        rect.setAttribute('height', Math.max(18, lane.y1 - lane.y0));
        rect.setAttribute('rx', 12);
        rect.setAttribute('fill', i % 2 === 0 ? 'rgba(255,255,255,.34)' : 'rgba(255,255,255,.22)');
        rect.setAttribute('stroke', 'rgba(11,16,32,.08)');
        flowSvg.appendChild(rect);

        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', 22);
        label.setAttribute('y', lane.y0 + 22);
        label.setAttribute('fill', 'rgba(11,16,32,.72)');
        label.setAttribute('font-family', 'Outfit, Inter, system-ui');
        label.setAttribute('font-weight', '800');
        label.setAttribute('font-size', '12');
        label.textContent = lane.label;
        flowSvg.appendChild(label);
      });

      // Grupos para capas
      const linkLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
      const nodeLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
      flowSvg.appendChild(linkLayer);
      flowSvg.appendChild(nodeLayer);

      // Fondo clickeable para “unlock”
      const bgHit = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bgHit.setAttribute('x', 0);
      bgHit.setAttribute('y', 0);
      bgHit.setAttribute('width', 1200);
      bgHit.setAttribute('height', 560);
      bgHit.setAttribute('fill', 'transparent');
      bgHit.style.cursor = 'default';
      bgHit.addEventListener('click', () => {
        locked = false;
        lockKey = null;
        badgeFlow('ninguno');
        applyDim(null, null);
        hideTip();
      });
      // IMPORTANTE: bgHit debe estar debajo de links/nodes, así que se inserta antes
      flowSvg.insertBefore(bgHit, flowSvg.childNodes[1]);

      // Links
      const linkEls = new Map(); // id -> path
      d.links.forEach(link => {
        const s = nodesById.get(link.source);
        const t = nodesById.get(link.target);
        if(!s || !t) return;

        const sp = nodeCenter(s, lanesById);
        const tp = nodeCenter(t, lanesById);

        const dx = (tp.x - sp.x) * 0.48;
        const pathD = `M ${sp.x} ${sp.y} C ${sp.x + dx} ${sp.y}, ${tp.x - dx} ${tp.y}, ${tp.x} ${tp.y}`;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', pathD);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'rgba(11,16,32,.40)');
        path.setAttribute('stroke-width', thick(link.value));
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('opacity', '0.55');
        path.style.cursor = 'pointer';
        path.dataset.kind = 'link';
        path.dataset.id = link.id;
        path.dataset.source = link.source;
        path.dataset.target = link.target;

        path.addEventListener('mouseenter', (evt) => {
          const k = 'link:' + link.id;
          if(locked && lockKey !== k) return;
          badgeFlow(link.label || 'flujo');
          applyDim(null, link.id);
          const p = tipPos(evt);
          showTip(
            `<strong>${link.label || 'Flujo'}</strong><br>` +
            `<span style="color:rgba(11,16,32,.70)">Desde:</span> ${nodesById.get(link.source).name}<br>` +
            `<span style="color:rgba(11,16,32,.70)">Hacia:</span> ${nodesById.get(link.target).name}<br>` +
            `<span style="color:rgba(11,16,32,.70)">Intensidad:</span> ${Math.round(link.value*10)/10}<br>` +
            `<span style="color:rgba(11,16,32,.70)">Nota:</span> ${link.note || '—'}`,
            p.x, p.y
          );
        });
        path.addEventListener('mousemove', (evt) => {
          const k = 'link:' + link.id;
          if(locked && lockKey !== k) return;
          const p = tipPos(evt);
          fTip.style.left = p.x + 'px';
          fTip.style.top = p.y + 'px';
        });
        path.addEventListener('mouseleave', () => {
          if(!locked){
            badgeFlow('ninguno');
            applyDim(null, null);
            hideTip();
          }
        });
        path.addEventListener('click', (evt) => {
          evt.stopPropagation();
          const k = 'link:' + link.id;
          if(locked && lockKey === k){
            locked = false; lockKey = null;
            badgeFlow('ninguno');
            applyDim(null, null);
            hideTip();
          }else{
            locked = true; lockKey = k;
            badgeFlow(link.label || 'flujo');
            applyDim(null, link.id);
          }
        });

        linkLayer.appendChild(path);
        linkEls.set(link.id, path);
      });

      // Nodes
      const nodeEls = new Map(); // id -> group
      d.nodes.forEach(node => {
        const lane = lanesById.get(node.lane);
        const yMid = (lane.y0 + lane.y1)/2;
        const y = yMid - node.h/2;

        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.dataset.kind = 'node';
        g.dataset.id = node.id;
        g.style.cursor = 'pointer';

        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', node.x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', node.w);
        rect.setAttribute('height', node.h);
        rect.setAttribute('rx', 14);
        rect.setAttribute('fill', 'rgba(255,255,255,.86)');
        rect.setAttribute('stroke', 'rgba(11,16,32,.18)');
        rect.setAttribute('filter', 'url(#softShadow)');

        const bar = document.createElementNS('http://www.w3.org/2000/svg','rect');
        bar.setAttribute('x', node.x);
        bar.setAttribute('y', y);
        bar.setAttribute('width', 10);
        bar.setAttribute('height', node.h);
        bar.setAttribute('rx', 14);
        bar.setAttribute('fill', groupColor(node.group));
        bar.setAttribute('opacity', '0.92');

        const title = document.createElementNS('http://www.w3.org/2000/svg','text');
        title.setAttribute('x', node.x + 18);
        title.setAttribute('y', y + 20);
        title.setAttribute('fill', 'rgba(11,16,32,.90)');
        title.setAttribute('font-family', 'Outfit, Inter, system-ui');
        title.setAttribute('font-weight', '800');
        title.setAttribute('font-size', '13');
        title.textContent = node.name;

        const sub = document.createElementNS('http://www.w3.org/2000/svg','text');
        sub.setAttribute('x', node.x + 18);
        sub.setAttribute('y', y + 38);
        sub.setAttribute('fill', 'rgba(11,16,32,.70)');
        sub.setAttribute('font-family', 'Inter, system-ui');
        sub.setAttribute('font-weight', '600');
        sub.setAttribute('font-size', '12');
        sub.textContent = node.sub || '';

        g.appendChild(rect);
        g.appendChild(bar);
        g.appendChild(title);
        g.appendChild(sub);

        g.addEventListener('mouseenter', (evt) => {
          const k = 'node:' + node.id;
          if(locked && lockKey !== k) return;
          badgeFlow(node.name);
          applyDim(node.id, null);
          const p = tipPos(evt);
          showTip(
            `<strong>${node.name}</strong><br>` +
            `<span style="color:rgba(11,16,32,.70)">Grupo:</span> ${node.group}<br>` +
            (node.sub ? `<span style="color:rgba(11,16,32,.70)">Detalle:</span> ${node.sub}` : ''),
            p.x, p.y
          );
        });
        g.addEventListener('mousemove', (evt) => {
          const k = 'node:' + node.id;
          if(locked && lockKey !== k) return;
          const p = tipPos(evt);
          fTip.style.left = p.x + 'px';
          fTip.style.top = p.y + 'px';
        });
        g.addEventListener('mouseleave', () => {
          if(!locked){
            badgeFlow('ninguno');
            applyDim(null, null);
            hideTip();
          }
        });
        g.addEventListener('click', (evt) => {
          evt.stopPropagation();
          const k = 'node:' + node.id;
          if(locked && lockKey === k){
            locked = false; lockKey = null;
            badgeFlow('ninguno');
            applyDim(null, null);
            hideTip();
          }else{
            locked = true; lockKey = k;
            badgeFlow(node.name);
            applyDim(node.id, null);
          }
        });

        nodeLayer.appendChild(g);
        nodeEls.set(node.id, g);
      });

      // Dim / highlight
      function applyDim(nodeId, linkId){
        // si nada resaltado
        if(!nodeId && !linkId){
          // nodes normal
          nodeEls.forEach(g => {
            const rect = g.querySelector('rect');
            rect.setAttribute('opacity', '1');
            rect.setAttribute('stroke', 'rgba(11,16,32,.18)');
            rect.setAttribute('filter', 'url(#softShadow)');
          });
          // links normal
          linkEls.forEach(p => {
            p.setAttribute('opacity', '0.55');
            p.setAttribute('stroke', 'rgba(11,16,32,.40)');
            p.setAttribute('filter', 'none');
          });
          return;
        }

        // determinar links “activos”
        const activeLinks = new Set();
        if(linkId){
          activeLinks.add(linkId);
        }
        if(nodeId){
          d.links.forEach(l => {
            if(l.source === nodeId || l.target === nodeId) activeLinks.add(l.id);
          });
        }

        // nodes activos
        const activeNodes = new Set();
        if(nodeId) activeNodes.add(nodeId);
        activeLinks.forEach(lid => {
          const l = d.links.find(x => x.id === lid);
          if(l){
            activeNodes.add(l.source);
            activeNodes.add(l.target);
          }
        });

        // aplicar estilos
        nodeEls.forEach((g, id) => {
          const rect = g.querySelector('rect');
          if(activeNodes.has(id)){
            rect.setAttribute('opacity', '1');
            rect.setAttribute('stroke', 'rgba(45,160,220,.55)');
            rect.setAttribute('filter', 'url(#glow)');
          }else{
            rect.setAttribute('opacity', '0.22');
            rect.setAttribute('stroke', 'rgba(11,16,32,.10)');
            rect.setAttribute('filter', 'none');
          }
        });

        linkEls.forEach((p, id) => {
          if(activeLinks.has(id)){
            p.setAttribute('opacity', '0.92');
            p.setAttribute('stroke', 'rgba(45,160,220,.82)');
            p.setAttribute('filter', 'url(#glow)');
          }else{
            p.setAttribute('opacity', '0.10');
            p.setAttribute('stroke', 'rgba(11,16,32,.28)');
            p.setAttribute('filter', 'none');
          }
        });
      }

      // guardar función al scope del render
      window.__applyDim = applyDim;

      // inicial
      applyDim(null, null);
    }

    function resetFlow(){
      locked = false;
      lockKey = null;
      badgeFlow('ninguno');
      if(window.__applyDim) window.__applyDim(null, null);
      hideTip();
    }

    // Tabs diagrama
    document.getElementById('fTabCafe').addEventListener('click', () => {
      flowMode = 'cafe';
      document.getElementById('fTabCafe').classList.add('active');
      document.getElementById('fTabSimple').classList.remove('active');
      renderFlow('cafe');
    });
    document.getElementById('fTabSimple').addEventListener('click', () => {
      flowMode = 'simple';
      document.getElementById('fTabSimple').classList.add('active');
      document.getElementById('fTabCafe').classList.remove('active');
      renderFlow('simple');
    });
    document.getElementById('fReset').addEventListener('click', () => {
      renderFlow(flowMode);
      resetFlow();
    });

    // Render inicial
    window.addEventListener('load', () => renderFlow('cafe'));

    /* =========================================================
       B) MAPA MENTAL (Markmap)
       ========================================================= */
    const md = `
# 1.2 Cadenas alimenticias o tróficas
## Ideas clave
- Flujo de energía (direccional)
- Transformación y reciclaje de materia (C, N, P)
## Niveles tróficos
- Productores
  - Plantas, algas, fitoplancton
- Consumidor primario
  - Herbívoros
- Consumidor secundario / terciario
  - Carnívoros
- Depredador superior
  - Control poblacional
- Descomponedores y simbiontes
  - Hongos y bacterias
  - Mutualismos
## Procesos
- Fotosíntesis y respiración
- Mineralización
- Nitrificación
- Asimilación radicular
- Lixiviación y escorrentía
## Interpretación
- Efecto en cascada si baja un nivel
- Manejo del suelo influye en ciclos
    `.trim();

    let mm = null;
    let expanded = true;

    function safeRender(){
      const fallback = document.getElementById('mapFallback');
      try{
        if (!window.markmap || !window.markmap.Transformer || !window.markmap.Markmap) return false;
        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const { root } = transformer.transform(md);
        const svg = document.getElementById('mindmap');
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        mm = Markmap.create(svg, { autoFit: true, duration: 220 }, root);
        expanded = true;
        fallback.classList.remove('show');
        return true;
      }catch(e){
        fallback.classList.add('show');
        return true;
      }
    }

    let tries = 0;
    const timer = setInterval(() => {
      tries++;
      const done = safeRender();
      if (done || tries >= 12){
        clearInterval(timer);
        if (!mm) document.getElementById('mapFallback').classList.add('show');
      }
    }, 350);

    document.getElementById('btnFit').addEventListener('click', () => mm && mm.fit());
    document.getElementById('btnToggle').addEventListener('click', () => {
      if (!mm) return;
      if (expanded) mm.foldAll(); else mm.unfoldAll();
      expanded = !expanded;
    });
    document.getElementById('btnReset').addEventListener('click', () => safeRender());

    /* =========================================================
       C) SIMULADOR (más vistoso)
       ========================================================= */
    const kProd = document.getElementById('kProd');
    const kHerb = document.getElementById('kHerb');
    const kPred = document.getElementById('kPred');
    const kRecycle = document.getElementById('kRecycle');

    const vProd = document.getElementById('vProd');
    const vHerb = document.getElementById('vHerb');
    const vPred = document.getElementById('vPred');
    const vRec  = document.getElementById('vRec');

    const simScore = document.getElementById('simScore');
    const simFeedback = document.getElementById('simFeedback');

    const svP = document.getElementById('svP');
    const svH = document.getElementById('svH');
    const svD = document.getElementById('svD');
    const svN = document.getElementById('svN');
    const sbP = document.getElementById('sbP');
    const sbH = document.getElementById('sbH');
    const sbD = document.getElementById('sbD');
    const sbN = document.getElementById('sbN');

    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');

    function fmt(x){ return (Math.round(x*100)/100).toFixed(2); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function syncVals(){
      vProd.textContent = fmt(parseFloat(kProd.value));
      vHerb.textContent = fmt(parseFloat(kHerb.value));
      vPred.textContent = fmt(parseFloat(kPred.value));
      vRec.textContent  = fmt(parseFloat(kRecycle.value));
    }
    [kProd,kHerb,kPred,kRecycle].forEach(el => el.addEventListener('input', syncVals));
    syncVals();

    let running = false;
    let t = 0;

    const MAX_POINTS = 220;
    let seriesP = [];
    let seriesH = [];
    let seriesD = [];

    let P=0.70, H=0.42, D=0.26, N=0.55;

    function setStat(elV, elB, value){
      elV.textContent = fmt(value);
      const w = clamp((value/1.2)*100, 0, 100);
      elB.style.width = w.toFixed(1) + '%';
    }
    function refreshStats(){
      setStat(svP, sbP, P);
      setStat(svH, sbH, H);
      setStat(svD, sbD, D);
      setStat(svN, sbN, N);
    }

    function setScoreState(text, cls){
      simScore.textContent = text;
      simScore.classList.remove('ok','no');
      if(cls) simScore.classList.add(cls);
    }

    function resetSim(){
      running = false;
      t = 0;
      P=0.70; H=0.42; D=0.26; N=0.55;
      seriesP = [];
      seriesH = [];
      seriesD = [];
      for(let i=0;i<60;i++) stepSim(false);
      draw();
      refreshStats();
      setScoreState('Estado: detenido', null);
      simFeedback.className = 'result';
      simFeedback.textContent = 'Presiona Iniciar. Luego aplica un evento y ajusta controles para recuperar estabilidad.';
    }

    function shockDrought(){
      N = Math.max(0.02, N * 0.55);
      P = Math.max(0.02, P * 0.78);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: sequía. Bajó producción primaria y nutrientes. Ajusta parámetros para recuperar estabilidad.';
      draw(); refreshStats();
      setScoreState('Estado: inestable', 'no');
    }
    function shockPredLoss(){
      D = Math.max(0.01, D * 0.35);
      simFeedback.className = 'result no';
      simFeedback.textContent = 'Evento aplicado: pérdida de depredadores. Observa si suben herbívoros y cae vegetación.';
      draw(); refreshStats();
      setScoreState('Estado: inestable', 'no');
    }

    function stepSim(push=true){
      const kp = parseFloat(kProd.value);
      const kh = parseFloat(kHerb.value);
      const kd = parseFloat(kPred.value);
      const kr = parseFloat(kRecycle.value);

      const recycle = kr * (0.30*P + 0.22*H + 0.18*D);
      const uptake  = 0.55 * kp * P;
      N = clamp(N + recycle - uptake, 0.00, 1.20);

      const growP = kp * (0.55 + 0.75*N) * P * (1.05 - P);
      const eatP  = kh * (0.68) * H * P;
      P = clamp(P + growP - eatP, 0.00, 1.20);

      const growH = kh * (0.58) * H * P;
      const predH = kd * (0.70) * D * H;
      const starv = 0.18 * H * (0.45 - P);
      H = clamp(H + growH - predH - Math.max(0, starv), 0.00, 1.20);

      const growD = kd * (0.50) * D * H;
      const costD = 0.22 * D;
      D = clamp(D + growD - costD, 0.00, 1.20);

      if(push){
        seriesP.push(P);
        seriesH.push(H);
        seriesD.push(D);
        if(seriesP.length > MAX_POINTS){
          seriesP.shift(); seriesH.shift(); seriesD.shift();
        }
      }
      t++;
    }

    function assess(){
      const okP = P > 0.25 && P < 1.05;
      const okH = H > 0.12 && H < 0.95;
      const okD = D > 0.06 && D < 0.80;

      if(okP && okH && okD){
        setScoreState('Estado: estable', 'ok');
        simFeedback.className = 'result ok';
        simFeedback.textContent =
          'Estado estable. Productores sostienen herbívoros; depredadores controlan herbívoros; reciclaje mantiene nutrientes.';
      }else{
        setScoreState('Estado: inestable', 'no');
        simFeedback.className = 'result no';
        let msg = 'Estado inestable. ';
        if(P <= 0.08) msg += 'Productores casi colapsan. ';
        if(H >= 1.05) msg += 'Herbívoros demasiado altos. ';
        if(D <= 0.03) msg += 'Depredadores casi ausentes. ';
        if(D >= 0.95) msg += 'Depredadores demasiado altos. ';
        msg += 'Ajusta parámetros y observa la gráfica.';
        simFeedback.textContent = msg;
      }
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const bg = ctx.createLinearGradient(0,0,0,h);
      bg.addColorStop(0, 'rgba(255,255,255,.70)');
      bg.addColorStop(1, 'rgba(255,255,255,.50)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      const padL = 42, padR = 14, padT = 14, padB = 28;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      ctx.strokeStyle = 'rgba(11,16,32,.18)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + plotH);
      ctx.lineTo(padL + plotW, padT + plotH);
      ctx.stroke();

      ctx.fillStyle = 'rgba(11,16,32,.68)';
      ctx.font = '12px Inter, system-ui';
      for(let i=0;i<=6;i++){
        const v = (1.2/6)*i;
        const y = padT + plotH - (v/1.2)*plotH;
        ctx.strokeStyle = 'rgba(11,16,32,.10)';
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
        ctx.fillText(v.toFixed(1), 8, y+4);
      }

      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '13px Outfit, Inter, system-ui';
      ctx.fillText('Productores', padL + 6, padT + 14);
      ctx.fillText('Herbívoros',  padL + 150, padT + 14);
      ctx.fillText('Depredadores',padL + 278, padT + 14);

      const colP = 'rgba(50,170,120,.90)';
      const colH = 'rgba(210,150,80,.90)';
      const colD = 'rgba(120,120,120,.95)';

      function plotWithFill(series, color){
        if(series.length < 2) return;

        ctx.beginPath();
        for(let i=0;i<series.length;i++){
          const x = padL + (i/(MAX_POINTS-1))*plotW;
          const y = padT + plotH - (series[i]/1.2)*plotH;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.lineTo(padL + plotW, padT + plotH);
        ctx.lineTo(padL, padT + plotH);
        ctx.closePath();

        const g = ctx.createLinearGradient(0,padT,0,padT+plotH);
        // degradado suave (más vistoso)
        g.addColorStop(0, color.replace('0.90','0.18').replace('0.95','0.16'));
        g.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = g;
        ctx.fill();

        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for(let i=0;i<series.length;i++){
          const x = padL + (i/(MAX_POINTS-1))*plotW;
          const y = padT + plotH - (series[i]/1.2)*plotH;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }

      plotWithFill(seriesP, colP);
      plotWithFill(seriesH, colH);
      plotWithFill(seriesD, colD);

      ctx.fillStyle = 'rgba(11,16,32,.86)';
      ctx.font = '12px Inter, system-ui';
      ctx.fillText('P=' + fmt(P) + '   H=' + fmt(H) + '   D=' + fmt(D) + '   N=' + fmt(N), padL, padT + plotH + 20);
    }

    function tick(){
      if(!running) return;
      stepSim(true);
      draw();
      refreshStats();
      if(t % 18 === 0) assess();
      requestAnimationFrame(tick);
    }

    document.getElementById('btnStart').addEventListener('click', () => {
      if(!running){
        running = true;
        setScoreState('Estado: ejecutando', null);
        requestAnimationFrame(tick);
      }
    });
    document.getElementById('btnPause').addEventListener('click', () => {
      running = false;
      setScoreState('Estado: pausado', null);
    });
    document.getElementById('btnShock1').addEventListener('click', shockDrought);
    document.getElementById('btnShock2').addEventListener('click', shockPredLoss);
    document.getElementById('btnSimReset').addEventListener('click', resetSim);

    resetSim();
  </script>
</body>
</html>
